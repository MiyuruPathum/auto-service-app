<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Workshop Pro | Management Suite</title>
    <link rel="icon" type="image/x-icon" href="../../build/icon.ico">
    <!-- Local libraries for offline support -->
    <script src="./lib/tailwind.min.js"></script>
    <script src="./lib/react.development.js"></script>
    <script src="./lib/react-dom.development.js"></script>
    <script src="./lib/babel.min.js"></script>
    <style>
        /* Font with fallback for offline - Inter will load if online, system fonts as fallback */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        * { scrollbar-width: thin; scrollbar-color: #3f46e1 #0f172a; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #3f46e1; border-radius: 4px; }
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif; background: #0f172a; color: #e2e8f0; }
        input:invalid { border-color: #ef4444; }
        
        /* Print styles */
        @media print {
            /* Hide everything by default */
            body * {
                visibility: hidden;
            }
            /* Show only the printable area */
            .print-area, .print-area * {
                visibility: visible;
            }
            /* Position print area at top left */
            .print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                background: white !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            /* Hide no-print elements */
            .no-print {
                display: none !important;
            }
            /* Reset background for print */
            body {
                background: white !important;
            }
        }
        
        /* Screen-only print preview styles */
        @media screen {
            .print-area {
                /* Visible on screen - serves as preview */
                display: block;
            }
        }
        
        .glass-dark { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(10px); border: 1px solid rgba(51, 65, 85, 0.5); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        
        // Detect if running in Electron or browser
        const isElectron = typeof require !== 'undefined' && typeof require('electron') !== 'undefined';
        let ipcRenderer = null;
        let logoPath = '../../build/logo.png'; // Default for development
        if (isElectron) {
            try { 
                ipcRenderer = require('electron').ipcRenderer;
                // In packaged app, use the extraResources path
                const { app } = require('@electron/remote') || {};
                const path = require('path');
                const fs = require('fs');
                // Check if we're in a packaged app
                const possiblePaths = [
                    path.join(process.resourcesPath || '', 'logo.png'),
                    path.join(__dirname, '..', '..', 'build', 'logo.png'),
                    '../../build/logo.png'
                ];
                for (const p of possiblePaths) {
                    try {
                        if (fs.existsSync(p)) {
                            logoPath = p;
                            break;
                        }
                    } catch(e) {}
                }
            } catch(e) { /* browser */ }
        }

        // Fix for Electron focus issues - reset any stuck focus states
        if (isElectron) {
            document.addEventListener('click', (e) => {
                // Ensure click events propagate properly
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                    e.target.focus();
                }
            }, true);
            
            // Handle visibility change to reset focus
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden) {
                    // Small delay to ensure window is fully focused
                    setTimeout(() => {
                        const activeEl = document.activeElement;
                        if (activeEl && (activeEl.tagName === 'INPUT' || activeEl.tagName === 'TEXTAREA')) {
                            activeEl.blur();
                            activeEl.focus();
                        }
                    }, 100);
                }
            });
        }

        // ===== SRI LANKAN LOCALIZATION & HELPERS =====
        const SL_CONFIG = {
            VAT_RATE: 0.08,
            CURRENCY: 'LKR',
            CURRENCY_SYMBOL: '‡∂ª‡∑î.',
            DATE_FORMAT: 'DD/MM/YYYY'
        };

        const formatLKR = (amount) => {
            if (!amount && amount !== 0) return '‡∂ª‡∑î. 0.00';
            const num = parseFloat(amount).toFixed(2);
            return '‡∂ª‡∑î. ' + num.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        };

        const formatDateSL = (dateString) => {
            if (!dateString) return '-';
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        };

        const isValidSLPhone = (phone) => {
            const cleaned = phone.replace(/\D/g, '');
            return /^0[1-9]\d{8}$/.test(cleaned);
        };

        const isValidSLPlate = (plate) => {
            const cleaned = plate.toUpperCase().trim();
            const format1 = /^[A-Z]{3}[-\s]?[0-9]{4}$/.test(cleaned);
            const format2 = /^[A-Z]{2}[-\s]?[0-9]{4}$/.test(cleaned);
            const format3 = /^[0-9]{2,4}[-\s]?[0-9]{4}$/.test(cleaned);
            return format1 || format2 || format3;
        };

        // Universal DB call - works in Electron (IPC) or Browser (fetch API)
        const callDB = async (type, payload) => {
            if (ipcRenderer) {
                // Electron environment - use IPC
                const res = await ipcRenderer.invoke(type, payload);
                if (!res.success && res.error !== 'Cancelled') console.error(`Database Error (${type}):`, res.error);
                return res;
            } else {
                // Browser environment - use fetch API
                try {
                    const res = await fetch('/api/db', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ type, payload })
                    });
                    const data = await res.json();
                    if (!data.success && data.error !== 'Cancelled') console.error(`API Error (${type}):`, data.error);
                    return data;
                } catch (err) {
                    console.error(`Fetch Error (${type}):`, err);
                    return { success: false, error: err.message };
                }
            }
        };

        // Toast notification system
        const useToast = () => {
            const [toasts, setToasts] = useState([]);
            
            const showToast = (message, type = 'info') => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, message, type }]);
                setTimeout(() => {
                    setToasts(prev => prev.filter(t => t.id !== id));
                }, 4000);
            };
            
            const ToastContainer = () => (
                <div className="fixed bottom-4 right-4 space-y-2 z-50">
                    {toasts.map(toast => (
                        <div key={toast.id} className={`px-4 py-3 rounded-lg shadow-xl text-sm font-medium animate-in slide-in-from-right duration-300 ${
                            toast.type === 'success' ? 'bg-emerald-600 text-white' :
                            toast.type === 'error' ? 'bg-red-600 text-white' :
                            toast.type === 'warning' ? 'bg-yellow-600 text-white' :
                            'bg-indigo-600 text-white'
                        }`}>
                            {toast.type === 'success' && '‚úì '}
                            {toast.type === 'error' && '‚úï '}
                            {toast.type === 'warning' && '‚ö† '}
                            {toast.message}
                        </div>
                    ))}
                </div>
            );
            
            return { showToast, ToastContainer };
        };

        // UI COMPONENT: Input Field
        const Input = ({ label, name, type="text", required=false, pattern, placeholder, defaultValue, min, step, max, className="" }) => (
            <div className="flex flex-col mb-4">
                <label className="text-xs font-semibold text-slate-400 uppercase tracking-wide mb-2">{label}</label>
                <input 
                    name={name}
                    type={type} 
                    required={required} 
                    pattern={pattern}
                    placeholder={placeholder}
                    defaultValue={defaultValue}
                    min={min}
                    max={max}
                    step={step}
                    className={`px-4 py-3 bg-slate-900/50 border border-slate-700/50 rounded-lg outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition-all text-sm text-slate-200 placeholder-slate-500 ${className}`}
                />
            </div>
        );

        // UI COMPONENT: Navigation Button
        const NavButton = ({ icon, label, active, onClick }) => (
            <button 
                onClick={onClick}
                className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg font-medium text-sm transition-all ${
                    active 
                        ? 'bg-indigo-600/30 text-indigo-300 border border-indigo-500/50 shadow-lg shadow-indigo-500/5' 
                        : 'text-slate-400 hover:bg-slate-800/50 hover:text-slate-300'
                }`}
            >
                <span className="text-lg">{icon}</span>
                <span>{label}</span>
            </button>
        );

        // MAIN APP
        const App = () => {
            const [view, setView] = useState('dashboard');
            const [selectedJob, setSelectedJob] = useState(null);
            const [techUser, setTechUser] = useState(null);
            const [appError, setAppError] = useState(null);
            const [businessName, setBusinessName] = useState('');
            const { showToast, ToastContainer } = useToast();

            // Load business name from settings
            useEffect(() => {
                try {
                    const saved = localStorage.getItem('workshopSettings');
                    if (saved) {
                        const settings = JSON.parse(saved);
                        if (settings.shopName) setBusinessName(settings.shopName);
                    }
                } catch (e) {}
            }, [view]); // Re-check when view changes (in case settings were updated)

            const showError = (title, message) => {
                setAppError({ title, message });
            };

            if (view === 'tech-login') return <TechLogin onLogin={(u) => { setTechUser(u); setView('tech-dash'); }} />;
            if (view === 'tech-dash') return <TechDash user={techUser} onLogout={() => { setTechUser(null); setView('dashboard'); }} />;

            return (
                <>
                    <ToastContainer />
                    {appError && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50 animate-in fade-in duration-200">
                            <div className="glass-dark rounded-2xl shadow-2xl max-w-md w-full p-8 border-t-2 border-red-500/50">
                                <h2 className="text-lg font-bold text-red-400 mb-3 flex items-center"><span className="mr-2">‚ö†</span>{appError.title}</h2>
                                <p className="text-slate-400 text-sm mb-6">{appError.message}</p>
                                <button onClick={() => setAppError(null)} className="w-full bg-red-600/20 hover:bg-red-600/30 text-red-400 px-4 py-2 rounded-lg font-semibold text-sm border border-red-500/30 transition-colors">Dismiss</button>
                            </div>
                        </div>
                    )}
                    <div className="flex h-screen overflow-hidden bg-slate-950">
                        {/* Sidebar */}
                        <aside className="w-64 bg-slate-900/80 border-r border-slate-800/50 flex flex-col p-4 no-print backdrop-blur-sm">
                            <div className="px-4 py-3 text-white font-bold mb-6 text-sm tracking-wide flex items-center gap-3">
                                <img src={logoPath} alt="Workshop Pro" className="w-10 h-10 object-contain" />
                                <div>
                                    <div>WORKSHOP PRO</div>
                                    {businessName && <div className="text-xs font-normal text-indigo-400 mt-0.5">{businessName}</div>}
                                </div>
                            </div>
                            <nav className="flex-1 space-y-1">
                                <NavButton icon="üìä" label="Dashboard" active={view === 'dashboard'} onClick={() => setView('dashboard')} />
                                <NavButton icon="‚úÖ" label="Completed" active={view === 'completed'} onClick={() => setView('completed')} />
                                <NavButton icon="üîç" label="Vehicle Search" active={view === 'vehicle-search'} onClick={() => setView('vehicle-search')} />
                                <NavButton icon="üì¶" label="Inventory" active={view === 'inventory'} onClick={() => setView('inventory')} />
                                <NavButton icon="üìà" label="Reports" active={view === 'reports'} onClick={() => setView('reports')} />
                                <NavButton icon="‚öôÔ∏è" label="Settings" active={view === 'settings'} onClick={() => setView('settings')} />
                            </nav>
                            <div className="pt-4 border-t border-slate-800/50 space-y-2">
                                <button onClick={() => setView('tech-login')} className="w-full px-4 py-2 bg-indigo-600/20 hover:bg-indigo-600/30 text-indigo-400 rounded-lg font-semibold text-xs uppercase tracking-wide border border-indigo-500/30 transition-colors">
                                    üîê Tech Mode
                                </button>
                            </div>
                        </aside>

                        {/* Main Content */}
                        <main className="flex-1 overflow-y-auto p-8 bg-gradient-to-br from-slate-950 via-slate-900/50 to-slate-950">
                            {view === 'dashboard' && <Dashboard onOpenJob={(id) => { setSelectedJob(id); setView('job-detail'); }} showToast={showToast} />}
                            {view === 'job-detail' && <JobDetail jobId={selectedJob} onBack={() => setView('dashboard')} onError={showError} showToast={showToast} />}
                            {view === 'completed' && <CompletedJobs onOpenJob={(id) => { setSelectedJob(id); setView('job-detail'); }} />}
                            {view === 'vehicle-search' && <VehicleSearch onOpenJob={(id) => { setSelectedJob(id); setView('job-detail'); }} />}
                            {view === 'inventory' && <Inventory onError={showError} showToast={showToast} />}
                            {view === 'reports' && <Reports onError={showError} showToast={showToast} />}
                            {view === 'settings' && <Settings showToast={showToast} />}
                        </main>
                    </div>
                </>
            );
        };

        // DASHBOARD - Active Jobs Overview
        const Dashboard = ({ onOpenJob, showToast }) => {
            const [jobs, setJobs] = useState([]);
            const [showIntake, setShowIntake] = useState(false);
            const [showAssignModal, setShowAssignModal] = useState(false);
            const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
            const [showEditModal, setShowEditModal] = useState(false);
            const [selectedJobId, setSelectedJobId] = useState(null);
            const [editingJob, setEditingJob] = useState(null);
            const [technicians, setTechnicians] = useState([]);
            const [lowStockItems, setLowStockItems] = useState([]);

            const loadJobs = async () => {
                const res = await callDB('db-query', { 
                    sql: "SELECT j.*, v.license_plate, v.make_model FROM jobs j JOIN vehicles v ON j.vehicle_id = v.vehicle_id WHERE j.status != 'completed' ORDER BY j.created_at DESC" 
                });
                if (res.success) setJobs(res.data);
            };

            const loadTechs = async () => {
                const res = await callDB('db-query', { 
                    sql: "SELECT user_id, full_name FROM users WHERE role = 'technician' ORDER BY full_name" 
                });
                if (res.success) setTechnicians(res.data);
            };

            const loadLowStock = async () => {
                const res = await callDB('db-query', { 
                    sql: "SELECT part_name, total_quantity, min_threshold FROM inventory WHERE total_quantity <= min_threshold ORDER BY total_quantity ASC LIMIT 5" 
                });
                if (res.success) setLowStockItems(res.data);
            };

            const deleteJob = async (jobId) => {
                // Delete related records first, then the job
                await callDB('db-run', { sql: "DELETE FROM job_tasks WHERE job_id = ?", params: [jobId] });
                await callDB('db-run', { sql: "DELETE FROM job_parts WHERE job_id = ?", params: [jobId] });
                await callDB('db-run', { sql: "DELETE FROM labor_charges WHERE job_id = ?", params: [jobId] });
                const res = await callDB('db-run', { sql: "DELETE FROM jobs WHERE job_id = ?", params: [jobId] });
                if (res.success) {
                    showToast && showToast('Job deleted successfully', 'success');
                    setShowDeleteConfirm(false);
                    setSelectedJobId(null);
                    loadJobs();
                } else {
                    showToast && showToast('Failed to delete job: ' + res.error, 'error');
                }
            };

            const openEditModal = async (jobId) => {
                const res = await callDB('db-query', { 
                    sql: `SELECT j.*, v.license_plate, v.make_model, 
                          COALESCE(j.owner_name, 
                            (SELECT oh.old_owner FROM ownership_history oh 
                             WHERE oh.vehicle_id = j.vehicle_id AND oh.transfer_date > j.created_at 
                             ORDER BY oh.transfer_date ASC LIMIT 1),
                            v.current_owner) as current_owner, 
                          COALESCE(j.owner_phone, v.contact_number) as contact_number 
                          FROM jobs j JOIN vehicles v ON j.vehicle_id = v.vehicle_id WHERE j.job_id = ?`,
                    params: [jobId]
                });
                if (res.success && res.data.length > 0) {
                    setEditingJob(res.data[0]);
                    setShowEditModal(true);
                }
            };

            const saveJobEdit = async (updates) => {
                const res = await callDB('db-run', {
                    sql: "UPDATE jobs SET status = ?, mileage_in = ?, technician_id = ? WHERE job_id = ?",
                    params: [updates.status, updates.mileage_in, updates.technician_id || null, editingJob.job_id]
                });
                if (res.success) {
                    showToast && showToast('Job updated successfully', 'success');
                    setShowEditModal(false);
                    setEditingJob(null);
                    loadJobs();
                } else {
                    showToast && showToast('Failed to update job: ' + res.error, 'error');
                }
            };

            // Keyboard shortcuts
            useEffect(() => {
                const handleKeyDown = (e) => {
                    if (e.ctrlKey && e.key === 'n') {
                        e.preventDefault();
                        setShowIntake(true);
                    }
                    if (e.key === 'Escape') {
                        setShowIntake(false);
                        setShowAssignModal(false);
                        setShowDeleteConfirm(false);
                        setShowEditModal(false);
                    }
                };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, []);

            // Check if job is overdue (pending > 3 days)
            const isOverdue = (job) => {
                if (job.status !== 'pending') return false;
                const created = new Date(job.created_at);
                const now = new Date();
                const daysDiff = (now - created) / (1000 * 60 * 60 * 24);
                return daysDiff > 3;
            };

            const assignJob = async (jobId, techId) => {
                const res = await callDB('db-run', { 
                    sql: "UPDATE jobs SET technician_id = ? WHERE job_id = ?", 
                    params: [techId, jobId] 
                });
                if (res.success) { 
                    setShowAssignModal(false); 
                    setSelectedJobId(null);
                    loadJobs(); 
                }
            };

            useEffect(() => { loadJobs(); loadTechs(); loadLowStock(); }, []);

            const statuses = {
                pending: { color: 'bg-slate-700/30 text-slate-300 border-slate-600/50', label: 'Pending' },
                'in-progress': { color: 'bg-indigo-700/30 text-indigo-300 border-indigo-600/50', label: 'In Progress' },
                waiting: { color: 'bg-yellow-700/30 text-yellow-300 border-yellow-600/50', label: 'Waiting' }
            };

            return (
                <div className="animate-in fade-in duration-500 space-y-6">
                    {/* Low Stock Alert */}
                    {lowStockItems.length > 0 && (
                        <div className="glass-dark rounded-xl p-4 border border-red-500/30 bg-red-900/10">
                            <div className="flex items-center gap-3 mb-3">
                                <span className="text-red-400 text-lg">‚ö†</span>
                                <h3 className="text-red-400 font-semibold text-sm">Low Stock Alert</h3>
                            </div>
                            <div className="flex flex-wrap gap-2">
                                {lowStockItems.map((item, i) => (
                                    <span key={i} className="bg-red-600/20 text-red-300 px-3 py-1 rounded-lg text-xs font-medium border border-red-500/30">
                                        {item.part_name}: {item.total_quantity} left
                                    </span>
                                ))}
                            </div>
                        </div>
                    )}

                    <div className="flex justify-between items-start">
                        <div>
                            <h1 className="text-3xl font-bold text-white tracking-tight">Active Jobs</h1>
                            <p className="text-slate-400 text-sm mt-1">Manage workshop floor operations <span className="text-slate-500 text-xs ml-2">(Ctrl+N: New Intake, Esc: Close)</span></p>
                        </div>
                        <button onClick={() => setShowIntake(true)} className="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg font-semibold text-sm shadow-lg shadow-indigo-500/20 transition-all active:scale-95">
                            + New Intake
                        </button>
                    </div>

                    {jobs.length === 0 ? (
                        <div className="glass-dark rounded-xl p-16 text-center border border-slate-700/50">
                            <p className="text-slate-400 font-medium">No active jobs. Start with Vehicle Intake.</p>
                        </div>
                    ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            {jobs.map(job => (
                                <div key={job.job_id} className={`glass-dark p-6 rounded-xl border transition-all group ${isOverdue(job) ? 'border-red-500/50 bg-red-900/10' : 'border-slate-700/50 hover:border-indigo-500/50 hover:bg-indigo-600/5'}`}>
                                    <div className="flex justify-between items-start mb-4">
                                        {isOverdue(job) && <span className="text-xs font-semibold px-3 py-1 rounded-full border bg-red-700/30 text-red-300 border-red-600/50 mr-2">‚è∞ Overdue</span>}
                                        <span className={`text-xs font-semibold px-3 py-1 rounded-full border ${statuses[job.status]?.color || 'bg-slate-700/30 text-slate-300 border-slate-600/50'}`}>
                                            {statuses[job.status]?.label || job.status}
                                        </span>
                                        <div className="flex gap-1">
                                            <button 
                                                onClick={() => openEditModal(job.job_id)}
                                                className="text-slate-400 hover:text-indigo-400 p-1 transition-colors"
                                                title="Edit Job"
                                            >‚úèÔ∏è</button>
                                            <button 
                                                onClick={() => { setSelectedJobId(job.job_id); setShowDeleteConfirm(true); }}
                                                className="text-slate-400 hover:text-red-400 p-1 transition-colors"
                                                title="Delete Job"
                                            >üóëÔ∏è</button>
                                        </div>
                                    </div>
                                    <button onClick={() => onOpenJob(job.job_id)} className="w-full text-left hover:text-indigo-400 transition-colors">
                                        <h2 className="text-xl font-bold text-white mb-1 group-hover:text-indigo-400 transition-colors">{job.license_plate}</h2>
                                        <p className="text-slate-400 text-sm mb-1">{job.make_model}</p>
                                        <p className="text-xs text-slate-500 font-mono mb-3">Job #{job.job_id}</p>
                                    </button>
                                    <div className="flex justify-between items-center text-xs pt-4 border-t border-slate-700/50">
                                        <span className="text-slate-500">{new Date(job.created_at).toLocaleDateString()}</span>
                                        <button 
                                            onClick={() => { setSelectedJobId(job.job_id); setShowAssignModal(true); }}
                                            className="bg-yellow-600/30 hover:bg-yellow-600/50 text-yellow-300 px-3 py-1 rounded-lg font-semibold text-xs uppercase transition-colors"
                                        >
                                            {job.technician_id ? 'üë§ Reassign' : '‚ûï Assign'}
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}

                    {/* Assignment Modal */}
                    {showAssignModal && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50 animate-in fade-in duration-200">
                            <div className="glass-dark rounded-2xl shadow-2xl max-w-md w-full p-8 border border-slate-700/50 animate-in scale-95 zoom-in-50">
                                <h3 className="text-lg font-bold text-white mb-6">Assign Technician to Job #{selectedJobId}</h3>
                                <div className="space-y-2 mb-6 max-h-64 overflow-y-auto">
                                    {technicians.map(t => (
                                        <button 
                                            key={t.user_id} 
                                            onClick={() => assignJob(selectedJobId, t.user_id)} 
                                            className="w-full text-left bg-slate-900/50 hover:bg-indigo-600/30 border border-slate-700/30 hover:border-indigo-500/50 p-4 rounded-lg text-slate-200 hover:text-indigo-300 transition-all font-semibold"
                                        >
                                            üë§ {t.full_name}
                                        </button>
                                    ))}
                                </div>
                                <button onClick={() => { setShowAssignModal(false); setSelectedJobId(null); }} className="w-full py-3 bg-slate-800/50 hover:bg-slate-700/50 text-slate-300 rounded-lg font-semibold text-sm transition-colors">Cancel</button>
                            </div>
                        </div>
                    )}

                    {/* Delete Confirmation Modal */}
                    {showDeleteConfirm && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50 animate-in fade-in duration-200">
                            <div className="glass-dark rounded-2xl shadow-2xl max-w-md w-full p-8 border border-red-500/30 animate-in scale-95 zoom-in-50">
                                <h3 className="text-lg font-bold text-red-400 mb-4 flex items-center gap-2">
                                    <span>‚ö†Ô∏è</span> Delete Job #{selectedJobId}?
                                </h3>
                                <p className="text-slate-400 text-sm mb-6">
                                    This will permanently delete this job and all associated tasks, parts, and labor charges. This action cannot be undone.
                                </p>
                                <div className="flex gap-3">
                                    <button 
                                        onClick={() => { setShowDeleteConfirm(false); setSelectedJobId(null); }} 
                                        className="flex-1 py-3 bg-slate-800/50 hover:bg-slate-700/50 text-slate-300 rounded-lg font-semibold text-sm transition-colors"
                                    >
                                        Cancel
                                    </button>
                                    <button 
                                        onClick={() => deleteJob(selectedJobId)} 
                                        className="flex-1 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg font-semibold text-sm transition-colors"
                                    >
                                        üóëÔ∏è Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Edit Job Modal */}
                    {showEditModal && editingJob && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50 animate-in fade-in duration-200">
                            <div className="glass-dark rounded-2xl shadow-2xl max-w-lg w-full p-8 border border-slate-700/50 animate-in scale-95 zoom-in-50">
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="text-lg font-bold text-white">Edit Job #{editingJob.job_id}</h3>
                                    <button onClick={() => { setShowEditModal(false); setEditingJob(null); }} className="text-slate-400 hover:text-slate-200 text-xl">‚úï</button>
                                </div>
                                
                                <div className="space-y-4">
                                    <div className="bg-slate-800/30 p-4 rounded-lg border border-slate-700/30">
                                        <p className="text-white font-semibold">{editingJob.license_plate}</p>
                                        <p className="text-slate-400 text-sm">{editingJob.make_model}</p>
                                        <p className="text-slate-500 text-xs mt-1">Owner: {editingJob.current_owner}</p>
                                    </div>

                                    <div>
                                        <label className="text-xs font-semibold text-slate-400 uppercase tracking-wide mb-2 block">Status</label>
                                        <select 
                                            defaultValue={editingJob.status}
                                            id="edit-status"
                                            className="w-full px-4 py-3 bg-slate-900/50 border border-slate-700/50 rounded-lg outline-none focus:border-indigo-500 text-sm text-slate-200"
                                        >
                                            <option value="pending">Pending</option>
                                            <option value="in-progress">In Progress</option>
                                            <option value="waiting">Waiting for Parts</option>
                                            <option value="completed">Completed</option>
                                        </select>
                                    </div>

                                    <div>
                                        <label className="text-xs font-semibold text-slate-400 uppercase tracking-wide mb-2 block">Arrival Mileage</label>
                                        <input 
                                            type="number"
                                            defaultValue={editingJob.mileage_in}
                                            id="edit-mileage"
                                            className="w-full px-4 py-3 bg-slate-900/50 border border-slate-700/50 rounded-lg outline-none focus:border-indigo-500 text-sm text-slate-200 [&::-webkit-outer-spin-button]:hidden [&::-webkit-inner-spin-button]:hidden"
                                        />
                                    </div>

                                    <div>
                                        <label className="text-xs font-semibold text-slate-400 uppercase tracking-wide mb-2 block">Assigned Technician</label>
                                        <select 
                                            defaultValue={editingJob.technician_id || ''}
                                            id="edit-technician"
                                            className="w-full px-4 py-3 bg-slate-900/50 border border-slate-700/50 rounded-lg outline-none focus:border-indigo-500 text-sm text-slate-200"
                                        >
                                            <option value="">‚Äî No Assignment ‚Äî</option>
                                            {technicians.map(t => <option key={t.user_id} value={t.user_id}>{t.full_name}</option>)}
                                        </select>
                                    </div>
                                </div>

                                <div className="flex gap-3 mt-8">
                                    <button 
                                        onClick={() => { setShowEditModal(false); setEditingJob(null); }} 
                                        className="flex-1 py-3 bg-slate-800/50 hover:bg-slate-700/50 text-slate-300 rounded-lg font-semibold text-sm transition-colors"
                                    >
                                        Cancel
                                    </button>
                                    <button 
                                        onClick={() => {
                                            const status = document.getElementById('edit-status').value;
                                            const mileage = document.getElementById('edit-mileage').value;
                                            const tech = document.getElementById('edit-technician').value;
                                            saveJobEdit({ status, mileage_in: parseInt(mileage) || 0, technician_id: tech || null });
                                        }}
                                        className="flex-1 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-semibold text-sm transition-colors"
                                    >
                                        üíæ Save Changes
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showIntake && <IntakeModal onClose={() => setShowIntake(false)} onSaved={loadJobs} />}
                </div>
            );
        };

        // VEHICLE INTAKE MODAL
        const IntakeModal = ({ onClose, onSaved }) => {
            const [photoPath, setPhotoPath] = useState(null);
            const [technicians, setTechnicians] = useState([]);
            const [showModelDropdown, setShowModelDropdown] = useState(false);
            const [partSuggestions, setPartSuggestions] = useState([]);
            const [modelFilter, setModelFilter] = useState('');
            const [plateValue, setPlateValue] = useState('');
            const [existingVehicle, setExistingVehicle] = useState(null);
            const [formData, setFormData] = useState({ owner: '', phone: '', vin: '', model: '', year: '', mileage: '' });
            const fileInput = useRef();
            const modalRef = useRef();
            const modelDropdownRef = useRef();

            // Load smart lists from localStorage or use defaults
            const getSmartList = (listName, defaultList) => {
                try {
                    const saved = localStorage.getItem('workshopSmartLists');
                    if (saved) {
                        const lists = JSON.parse(saved);
                        if (lists[listName]) return lists[listName];
                    }
                } catch (e) {}
                return defaultList;
            };

            const peugeotModels = getSmartList('peugeotModels', [
                '106', '107', '108', '206', '207', '208', '306', '307', '308',
                '405', '406', '407', '505', '508', '605', '607', '806', '807',
                '2008', '3008', '4008', '5008', 'RCZ', 'Traveller'
            ]);

            // Filter models - match any portion of the model name
            const filteredModels = modelFilter.length > 0 
                ? peugeotModels.filter(m => m.toLowerCase().includes(modelFilter.toLowerCase()))
                : peugeotModels;

            // Get parts list from localStorage
            const defaultPartsList = getSmartList('partNames', [
                'Spark Plugs', 'Engine Oil', 'Oil Filter', 'Air Filter', 'Cabin Air Filter',
                'Transmission Fluid', 'Coolant', 'Brake Fluid', 'Power Steering Fluid',
                'Battery', 'Alternator', 'Starter Motor', 'Water Pump',
                'Brake Pads', 'Brake Rotors', 'Brake Shoes', 'Brake Calipers',
                'Shock Absorbers', 'Struts', 'Suspension Coils', 'Ball Joints', 'Control Arm',
                'Clutch Kit', 'Flywheel', 'CV Joint', 'Axle Shaft',
                'Serpentine Belt', 'Timing Belt', 'Radiator Hose', 'Heater Hose',
                'Headlights', 'Tail Lights', 'Brake Lights', 'Fog Lights', 'Interior Lights',
                'Wiper Blades', 'Windshield Wipers',
                'Fuel Filter', 'Fuel Pump', 'Fuel Injectors',
                'Muffler', 'Catalytic Converter', 'Exhaust Pipe',
                'Power Steering Pump', 'Steering Rack', 'Tie Rod',
                'Gasket Set', 'Valve Cover Gasket', 'Oil Pan Gasket',
                'Spark Plug Wires', 'Ignition Coils', 'Distributor Cap',
                'Thermostat', 'Radiator', 'Engine Mount',
                'Door Lock Actuator', 'Window Motor', 'Mirror Motor',
                'Seat Belt', 'Door Handle', 'Window Regulator'
            ]);

            useEffect(() => {
                const loadData = async () => {
                    const res = await callDB('db-query', { sql: "SELECT user_id, full_name FROM users WHERE role = 'technician'" });
                    if (res.success) setTechnicians(res.data);
                    
                    // Load parts suggestions from database
                    const partsRes = await callDB('db-query', { 
                        sql: "SELECT DISTINCT part_name FROM inventory WHERE part_name IS NOT NULL ORDER BY part_name" 
                    });
                    const dbParts = partsRes.success ? partsRes.data.map(p => p.part_name) : [];
                    setPartSuggestions([...new Set([...defaultPartsList, ...dbParts])].sort());
                };
                loadData();

                // Click outside handler to close dropdowns
                const handleClickOutside = (e) => {
                    if (modelDropdownRef.current && !modelDropdownRef.current.contains(e.target)) {
                        setShowModelDropdown(false);
                    }
                };
                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, []);

            // License plate lookup - auto-fill if vehicle exists
            const handlePlateChange = async (value) => {
                let upperPlate = value.toUpperCase();
                
                // Auto-add "-" after 3 letters or 3 numbers (not for 2-char prefixes)
                // Only add if user hasn't already added a dash
                if (!upperPlate.includes('-')) {
                    // Match 3 capital letters at start (e.g., ABC -> ABC-)
                    if (/^[A-Z]{3}$/.test(upperPlate)) {
                        upperPlate = upperPlate + '-';
                    }
                    // Match 3 numbers at start (e.g., 300 -> 300-)
                    else if (/^[0-9]{3}$/.test(upperPlate)) {
                        upperPlate = upperPlate + '-';
                    }
                }
                
                setPlateValue(upperPlate);
                
                if (upperPlate.length >= 4) {
                    const res = await callDB('db-query', {
                        sql: "SELECT * FROM vehicles WHERE license_plate = ?",
                        params: [upperPlate]
                    });
                    if (res.success && res.data.length > 0) {
                        const v = res.data[0];
                        setExistingVehicle(v);
                        
                        // Get last recorded mileage for this vehicle
                        const lastMileage = await callDB('db-query', {
                            sql: "SELECT COALESCE(mileage_in, 0) as last_mileage FROM jobs WHERE vehicle_id = ? ORDER BY created_at DESC LIMIT 1",
                            params: [v.vehicle_id]
                        });
                        const mileageValue = (lastMileage.success && lastMileage.data.length > 0) 
                            ? String(lastMileage.data[0].last_mileage) 
                            : '';
                        
                        // Parse model and year from make_model like "Peugeot 308 (2020)"
                        const match = v.make_model?.match(/^(.+?)\s*\((\d{4})\)$/);
                        const modelValue = match ? match[1] : (v.make_model || '');
                        // For filtering, strip "Peugeot " prefix
                        const filterValue = modelValue.replace(/^peugeot\s*/i, '');
                        setFormData({
                            owner: v.current_owner || '',
                            phone: v.contact_number || '',
                            vin: v.vin || '',
                            model: modelValue,
                            year: match ? match[2] : '',
                            mileage: mileageValue
                        });
                        setModelFilter(filterValue);
                    } else {
                        setExistingVehicle(null);
                    }
                } else {
                    setExistingVehicle(null);
                }
            };
            
            const handleModelInput = (value) => {
                // Strip "Peugeot " prefix for filtering if user types it
                const filterValue = value.replace(/^peugeot\s*/i, '');
                setModelFilter(filterValue);
                setFormData(prev => ({ ...prev, model: value }));
                setShowModelDropdown(filterValue.length > 0 && filteredModels.length > 0);
            };
            
            const handleSelectModel = (model) => {
                // Store as "Peugeot {model}" format
                const fullModel = `Peugeot ${model}`;
                setFormData(prev => ({ ...prev, model: fullModel }));
                setModelFilter(model);
                setShowModelDropdown(false);
            };

            const handleFormChange = (field, value) => {
                setFormData(prev => ({ ...prev, [field]: value }));
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                const fd = new FormData(e.target);
                const d = Object.fromEntries(fd.entries());
                
                if (!d.plate || !d.plate.trim()) return alert("License plate is required");
                if (!d.owner || !d.owner.trim()) return alert("Owner name is required");
                if (!d.phone || !d.phone.trim()) return alert("Contact phone is required");
                if (!d.mileage) return alert("Arrival mileage is required");
                if (!d.model || !d.model.trim()) return alert("Vehicle model is required");
                if (!d.year || !d.year.trim()) return alert("Vehicle year is required");

                if (!isValidSLPlate(d.plate)) return alert("Invalid license plate format.\nAccepted:\n‚Ä¢ ABC-1234\n‚Ä¢ GS-5025\n‚Ä¢ 300-2330");
                if (!isValidSLPhone(d.phone)) return alert("Invalid phone format");
                if (parseInt(d.mileage) < 0) return alert("Mileage cannot be negative");
                
                // Validate Peugeot model - load from localStorage if available
                let peugeotModelsList = ['208', '307', '308', '3008', '2008', '206', '207', '407', '508', '5008', '106', '107', '108', '306', '406', '605', '607', '806', '807', '4008', 'rcz', 'traveller'];
                try {
                    const saved = localStorage.getItem('workshopSmartLists');
                    if (saved) {
                        const lists = JSON.parse(saved);
                        if (lists.peugeotModels) peugeotModelsList = lists.peugeotModels.map(m => m.toLowerCase());
                    }
                } catch (e) {}
                const isPeugeot = peugeotModelsList.some(m => d.model.toLowerCase().includes(m.toLowerCase()));
                if (!isPeugeot) {
                    return alert("‚ö†Ô∏è This workshop services Peugeot vehicles exclusively.\n\nPlease enter a valid Peugeot model.\n\nCommon models: 208, 308, 3008, 2008, 508");
                }
                
                // Concatenate model and year
                const fullModel = `${d.model} (${d.year})`;

                try {
                    let uploadedPhotoPath = null;
                    if (photoPath && photoPath.startsWith('data:image')) {
                        const photoRes = await callDB('upload-photo', { base64Data: photoPath });
                        if (photoRes.success) uploadedPhotoPath = photoRes.filePath;
                    }

                    const existingV = await callDB('db-query', { 
                        sql: "SELECT current_owner, contact_number FROM vehicles WHERE license_plate = ?", 
                        params: [d.plate.toUpperCase()] 
                    });

                    if (existingV.success && existingV.data.length > 0) {
                        const old = existingV.data[0];
                        if (old.current_owner !== d.owner) {
                            await callDB('db-run', {
                                sql: "INSERT INTO ownership_history (vehicle_id, old_owner, new_owner, mileage_at_transfer) SELECT vehicle_id, ?, ?, ? FROM vehicles WHERE license_plate = ?",
                                params: [old.current_owner, d.owner, d.mileage, d.plate.toUpperCase()]
                            });
                        }
                    }

                    const vRes = await callDB('db-run', {
                        sql: "INSERT INTO vehicles (license_plate, vin, make_model, current_owner, contact_number, photo_path) VALUES (?, ?, ?, ?, ?, ?) ON CONFLICT(license_plate) DO UPDATE SET current_owner=excluded.current_owner, contact_number=excluded.contact_number, photo_path=COALESCE(excluded.photo_path, vehicles.photo_path), make_model=excluded.make_model, vin=excluded.vin",
                        params: [d.plate.toUpperCase(), d.vin || null, fullModel, d.owner, d.phone, uploadedPhotoPath || null]
                    });

                    if (!vRes.success) return alert("Vehicle Save Failed: " + vRes.error);

                    const vSearch = await callDB('db-query', { sql: "SELECT vehicle_id FROM vehicles WHERE license_plate = ?", params: [d.plate.toUpperCase()] });
                    if (!vSearch.success || !vSearch.data || vSearch.data.length === 0) return alert("Failed to retrieve vehicle ID");

                    const vId = vSearch.data[0].vehicle_id;
                    const techId = d.technician && d.technician !== '' ? d.technician : null;

                    const jRes = await callDB('db-run', {
                        sql: "INSERT INTO jobs (vehicle_id, technician_id, mileage_in, owner_name, owner_phone, status) VALUES (?, ?, ?, ?, ?, 'pending')",
                        params: [vId, techId, parseInt(d.mileage), d.owner, d.phone]
                    });
                    if (jRes.success) {
                        onSaved();
                        onClose();
                    } else {
                        alert("Job Creation Failed: " + jRes.error);
                    }
                } catch (error) {
                    console.error("Form Submission Error:", error);
                    alert("An error occurred: " + error.message);
                }
            };

            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-md flex items-center justify-center p-4 z-50" onClick={onClose}>
                    <form onSubmit={handleSubmit} onClick={(e) => e.stopPropagation()} className="glass-dark p-8 rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto border border-slate-700/50 animate-in zoom-in duration-300">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold text-white">New Vehicle Intake</h2>
                            <button type="button" onClick={onClose} className="text-slate-400 hover:text-slate-200 text-2xl">‚úï</button>
                        </div>
                        
                        <div className="mb-6">
                            <label className="text-xs font-semibold text-slate-400 uppercase tracking-wide mb-2 block">Vehicle Photo</label>
                            <div 
                                onClick={() => fileInput.current.click()} 
                                className="w-full h-40 bg-slate-900/50 border-2 border-dashed border-slate-600/50 rounded-lg flex flex-col items-center justify-center cursor-pointer hover:bg-indigo-600/5 hover:border-indigo-500/50 transition-all overflow-hidden"
                            >
                                {photoPath ? (
                                    <div className="text-center p-4">
                                        <p className="text-indigo-400 font-semibold text-sm">‚úì Photo Attached</p>
                                    </div>
                                ) : (
                                    <div className="text-center">
                                        <span className="text-3xl mb-2 block opacity-40">üì∑</span>
                                        <span className="text-xs font-medium text-slate-400">Click to upload car photo</span>
                                    </div>
                                )}
                                <input type="file" ref={fileInput} className="hidden" accept="image/*" onChange={(e) => {
                                    if (!e.target.files[0]) return;
                                    const file = e.target.files[0];
                                    const reader = new FileReader();
                                    reader.onload = (evt) => setPhotoPath(evt.target.result);
                                    reader.readAsDataURL(file);
                                }} />
                            </div>
                        </div>

                        <div className="grid grid-cols-2 gap-4">
                            {/* License Plate - Auto capitalize */}
                            <div className="flex flex-col mb-4">
                                <label className="text-xs font-semibold text-slate-400 uppercase tracking-wide mb-2">License Plate</label>
                                <input 
                                    name="plate"
                                    type="text"
                                    value={plateValue}
                                    onChange={(e) => handlePlateChange(e.target.value)}
                                    required
                                    placeholder="ABC-1234"
                                    className="px-4 py-3 bg-slate-900/50 border border-slate-700/50 rounded-lg outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition-all text-sm text-slate-200 placeholder-slate-500 uppercase"
                                />
                                {existingVehicle && (
                                    <span className="text-xs text-emerald-400 mt-1">‚úì Vehicle found - details auto-filled</span>
                                )}
                            </div>
                            <div className="flex flex-col mb-4">
                                <label className="text-xs font-semibold text-slate-400 uppercase tracking-wide mb-2">VIN / Chassis</label>
                                <input 
                                    name="vin"
                                    type="text"
                                    value={formData.vin}
                                    onChange={(e) => handleFormChange('vin', e.target.value)}
                                    placeholder="Optional"
                                    className="px-4 py-3 bg-slate-900/50 border border-slate-700/50 rounded-lg outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition-all text-sm text-slate-200 placeholder-slate-500"
                                />
                            </div>
                        </div>

                        {/* Make & Model with Autocomplete */}
                        <div className="grid grid-cols-3 gap-4">
                            <div className="col-span-2 flex flex-col relative mb-4" ref={modelDropdownRef}>
                                <label className="text-xs font-semibold text-slate-400 uppercase tracking-wide mb-2">Make & Model</label>
                                <input 
                                    name="model"
                                    type="text"
                                    value={formData.model}
                                    required
                                    placeholder="e.g., 308 or Peugeot 308"
                                    onChange={(e) => handleModelInput(e.target.value)}
                                    onFocus={() => setShowModelDropdown(true)}
                                    className="px-4 py-3 bg-slate-900/50 border border-slate-700/50 rounded-lg outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition-all text-sm text-slate-200 placeholder-slate-500" 
                                />
                                {showModelDropdown && filteredModels.length > 0 && (
                                    <div className="absolute top-full left-0 right-0 bg-slate-800 border border-slate-700 rounded-lg mt-1 z-20 max-h-48 overflow-y-auto shadow-lg">
                                        {filteredModels.map(model => (
                                            <button 
                                                key={model} 
                                                type="button" 
                                                onClick={() => handleSelectModel(model)} 
                                                className="w-full text-left px-4 py-2 text-slate-200 hover:bg-indigo-600/30 transition-colors text-sm font-medium border-b border-slate-700/30 last:border-b-0"
                                            >
                                                <span className="text-indigo-400">Peugeot</span> {model}
                                            </button>
                                        ))}
                                    </div>
                                )}
                            </div>
                            <div className="flex flex-col mb-4">
                                <label className="text-xs font-semibold text-slate-400 uppercase tracking-wide mb-2">Year</label>
                                <input 
                                    name="year"
                                    type="text"
                                    inputMode="numeric"
                                    value={formData.year}
                                    onChange={(e) => handleFormChange('year', e.target.value.replace(/[^0-9]/g, ''))}
                                    required
                                    placeholder="2020"
                                    maxLength="4"
                                    className="px-4 py-3 bg-slate-900/50 border border-slate-700/50 rounded-lg outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition-all text-sm text-slate-200 placeholder-slate-500"
                                />
                            </div>
                        </div>
                        
                        <div className="h-px bg-slate-700/30 my-6"></div>
                        
                        <div className="grid grid-cols-2 gap-4">
                            {/* Owner Name - Simple Input */}
                            <div className="flex flex-col mb-4">
                                <label className="text-xs font-semibold text-slate-400 uppercase tracking-wide mb-2">Owner Name</label>
                                <input 
                                    name="owner"
                                    type="text"
                                    value={formData.owner}
                                    onChange={(e) => handleFormChange('owner', e.target.value)}
                                    required
                                    placeholder="e.g., Ramesh Kumar"
                                    className="px-4 py-3 bg-slate-900/50 border border-slate-700/50 rounded-lg outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition-all text-sm text-slate-200 placeholder-slate-500"
                                />
                                {existingVehicle && existingVehicle.current_owner !== formData.owner && formData.owner.length > 0 && (
                                    <span className="text-xs text-yellow-400 mt-1">‚ö† Owner changed from "{existingVehicle.current_owner}" - will update history</span>
                                )}
                            </div>
                            <div className="flex flex-col mb-4">
                                <label className="text-xs font-semibold text-slate-400 uppercase tracking-wide mb-2">Contact Phone</label>
                                <input 
                                    name="phone"
                                    type="tel"
                                    value={formData.phone}
                                    onChange={(e) => handleFormChange('phone', e.target.value)}
                                    required
                                    className="px-4 py-3 bg-slate-900/50 border border-slate-700/50 rounded-lg outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition-all text-sm text-slate-200 placeholder-slate-500"
                                />
                            </div>
                        </div>
                        <div className="flex flex-col mb-4">
                            <label className="text-xs font-semibold text-slate-400 uppercase tracking-wide mb-2">Arrival Mileage</label>
                            <input 
                                name="mileage"
                                type="text"
                                inputMode="numeric"
                                value={formData.mileage}
                                onChange={(e) => handleFormChange('mileage', e.target.value.replace(/[^0-9]/g, ''))}
                                required
                                className="px-4 py-3 bg-slate-900/50 border border-slate-700/50 rounded-lg outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition-all text-sm text-slate-200 placeholder-slate-500"
                            />
                        </div>

                        <div className="h-px bg-slate-700/30 my-6"></div>

                        <div className="mb-6">
                            <label className="text-xs font-semibold text-slate-400 uppercase tracking-wide mb-2 block">Assign Technician (Optional)</label>
                            <select name="technician" className="w-full px-4 py-3 bg-slate-900/50 border border-slate-700/50 rounded-lg outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 text-sm text-slate-200">
                                <option value="">‚Äî No Assignment ‚Äî</option>
                                {technicians.map(t => <option key={t.user_id} value={t.user_id}>{t.full_name}</option>)}
                            </select>
                        </div>

                        <div className="flex gap-3 mt-8">
                            <button type="button" onClick={onClose} className="flex-1 py-3 font-semibold text-slate-400 hover:text-slate-200 transition-colors">Cancel</button>
                            <button type="submit" className="flex-1 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-semibold shadow-lg shadow-indigo-500/20 active:scale-95 transition-all">Create Job</button>
                        </div>
                    </form>
                </div>
            );
        };

        // VEHICLE HISTORY VIEWER - Complete history including photo, jobs, and ownership
        const OwnershipHistoryViewer = ({ vehicleId, licensePlate, onClose }) => {
            const [vehicle, setVehicle] = useState(null);
            const [ownershipHistory, setOwnershipHistory] = useState([]);
            const [jobHistory, setJobHistory] = useState([]);
            const [loading, setLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('jobs');

            useEffect(() => {
                const loadHistory = async () => {
                    // Load vehicle details including photo
                    const vRes = await callDB('db-query', {
                        sql: "SELECT * FROM vehicles WHERE vehicle_id = ?",
                        params: [vehicleId]
                    });
                    if (vRes.success && vRes.data.length > 0) setVehicle(vRes.data[0]);

                    // Load ownership history
                    const oRes = await callDB('db-query', {
                        sql: "SELECT * FROM ownership_history WHERE vehicle_id = ? ORDER BY transfer_date DESC",
                        params: [vehicleId]
                    });
                    if (oRes.success) setOwnershipHistory(oRes.data);

                    // Load job history
                    const jRes = await callDB('db-query', {
                        sql: "SELECT j.*, u.full_name as tech_name FROM jobs j LEFT JOIN users u ON j.technician_id = u.user_id WHERE j.vehicle_id = ? ORDER BY j.created_at DESC",
                        params: [vehicleId]
                    });
                    if (jRes.success) setJobHistory(jRes.data);

                    setLoading(false);
                };
                loadHistory();
            }, [vehicleId]);

            const getPhotoUrl = (photoPath) => {
                if (!photoPath) return null;
                // Convert file path to file:// URL for Electron
                return `file:///${photoPath.replace(/\\/g, '/')}`;
            };

            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50 animate-in fade-in duration-200">
                    <div className="glass-dark rounded-2xl shadow-2xl max-w-3xl w-full max-h-[85vh] overflow-auto border border-slate-700/50">
                        <div className="sticky top-0 glass-dark border-b border-slate-700/50 p-6 z-10">
                            <div className="flex justify-between items-start">
                                <div className="flex gap-4">
                                    {/* Vehicle Photo */}
                                    {vehicle?.photo_path ? (
                                        <div className="w-24 h-24 rounded-lg overflow-hidden bg-slate-800 border border-slate-700/50">
                                            <img 
                                                src={getPhotoUrl(vehicle.photo_path)} 
                                                alt={licensePlate}
                                                className="w-full h-full object-cover"
                                                onError={(e) => { e.target.style.display = 'none'; }}
                                            />
                                        </div>
                                    ) : (
                                        <div className="w-24 h-24 rounded-lg bg-slate-800/50 border border-slate-700/50 flex items-center justify-center">
                                            <span className="text-3xl opacity-30">üöó</span>
                                        </div>
                                    )}
                                    <div>
                                        <h2 className="text-2xl font-bold text-white">{licensePlate}</h2>
                                        <p className="text-slate-400 text-sm">{vehicle?.make_model || '-'}</p>
                                        <p className="text-slate-500 text-xs mt-1">Owner: {vehicle?.current_owner || '-'}</p>
                                        <p className="text-slate-500 text-xs">Phone: {vehicle?.contact_number || '-'}</p>
                                    </div>
                                </div>
                                <button onClick={onClose} className="text-slate-400 hover:text-slate-200 text-2xl">‚úï</button>
                            </div>
                            
                            {/* Tabs */}
                            <div className="flex gap-2 mt-4">
                                <button 
                                    onClick={() => setActiveTab('jobs')}
                                    className={`px-4 py-2 rounded-lg text-xs font-semibold uppercase tracking-wide transition-colors ${activeTab === 'jobs' ? 'bg-indigo-600 text-white' : 'bg-slate-800/50 text-slate-400 hover:text-slate-200'}`}
                                >
                                    üîß Service History ({jobHistory.length})
                                </button>
                                <button 
                                    onClick={() => setActiveTab('ownership')}
                                    className={`px-4 py-2 rounded-lg text-xs font-semibold uppercase tracking-wide transition-colors ${activeTab === 'ownership' ? 'bg-indigo-600 text-white' : 'bg-slate-800/50 text-slate-400 hover:text-slate-200'}`}
                                >
                                    üë§ Ownership ({ownershipHistory.length})
                                </button>
                            </div>
                        </div>

                        <div className="p-6">
                            {loading ? (
                                <p className="text-slate-400 text-sm">Loading history...</p>
                            ) : activeTab === 'jobs' ? (
                                /* Job History Tab */
                                jobHistory.length === 0 ? (
                                    <p className="text-slate-400 text-sm text-center py-8">No service history recorded.</p>
                                ) : (
                                    <div className="space-y-3">
                                        {jobHistory.map((job) => (
                                            <div key={job.job_id} className="bg-slate-800/30 p-4 rounded-lg border border-slate-700/50">
                                                <div className="flex justify-between items-start mb-2">
                                                    <div>
                                                        <span className="text-xs font-mono text-slate-500">Job #{job.job_id}</span>
                                                        <p className="text-slate-200 font-semibold">{formatDateSL(job.created_at)}</p>
                                                    </div>
                                                    <span className={`px-3 py-1 rounded-full text-xs font-semibold border ${
                                                        job.status === 'completed' ? 'bg-emerald-600/30 text-emerald-300 border-emerald-500/30' :
                                                        job.status === 'in-progress' ? 'bg-indigo-600/30 text-indigo-300 border-indigo-500/30' :
                                                        'bg-slate-700/30 text-slate-300 border-slate-600/50'
                                                    }`}>
                                                        {job.status}
                                                    </span>
                                                </div>
                                                <div className="grid grid-cols-3 gap-4 text-xs mt-3">
                                                    <div>
                                                        <span className="text-slate-500">Mileage</span>
                                                        <p className="text-slate-300 font-mono">{job.mileage_in?.toLocaleString() || '-'} KM</p>
                                                    </div>
                                                    <div>
                                                        <span className="text-slate-500">Technician</span>
                                                        <p className="text-slate-300">{job.tech_name || 'Unassigned'}</p>
                                                    </div>
                                                    <div>
                                                        <span className="text-slate-500">Total</span>
                                                        <p className="text-emerald-400 font-semibold">{job.total_price ? formatLKR(job.total_price) : '-'}</p>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )
                            ) : (
                                /* Ownership History Tab */
                                ownershipHistory.length === 0 ? (
                                    <p className="text-slate-400 text-sm text-center py-8">No ownership transfers recorded. Current owner: {vehicle?.current_owner}</p>
                                ) : (
                                    <div className="space-y-3">
                                        {ownershipHistory.map((entry, idx) => (
                                            <div key={entry.history_id} className="bg-slate-800/30 p-4 rounded-lg border border-slate-700/50">
                                                <div className="flex justify-between items-start mb-3">
                                                    <p className="text-slate-400 text-sm">{formatDateSL(entry.transfer_date)}</p>
                                                    <span className="bg-yellow-600/30 text-yellow-300 px-3 py-1 rounded-full text-xs font-semibold border border-yellow-500/30">Owner Change</span>
                                                </div>
                                                <div className="flex items-center gap-3 text-sm">
                                                    <span className="text-slate-400">{entry.old_owner}</span>
                                                    <span className="text-indigo-400">‚Üí</span>
                                                    <span className="font-semibold text-emerald-400">{entry.new_owner}</span>
                                                </div>
                                                <p className="text-xs text-slate-500 mt-2">Mileage: {entry.mileage_at_transfer?.toLocaleString() || '-'} KM</p>
                                            </div>
                                        ))}
                                    </div>
                                )
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // JOB DETAIL - Complete Job Management
        const JobDetail = ({ jobId, onBack, onError, showToast }) => {
            const [data, setData] = useState(null);
            const [tasks, setTasks] = useState([]);
            const [parts, setParts] = useState([]);
            const [inventory, setInventory] = useState([]);
            const [isPrint, setIsPrint] = useState(false);
            const [showOwnershipHistory, setShowOwnershipHistory] = useState(false);
            const [isComputing, setIsComputing] = useState(false);
            const [newTaskText, setNewTaskText] = useState('');
            const [partSuggestions, setPartSuggestions] = useState([]);
            const [newPartName, setNewPartName] = useState('');
            const [showPartDropdown, setShowPartDropdown] = useState(false);
            const [technicians, setTechnicians] = useState([]);
            const [assignedTech, setAssignedTech] = useState(null);
            const [laborCostInput, setLaborCostInput] = useState('');
            const [taxiCostInput, setTaxiCostInput] = useState('');
            const [mileageInInput, setMileageInInput] = useState('');
            const [showTaskDropdown, setShowTaskDropdown] = useState(false);
            const [serviceChecklistItems, setServiceChecklistItems] = useState([]);
            // Edit states for tasks and parts
            const [editingTaskId, setEditingTaskId] = useState(null);
            const [editingTaskText, setEditingTaskText] = useState('');
            const [editingPartId, setEditingPartId] = useState(null);
            const [editingPartQty, setEditingPartQty] = useState('');
            const [editingPartPrice, setEditingPartPrice] = useState('');

            const load = async () => {
                const j = await callDB('db-query', { 
                    sql: `SELECT j.*, v.vehicle_id, v.license_plate, v.vin, v.make_model, v.photo_path, v.is_archived, 
                          COALESCE(j.owner_name, 
                            (SELECT oh.old_owner FROM ownership_history oh 
                             WHERE oh.vehicle_id = j.vehicle_id AND oh.transfer_date > j.created_at 
                             ORDER BY oh.transfer_date ASC LIMIT 1),
                            v.current_owner) as current_owner, 
                          COALESCE(j.owner_phone, v.contact_number) as contact_number, 
                          u.hourly_rate FROM jobs j 
                          JOIN vehicles v ON j.vehicle_id = v.vehicle_id 
                          LEFT JOIN users u ON j.technician_id = u.user_id WHERE j.job_id = ?`, 
                    params: [jobId] 
                });
                const t = await callDB('db-query', { sql: "SELECT * FROM job_tasks WHERE job_id = ?", params: [jobId] });
                const p = await callDB('db-query', { sql: "SELECT jp.*, i.part_name, i.part_number FROM job_parts jp JOIN inventory i ON jp.part_id = i.part_id WHERE jp.job_id = ?", params: [jobId] });
                const inv = await callDB('db-query', { sql: "SELECT * FROM inventory WHERE total_quantity > 0" });
                const dbParts = await callDB('db-query', { sql: "SELECT DISTINCT part_name FROM inventory ORDER BY part_name" });
                const techs = await callDB('db-query', { sql: "SELECT user_id, full_name, hourly_rate FROM users WHERE role = 'technician' ORDER BY full_name" });

                // Load smart list from localStorage
                let storedPartsList = [];
                try {
                    const saved = localStorage.getItem('workshopSmartLists');
                    if (saved) {
                        const lists = JSON.parse(saved);
                        if (lists.partNames) storedPartsList = lists.partNames;
                    }
                } catch (e) {}
                
                const defaultPartsList = storedPartsList.length > 0 ? storedPartsList : ['Engine Oil', 'Oil Filter', 'Air Filter', 'Cabin Air Filter', 'Spark Plugs', 'Ignition Coil', 'Battery', 'Alternator', 'Starter Motor', 'Water Pump', 'Thermostat', 'Coolant', 'Brake Fluid', 'Transmission Fluid', 'Differential Oil', 'Brake Pads', 'Brake Rotors', 'Brake Shoes', 'Brake Calipers', 'Brake Master Cylinder', 'Brake Lines', 'Clutch Plate', 'Flywheel', 'Transmission Mount', 'Engine Mount', 'Motor Mount', 'CV Axle', 'CV Joint', 'Drive Shaft', 'Suspension Coil', 'Shock Absorber', 'Strut', 'Ball Joint', 'Control Arm', 'Anti-Sway Bar', 'Stabilizer Link', 'Tie Rod', 'Steering Rack', 'Power Steering Pump', 'Steering Wheel', 'Serpentine Belt', 'Timing Belt', 'Radiator', 'Radiator Hose', 'Heater Hose', 'Water Jacket', 'Intercooler', 'Turbocharger', 'Catalytic Converter', 'Muffler', 'Exhaust Pipe', 'Oxygen Sensor', 'Mass Air Flow Sensor', 'Throttle Position Sensor', 'Manifold Absolute Pressure Sensor', 'Temperature Sensor', 'Fuel Filter', 'Fuel Pump', 'Fuel Injector', 'Fuel Pressure Regulator', 'Headlight', 'Tail Light', 'Brake Light', 'Fog Light', 'Turn Signal', 'Windshield Wiper Blade', 'Windshield Wiper Motor', 'Bulbs', 'Fuses', 'Relay', 'Door Lock', 'Window Regulator', 'Seat Belt', 'Airbag', 'Dashboard', 'Mirror', 'Radiator Fan', 'Condenser', 'Compressor', 'Expansion Valve', 'Evaporator', 'Accumulator', 'Refrigerant', 'PCM/ECU', 'Transmission Control Module', 'Abs Module', 'Airbag Module'];

                // Load service checklist from smart lists
                let storedChecklistItems = [];
                try {
                    const savedLists = localStorage.getItem('workshopSmartLists');
                    if (savedLists) {
                        const lists = JSON.parse(savedLists);
                        if (lists.serviceChecklist) storedChecklistItems = lists.serviceChecklist;
                    }
                } catch (e) {}
                const defaultChecklistItems = [
                    'Change Engine Oil', 'Replace Oil Filter', 'Replace Air Filter', 'Replace Cabin Filter',
                    'Check/Top Up Coolant', 'Check/Top Up Brake Fluid', 'Inspect Brake Pads', 'Inspect Tyres',
                    'Check All Lights', 'Diagnostic Scan', 'Road Test', 'Reset Service Light'
                ];
                setServiceChecklistItems(storedChecklistItems.length > 0 ? storedChecklistItems : defaultChecklistItems);

                let mergedParts = [...defaultPartsList];
                if (dbParts.success && dbParts.data) {
                    dbParts.data.forEach(p => {
                        if (!mergedParts.includes(p.part_name)) mergedParts.push(p.part_name);
                    });
                }
                setPartSuggestions(mergedParts.sort());

                if (j.success) {
                    setData(j.data[0]);
                    // Find assigned technician
                    if (techs.success && j.data[0].technician_id) {
                        const tech = techs.data.find(t => t.user_id === j.data[0].technician_id);
                        setAssignedTech(tech || null);
                    } else {
                        setAssignedTech(null);
                    }
                    // Set labor cost, taxi cost and mileage from loaded data (handle 0 as valid)
                    setLaborCostInput(j.data[0].labor_cost != null ? String(j.data[0].labor_cost) : '');
                    setTaxiCostInput(j.data[0].taxi_cost != null ? String(j.data[0].taxi_cost) : '');
                    setMileageInInput(j.data[0].mileage_in != null ? String(j.data[0].mileage_in) : '');
                }
                if (t.success) setTasks(t.data);
                if (p.success) setParts(p.data);
                if (inv.success) setInventory(inv.data);
                if (techs.success) setTechnicians(techs.data);
            };

            const assignTechnician = async (techId) => {
                const res = await callDB('db-run', {
                    sql: "UPDATE jobs SET technician_id = ? WHERE job_id = ?",
                    params: [techId || null, jobId]
                });
                if (res.success) {
                    showToast && showToast('Technician updated', 'success');
                    load();
                }
            };

            useEffect(() => { load(); }, [jobId]);

            const addTask = async (e) => {
                if (e.key === 'Enter' && newTaskText.trim()) {
                    const taskDescription = newTaskText.trim();
                    await callDB('db-run', { sql: "INSERT INTO job_tasks (job_id, description) VALUES (?, ?)", params: [jobId, taskDescription] });
                    
                    // Auto-add to service checklist smart list if not already present
                    if (!serviceChecklistItems.some(item => item.toLowerCase() === taskDescription.toLowerCase())) {
                        try {
                            const saved = localStorage.getItem('workshopSmartLists');
                            const lists = saved ? JSON.parse(saved) : {};
                            const currentList = lists.serviceChecklist || serviceChecklistItems;
                            if (!currentList.some(item => item.toLowerCase() === taskDescription.toLowerCase())) {
                                lists.serviceChecklist = [...currentList, taskDescription].sort();
                                localStorage.setItem('workshopSmartLists', JSON.stringify(lists));
                                setServiceChecklistItems(lists.serviceChecklist);
                            }
                        } catch (err) {}
                    }
                    
                    setNewTaskText("");
                    setShowTaskDropdown(false);
                    load();
                }
            };

            const addPart = async (id) => {
                if (!id) return;
                const item = inventory.find(x => x.part_id == id);
                const existing = parts.find(p => p.part_id == id);
                
                if (existing) {
                    await callDB('db-run', {
                        sql: "UPDATE job_parts SET qty = qty + 1 WHERE id = ?",
                        params: [existing.id]
                    });
                } else {
                    await callDB('db-run', { 
                        sql: "INSERT INTO job_parts (job_id, part_id, qty, price_at_sale, cost_at_sale) VALUES (?, ?, 1, ?, ?)", 
                        params: [jobId, id, item.retail_price, item.avg_cost] 
                    });
                }
                
                await callDB('db-run', { sql: "UPDATE inventory SET total_quantity = total_quantity - 1 WHERE part_id = ?", params: [id] });
                load();
            };

            const removePart = async (item) => {
                await callDB('db-run', { sql: "DELETE FROM job_parts WHERE id = ?", params: [item.id] });
                await callDB('db-run', { sql: "UPDATE inventory SET total_quantity = total_quantity + ? WHERE part_id = ?", params: [item.qty, item.part_id] });
                load();
            };

            const completeJob = async () => {
                const laborCost = parseFloat(laborCostInput) || 0;
                
                setIsComputing(true);
                try {
                    const partsTotal = parts.reduce((acc, p) => acc + (p.price_at_sale * p.qty), 0);
                    const taxiCost = parseFloat(taxiCostInput) || 0;
                    const subtotal = partsTotal + laborCost + taxiCost;
                    const vat = subtotal * 0.08;
                    const total = subtotal + vat;

                    const updateRes = await callDB('db-run', { 
                        sql: "UPDATE jobs SET status='completed', labor_cost=?, taxi_cost=?, total_price=?, completion_date=CURRENT_TIMESTAMP WHERE job_id=?", 
                        params: [laborCost, taxiCost, total, jobId] 
                    });
                    
                    if (!updateRes.success) throw new Error(updateRes.error);
                    
                    alert("‚úì Job completed successfully!");
                    onBack();
                } catch (error) {
                    console.error("Completion error:", error);
                    onError?.("Job Completion Failed", error.message) || alert("Error completing job: " + error.message);
                } finally {
                    setIsComputing(false);
                }
            };

            const toggleTask = async (taskId, isCompleted) => {
                await callDB('db-run', { 
                    sql: "UPDATE job_tasks SET is_completed = ? WHERE task_id = ?", 
                    params: [isCompleted ? 1 : 0, taskId] 
                });
                load();
            };

            // Edit task description
            const startEditTask = (task) => {
                setEditingTaskId(task.task_id);
                setEditingTaskText(task.description);
            };

            const saveTaskEdit = async () => {
                if (!editingTaskText.trim()) return;
                await callDB('db-run', {
                    sql: "UPDATE job_tasks SET description = ? WHERE task_id = ?",
                    params: [editingTaskText.trim(), editingTaskId]
                });
                setEditingTaskId(null);
                setEditingTaskText('');
                load();
                showToast && showToast('Task updated', 'success');
            };

            const cancelTaskEdit = () => {
                setEditingTaskId(null);
                setEditingTaskText('');
            };

            const deleteTask = async (taskId) => {
                if (confirm('Delete this task?')) {
                    await callDB('db-run', { sql: "DELETE FROM job_tasks WHERE task_id = ?", params: [taskId] });
                    load();
                    showToast && showToast('Task deleted', 'success');
                }
            };

            // Edit part quantity and price
            const startEditPart = (part) => {
                setEditingPartId(part.id);
                setEditingPartQty(String(part.qty));
                setEditingPartPrice(String(part.price_at_sale));
            };

            const savePartEdit = async () => {
                const qty = parseInt(editingPartQty) || 1;
                const price = parseFloat(editingPartPrice) || 0;
                await callDB('db-run', {
                    sql: "UPDATE job_parts SET qty = ?, price_at_sale = ? WHERE id = ?",
                    params: [qty, price, editingPartId]
                });
                setEditingPartId(null);
                setEditingPartQty('');
                setEditingPartPrice('');
                load();
                showToast && showToast('Part updated', 'success');
            };

            const cancelPartEdit = () => {
                setEditingPartId(null);
                setEditingPartQty('');
                setEditingPartPrice('');
            };

            if (!data) return <div className="p-8 text-slate-400 font-medium">Loading Job Record...</div>;
            if (isPrint) return <PrintView job={data} tasks={tasks} parts={parts} onBack={() => setIsPrint(false)} />;
            if (showOwnershipHistory) return <OwnershipHistoryViewer vehicleId={data.vehicle_id} licensePlate={data.license_plate} onClose={() => setShowOwnershipHistory(false)} />;

            return (
                <div className="animate-in slide-in-from-right duration-500 space-y-6">
                    <header className="flex justify-between items-center no-print">
                        <button onClick={onBack} className="text-slate-400 hover:text-slate-200 font-semibold text-sm transition-colors">‚Üê Back</button>
                        <div className="flex gap-3 items-center">
                            <div className="flex items-center gap-2">
                                <span className="text-xs font-semibold text-slate-400 uppercase tracking-wide">Status:</span>
                                <select 
                                    value={data.status || 'pending'} 
                                    onChange={async (e) => {
                                        const res = await callDB('update-job-status', { jobId: jobId, newStatus: e.target.value });
                                        if (res.success) load();
                                        else alert("Cannot change status: " + res.error);
                                    }}
                                    className="bg-slate-800/50 border border-slate-700/50 rounded-lg px-3 py-2 font-semibold text-xs outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 text-slate-200"
                                >
                                    <option value="pending">Pending</option>
                                    <option value="in-progress">In Progress</option>
                                    <option value="waiting">Waiting for Parts</option>
                                    <option value="completed">Completed</option>
                                </select>
                            </div>
                            <button onClick={() => setIsPrint(true)} className="bg-slate-800/50 hover:bg-slate-700/50 text-slate-300 px-4 py-2 rounded-lg font-semibold text-sm border border-slate-700/50 transition-colors">üìÑ Invoice</button>
                            {data.status === 'completed' ? (
                                <button 
                                    onClick={async () => {
                                        if (confirm('Reopen this job? It will be set back to "In Progress" status.')) {
                                            const res = await callDB('db-run', {
                                                sql: "UPDATE jobs SET status = 'in-progress', completion_date = NULL WHERE job_id = ?",
                                                params: [jobId]
                                            });
                                            if (res.success) load();
                                            else alert('Failed to reopen job: ' + res.error);
                                        }
                                    }}
                                    className="bg-amber-600/80 hover:bg-amber-600 text-white px-6 py-2 rounded-lg font-semibold text-sm shadow-lg shadow-amber-500/20 active:scale-95 transition-all"
                                >
                                    üîÑ Reopen Job
                                </button>
                            ) : (
                                <button onClick={completeJob} disabled={isComputing} className="bg-emerald-600/80 hover:bg-emerald-600 text-white px-6 py-2 rounded-lg font-semibold text-sm shadow-lg shadow-emerald-500/20 active:scale-95 transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
                                    {isComputing ? (
                                        <>
                                            <span className="inline-block w-3 h-3 border-2 border-white border-t-transparent rounded-full animate-spin"></span>
                                            Processing...
                                        </>
                                    ) : (
                                        "‚úì Complete"
                                    )}
                                </button>
                            )}
                        </div>
                    </header>

                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        {/* LEFT: Management */}
                        <div className="lg:col-span-2 space-y-6">
                            <section className="glass-dark p-6 rounded-xl border border-slate-700/50">
                                <h3 className="text-lg font-bold mb-4 flex items-center text-white"><span className="mr-2">‚úì</span> Service Checklist</h3>
                                <div className="space-y-2">
                                    {tasks.map(t => (
                                        editingTaskId === t.task_id ? (
                                            <div key={t.task_id} className="p-4 rounded-lg bg-indigo-600/20 border border-indigo-500/50 flex gap-2 items-center">
                                                <input 
                                                    type="text"
                                                    value={editingTaskText}
                                                    onChange={(e) => setEditingTaskText(e.target.value)}
                                                    onKeyDown={(e) => { if (e.key === 'Enter') saveTaskEdit(); if (e.key === 'Escape') cancelTaskEdit(); }}
                                                    className="flex-1 p-2 bg-slate-800/50 border border-slate-600 rounded text-sm text-white outline-none focus:border-indigo-500"
                                                    autoFocus
                                                />
                                                <button onClick={saveTaskEdit} className="px-3 py-2 bg-emerald-600/80 hover:bg-emerald-600 text-white rounded text-xs font-semibold">Save</button>
                                                <button onClick={cancelTaskEdit} className="px-3 py-2 bg-slate-600/80 hover:bg-slate-600 text-white rounded text-xs font-semibold">Cancel</button>
                                            </div>
                                        ) : (
                                            <div key={t.task_id} className={`p-4 rounded-lg flex justify-between items-center border transition-all group ${t.is_completed ? 'bg-emerald-600/10 border-emerald-500/30' : 'bg-slate-800/30 border-slate-700/50 hover:border-indigo-500/30'}`}>
                                                <div className="flex items-center gap-3 flex-1">
                                                    <button onClick={() => toggleTask(t.task_id, !t.is_completed)} className={`flex-shrink-0 w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all ${t.is_completed ? 'bg-emerald-600 border-emerald-500' : 'border-slate-500 hover:border-indigo-500'}`}>
                                                        {t.is_completed && <span className="text-white text-xs font-bold">‚úì</span>}
                                                    </button>
                                                    <span onClick={() => startEditTask(t)} className={`cursor-pointer hover:text-indigo-400 font-medium ${t.is_completed ? 'text-emerald-300' : 'text-slate-300'}`}>{t.description}</span>
                                                </div>
                                                <div className="flex items-center gap-2">
                                                    <button onClick={() => startEditTask(t)} className="text-slate-500 hover:text-indigo-400 text-xs font-semibold opacity-0 group-hover:opacity-100 transition-opacity">‚úèÔ∏è</button>
                                                    <button onClick={() => deleteTask(t.task_id)} className="text-slate-500 hover:text-red-400 text-xs font-semibold opacity-0 group-hover:opacity-100 transition-opacity">üóëÔ∏è</button>
                                                    {t.is_completed ? <span className="text-xs font-semibold uppercase text-emerald-400 bg-emerald-600/20 px-2 py-1 rounded">Done</span> : <span className="text-xs font-semibold uppercase text-slate-500">Pending</span>}
                                                </div>
                                            </div>
                                        )
                                    ))}
                                    <div className="relative">
                                        <input 
                                            value={newTaskText}
                                            onChange={(e) => {
                                                setNewTaskText(e.target.value);
                                                setShowTaskDropdown(e.target.value.length > 0);
                                            }}
                                            onFocus={() => setShowTaskDropdown(true)}
                                            onBlur={() => setTimeout(() => setShowTaskDropdown(false), 200)}
                                            onKeyDown={addTask} 
                                            placeholder="+ Add task or select from checklist..." 
                                            className="w-full p-3 bg-slate-800/30 border border-dashed border-slate-700/50 rounded-lg outline-none focus:border-indigo-500 focus:bg-indigo-600/5 transition-all text-sm text-slate-200 placeholder-slate-500" 
                                        />
                                        {showTaskDropdown && (
                                            <div className="absolute top-full left-0 right-0 bg-slate-800 border border-slate-700 rounded-lg mt-1 z-20 max-h-48 overflow-y-auto shadow-lg">
                                                {serviceChecklistItems
                                                    .filter(item => !newTaskText || item.toLowerCase().includes(newTaskText.toLowerCase()))
                                                    .filter(item => !tasks.some(t => t.description.toLowerCase() === item.toLowerCase()))
                                                    .slice(0, 10)
                                                    .map((item, idx) => (
                                                        <button 
                                                            key={idx}
                                                            type="button"
                                                            onMouseDown={(e) => e.preventDefault()}
                                                            onClick={async () => {
                                                                await callDB('db-run', { sql: "INSERT INTO job_tasks (job_id, description) VALUES (?, ?)", params: [jobId, item] });
                                                                setNewTaskText('');
                                                                setShowTaskDropdown(false);
                                                                load();
                                                            }}
                                                            className="w-full text-left px-4 py-2 text-slate-200 hover:bg-indigo-600/30 transition-colors text-sm font-medium border-b border-slate-700/30 last:border-b-0"
                                                        >
                                                            {item}
                                                        </button>
                                                    ))}
                                                {serviceChecklistItems.filter(item => !newTaskText || item.toLowerCase().includes(newTaskText.toLowerCase())).filter(item => !tasks.some(t => t.description.toLowerCase() === item.toLowerCase())).length === 0 && newTaskText.trim() && (
                                                    <div className="px-4 py-2 text-slate-400 text-sm">Press Enter to add "{newTaskText}"</div>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </section>

                            <section className="glass-dark p-6 rounded-xl border border-slate-700/50">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-lg font-bold flex items-center text-white"><span className="mr-2">üì¶</span> Parts Installed</h3>
                                    <div className="relative w-64">
                                        <input 
                                            type="text"
                                            value={newPartName}
                                            onChange={(e) => {
                                                setNewPartName(e.target.value);
                                                setShowPartDropdown(true);
                                            }}
                                            onBlur={() => setTimeout(() => setShowPartDropdown(false), 200)}
                                            onFocus={() => setShowPartDropdown(true)}
                                            placeholder="Search or type part..."
                                            className="w-full bg-slate-800/50 p-2 rounded-lg text-xs font-semibold border border-slate-700/50 outline-none focus:border-indigo-500 text-slate-200 placeholder-slate-500"
                                        />
                                        {showPartDropdown && (
                                            <div className="absolute top-full left-0 right-0 bg-slate-800 border border-slate-700 rounded-lg mt-1 z-20 max-h-48 overflow-y-auto shadow-lg">
                                                {inventory.length > 0 && (
                                                    <div className="px-3 py-1 text-[10px] text-slate-500 font-semibold uppercase border-b border-slate-700">In Stock</div>
                                                )}
                                                {inventory
                                                    .filter(i => !newPartName || i.part_name.toLowerCase().includes(newPartName.toLowerCase()))
                                                    .slice(0, 10)
                                                    .map(item => (
                                                        <button 
                                                            key={item.part_id}
                                                            type="button"
                                                            onMouseDown={(e) => e.preventDefault()}
                                                            onClick={() => {
                                                                addPart(item.part_id);
                                                                setNewPartName('');
                                                                setShowPartDropdown(false);
                                                            }}
                                                            className="w-full text-left px-4 py-2 text-slate-200 hover:bg-indigo-600/30 transition-colors text-xs font-medium border-b border-slate-700/30 last:border-b-0 flex justify-between"
                                                        >
                                                            <span>{item.part_name}</span>
                                                            <span className="text-slate-500">Qty: {item.total_quantity}</span>
                                                        </button>
                                                    ))}
                                                {inventory.filter(i => !newPartName || i.part_name.toLowerCase().includes(newPartName.toLowerCase())).length === 0 && (
                                                    <div className="px-4 py-3 text-slate-400 text-xs text-center">No matching parts in inventory</div>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                </div>
                                <div className="space-y-2">
                                    {parts.map(p => (
                                        editingPartId === p.id ? (
                                            <div key={p.id} className="p-4 bg-indigo-600/20 rounded-lg border border-indigo-500/50">
                                                <p className="font-semibold text-indigo-300 mb-3">{p.part_name}</p>
                                                <div className="flex gap-3 items-end">
                                                    <div className="flex-1">
                                                        <label className="text-xs text-slate-400 block mb-1">Price (LKR)</label>
                                                        <input 
                                                            type="text"
                                                            inputMode="numeric"
                                                            value={editingPartPrice}
                                                            onChange={(e) => setEditingPartPrice(e.target.value.replace(/[^0-9.]/g, ''))}
                                                            className="w-full p-2 bg-slate-800/50 border border-slate-600 rounded text-sm text-white outline-none focus:border-indigo-500"
                                                        />
                                                    </div>
                                                    <div className="w-20">
                                                        <label className="text-xs text-slate-400 block mb-1">Qty</label>
                                                        <input 
                                                            type="text"
                                                            inputMode="numeric"
                                                            value={editingPartQty}
                                                            onChange={(e) => setEditingPartQty(e.target.value.replace(/[^0-9]/g, ''))}
                                                            className="w-full p-2 bg-slate-800/50 border border-slate-600 rounded text-sm text-white outline-none focus:border-indigo-500"
                                                        />
                                                    </div>
                                                    <button onClick={savePartEdit} className="px-3 py-2 bg-emerald-600/80 hover:bg-emerald-600 text-white rounded text-xs font-semibold">Save</button>
                                                    <button onClick={cancelPartEdit} className="px-3 py-2 bg-slate-600/80 hover:bg-slate-600 text-white rounded text-xs font-semibold">Cancel</button>
                                                </div>
                                            </div>
                                        ) : (
                                            <div key={p.id} className="flex justify-between items-center p-4 bg-indigo-600/10 rounded-lg border border-indigo-500/30 group">
                                                <div className="cursor-pointer" onClick={() => startEditPart(p)}>
                                                    <p className="font-semibold text-indigo-300">{p.part_name}</p>
                                                    <p className="text-xs font-mono text-indigo-500/70">{formatLKR(p.price_at_sale)} √ó {p.qty}</p>
                                                </div>
                                                <div className="flex items-center gap-3">
                                                    <span className="font-semibold text-indigo-300">{formatLKR(p.price_at_sale * p.qty)}</span>
                                                    <button onClick={() => startEditPart(p)} className="text-slate-400 hover:text-indigo-400 text-xs opacity-0 group-hover:opacity-100 transition-opacity">‚úèÔ∏è</button>
                                                    <button onClick={() => removePart(p)} className="text-red-400/50 hover:text-red-400 font-semibold text-xs opacity-0 group-hover:opacity-100 transition-opacity">üóëÔ∏è</button>
                                                </div>
                                            </div>
                                        )
                                    ))}
                                    {parts.length === 0 && <p className="text-center py-6 text-slate-500 text-sm">No parts added yet.</p>}
                                </div>
                            </section>
                        </div>

                        {/* RIGHT: Info Sidebar */}
                        <div className="space-y-6">
                            <section className="bg-gradient-to-br from-indigo-900/40 to-slate-900/40 text-slate-100 p-6 rounded-xl border border-indigo-500/30 shadow-lg shadow-indigo-500/5">
                                <p className="text-xs font-semibold text-indigo-400 uppercase tracking-wide mb-2">Vehicle</p>
                                <h2 className="text-2xl font-bold mb-1">{data.license_plate}</h2>
                                <p className="text-slate-400 text-sm mb-6">{data.make_model}</p>
                                
                                <div className="space-y-4 text-sm">
                                    <div className="flex justify-between pb-2 border-b border-slate-700/30">
                                        <span className="text-slate-400">Owner</span>
                                        <span className="font-semibold text-slate-200">{data.current_owner}</span>
                                    </div>
                                    <div className="flex justify-between pb-2 border-b border-slate-700/30">
                                        <span className="text-slate-400">Phone</span>
                                        <span className="font-semibold font-mono text-slate-200">{data.contact_number}</span>
                                    </div>
                                    <div className="pb-2 border-b border-slate-700/30">
                                        <div className="flex justify-between items-center mb-2">
                                            <span className="text-slate-400">Technician</span>
                                            {assignedTech ? (
                                                <span className="font-semibold text-indigo-300">üë§ {assignedTech.full_name}</span>
                                            ) : (
                                                <span className="text-yellow-400 text-xs font-semibold">Not assigned</span>
                                            )}
                                        </div>
                                        <select 
                                            value={data.technician_id || ''}
                                            onChange={(e) => assignTechnician(e.target.value)}
                                            className="w-full p-2 bg-slate-800/50 border border-slate-700/50 rounded text-xs font-semibold outline-none focus:border-indigo-500 text-slate-200"
                                        >
                                            <option value="">‚Äî No Assignment ‚Äî</option>
                                            {technicians.map(t => (
                                                <option key={t.user_id} value={t.user_id}>
                                                    {t.full_name} ({formatLKR(t.hourly_rate)}/hr)
                                                </option>
                                            ))}
                                        </select>
                                    </div>
                                    <div className="pb-2 border-b border-slate-700/30">
                                        <p className="text-slate-500 text-xs mb-1">Mileage</p>
                                        <input 
                                            type="text" 
                                            inputMode="numeric"
                                            id="mileage_in" 
                                            placeholder="0" 
                                            value={mileageInInput} 
                                            onChange={(e) => setMileageInInput(e.target.value.replace(/[^0-9]/g, ''))}
                                            onBlur={async (e) => {
                                                await callDB('db-run', { 
                                                    sql: "UPDATE jobs SET mileage_in = ? WHERE job_id = ?", 
                                                    params: [parseFloat(e.target.value) || 0, jobId] 
                                                });
                                            }}
                                            className="w-full p-2 bg-slate-800/50 border border-slate-700/50 rounded text-white font-semibold text-sm outline-none focus:border-indigo-500" 
                                        />
                                    </div>
                                    <div className="pb-2 border-b border-slate-700/30">
                                        <p className="text-slate-500 text-xs mb-1">Labor Cost (LKR)</p>
                                        <input 
                                            type="text" 
                                            inputMode="numeric"
                                            id="labor_cost" 
                                            placeholder="0" 
                                            value={laborCostInput} 
                                            onChange={(e) => setLaborCostInput(e.target.value.replace(/[^0-9.]/g, ''))}
                                            onBlur={async (e) => {
                                                await callDB('db-run', { 
                                                    sql: "UPDATE jobs SET labor_cost = ? WHERE job_id = ?", 
                                                    params: [parseFloat(e.target.value) || 0, jobId] 
                                                });
                                            }}
                                            className="w-full p-2 bg-slate-800/50 border border-slate-700/50 rounded text-white font-semibold text-sm outline-none focus:border-indigo-500" 
                                        />
                                    </div>
                                    <div className="pb-2 border-b border-slate-700/30">
                                        <p className="text-slate-500 text-xs mb-1">Taxi Cost (LKR)</p>
                                        <input 
                                            type="text" 
                                            inputMode="numeric"
                                            id="taxi_cost" 
                                            placeholder="0" 
                                            value={taxiCostInput} 
                                            onChange={(e) => setTaxiCostInput(e.target.value.replace(/[^0-9.]/g, ''))}
                                            onBlur={async (e) => {
                                                await callDB('db-run', { 
                                                    sql: "UPDATE jobs SET taxi_cost = ? WHERE job_id = ?", 
                                                    params: [parseFloat(e.target.value) || 0, jobId] 
                                                });
                                            }}
                                            className="w-full p-2 bg-slate-800/50 border border-slate-700/50 rounded text-white font-semibold text-sm outline-none focus:border-indigo-500" 
                                        />
                                    </div>
                                    <div className="flex justify-between">
                                        <span className="text-slate-400">Started</span>
                                        <span className="font-semibold text-slate-200 text-xs">{formatDateSL(data.created_at)}</span>
                                    </div>
                                    <button onClick={() => setShowOwnershipHistory(true)} className="mt-4 w-full bg-slate-800/50 hover:bg-slate-700/50 text-indigo-400 px-4 py-2 rounded-lg font-semibold text-xs uppercase tracking-wide border border-slate-700/50 transition-colors">
                                        ÔøΩ Vehicle History
                                    </button>
                                </div>
                            </section>

                            <section className="glass-dark p-6 rounded-xl border border-slate-700/50">
                                <h4 className="text-xs font-semibold text-slate-400 uppercase tracking-wide mb-4">Summary</h4>
                                <div className="space-y-3 text-sm">
                                    <div className="flex justify-between items-center">
                                        <span className="text-slate-400">Parts</span>
                                        <span className="font-semibold text-slate-200">{formatLKR(parts.reduce((a,b)=>a+(b.price_at_sale*b.qty),0))}</span>
                                    </div>
                                    <div className="flex justify-between items-center">
                                        <span className="text-slate-400">Labor</span>
                                        <span className="font-semibold text-slate-200">{formatLKR(parseFloat(laborCostInput) || 0)}</span>
                                    </div>
                                    <div className="flex justify-between items-center">
                                        <span className="text-slate-400">Taxi</span>
                                        <span className="font-semibold text-slate-200">{formatLKR(parseFloat(taxiCostInput) || 0)}</span>
                                    </div>
                                    <div className="pt-3 border-t border-slate-700/50 flex justify-between items-center text-base font-bold text-indigo-400">
                                        <span>Total +8% VAT</span>
                                        <span>
                                            {formatLKR((parts.reduce((a,b)=>a+(b.price_at_sale*b.qty),0) + (parseFloat(laborCostInput) || 0) + (parseFloat(taxiCostInput) || 0)) * 1.08)}
                                        </span>
                                    </div>
                                </div>
                            </section>
                        </div>
                    </div>
                </div>
            );
        };

        // PRINT VIEW - Invoice & Job Card (Template-aware)
        const PrintView = ({ job, tasks, parts, onBack }) => {
            // Load invoice template from localStorage
            const getTemplate = () => {
                const defaultTemplate = {
                    businessName: 'WORKSHOP PRO',
                    businessTagline: 'Service Center',
                    businessAddress: '',
                    businessPhone: '',
                    businessEmail: '',
                    logoUrl: '',
                    showWorkDone: true,
                    showPartsTable: true,
                    showLaborCharges: true,
                    showTaxiCost: true,
                    showMileage: true,
                    showSubtotal: true,
                    showVat: true,
                    footerTagline: 'Quality Guaranteed',
                    footerMessage: 'Thank you for trusting us with your vehicle.',
                    paymentTerms: '',
                    bankDetails: '',
                    accentColor: '#1e293b',
                    showBorderTop: true
                };
                try {
                    const saved = localStorage.getItem('workshopInvoiceTemplate');
                    if (saved) return { ...defaultTemplate, ...JSON.parse(saved) };
                } catch (e) {}
                return defaultTemplate;
            };

            const getVatRate = () => {
                try {
                    const saved = localStorage.getItem('workshopSettings');
                    if (saved) return JSON.parse(saved).vatRate || 8;
                } catch (e) {}
                return 8;
            };

            const template = getTemplate();
            const vatRate = getVatRate();
            const partsTotal = parts.reduce((a, b) => a + (b.qty * b.price_at_sale), 0);
            const laborTotal = parseFloat(job.labor_cost) || 0;
            const taxiCost = parseFloat(job.taxi_cost) || 0;
            const subtotal = partsTotal + laborTotal + taxiCost;
            const vatAmount = template.showVat ? (subtotal * vatRate / 100) : 0;
            const grandTotal = subtotal + vatAmount;

            return (
                <div className="bg-white min-h-screen text-slate-900">
                    <div className="p-6 flex justify-between items-center no-print bg-slate-100 border-b">
                        <button onClick={onBack} className="text-slate-600 hover:text-slate-900 font-semibold flex items-center gap-2">
                            <span>‚Üê</span> Back to Job
                        </button>
                        <button onClick={() => window.print()} className="bg-indigo-600 hover:bg-indigo-700 text-white px-8 py-3 rounded-lg font-semibold shadow-lg">
                            üñ®Ô∏è Print Invoice
                        </button>
                    </div>
                    
                    <div className={`print-area bg-white p-5 max-w-3xl mx-auto ${template.showBorderTop ? 'border-t-4' : ''}`} style={{ borderColor: template.showBorderTop ? template.accentColor : 'transparent', fontSize: '11px' }}>
                        {/* Header */}
                        <div className="flex justify-between items-start mb-4">
                            <div className="flex items-start gap-3">
                                {template.logoUrl && (
                                    <img src={template.logoUrl} alt="Logo" className="w-12 h-12 object-contain" />
                                )}
                                <div>
                                    <h1 className="text-xl font-bold" style={{ color: template.accentColor }}>{template.businessName}</h1>
                                    {template.businessTagline && <p className="text-[10px] text-slate-400 uppercase font-semibold tracking-wider">{template.businessTagline}</p>}
                                    {template.businessAddress && <p className="text-[10px] text-slate-500 mt-1 whitespace-pre-line leading-tight">{template.businessAddress}</p>}
                                    {(template.businessPhone || template.businessEmail) && (
                                        <p className="text-[10px] text-slate-500">
                                            {template.businessPhone}{template.businessPhone && template.businessEmail ? ' ‚Ä¢ ' : ''}{template.businessEmail}
                                        </p>
                                    )}
                                </div>
                            </div>
                            <div className="text-right">
                                <h2 className="text-base font-bold mb-0.5">INVOICE #{job.job_id}</h2>
                                <p className="text-[11px] text-slate-400">{new Date().toLocaleDateString()}</p>
                            </div>
                        </div>

                        {/* Customer & Vehicle Info - Compact */}
                        <div className="grid grid-cols-2 gap-6 mb-4 pb-3 border-b border-slate-200">
                            <div>
                                <p className="text-[10px] font-semibold text-slate-400 uppercase tracking-wide mb-1">Bill To</p>
                                <p className="text-sm font-semibold text-slate-800">{job.current_owner}</p>
                                <p className="text-[11px] text-slate-500">{job.contact_number}</p>
                            </div>
                            <div>
                                <p className="text-[10px] font-semibold text-slate-400 uppercase tracking-wide mb-1">Vehicle</p>
                                <p className="text-sm font-semibold text-slate-800">{job.license_plate}</p>
                                <p className="text-[11px] text-slate-500">{job.make_model}</p>
                                {template.showMileage && job.mileage_in && (
                                    <p className="text-[10px] text-slate-400 mt-1">
                                        Mileage: {job.mileage_in?.toLocaleString()} km
                                    </p>
                                )}
                            </div>
                        </div>

                        {/* Work Done Section */}
                        {template.showWorkDone && tasks.length > 0 && (
                            <div className="mb-4">
                                <h3 className="text-[10px] font-bold uppercase tracking-wide mb-1" style={{ color: template.accentColor }}>Work Performed</h3>
                                <div className="space-y-0">
                                    {tasks.map(t => (
                                        <div key={t.task_id} className="flex justify-between items-center py-1 border-b border-slate-100">
                                            <span className="text-[11px] text-slate-700">{t.description}</span>
                                            {t.is_completed ? (
                                                <span className="text-[10px] font-semibold text-emerald-600">‚úì</span>
                                            ) : (
                                                <span className="text-[10px] font-semibold text-slate-300">‚óã</span>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* Parts Used Section */}
                        {template.showPartsTable && parts.length > 0 && (
                            <div className="mb-4">
                                <h3 className="text-[10px] font-bold uppercase tracking-wide mb-1" style={{ color: template.accentColor }}>Parts & Materials</h3>
                                <table className="w-full text-left">
                                    <thead style={{ borderColor: template.accentColor }} className="border-b">
                                        <tr className="text-[9px] font-semibold uppercase text-slate-400">
                                            <th className="py-1">Item</th>
                                            <th className="py-1 text-center w-12">Qty</th>
                                            <th className="py-1 text-right w-20">Price</th>
                                            <th className="py-1 text-right w-20">Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {parts.map(p => (
                                            <tr key={p.id} className="border-b border-slate-100 text-[11px]">
                                                <td className="py-1 text-slate-700">{p.part_name}</td>
                                                <td className="py-1 text-center text-slate-600">{p.qty}</td>
                                                <td className="py-1 text-right text-slate-500">{formatLKR(p.price_at_sale)}</td>
                                                <td className="py-1 text-right font-semibold text-slate-800">{formatLKR(p.qty * p.price_at_sale)}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}

                        {/* Labor & Other Charges Section */}
                        {template.showLaborCharges && (laborTotal > 0 || taxiCost > 0) && (
                            <div className="mb-4">
                                <h3 className="text-[10px] font-bold uppercase tracking-wide mb-1" style={{ color: template.accentColor }}>Labor & Other</h3>
                                <table className="w-full text-left">
                                    <thead style={{ borderColor: template.accentColor }} className="border-b">
                                        <tr className="text-[9px] font-semibold uppercase text-slate-400">
                                            <th className="py-1">Description</th>
                                            <th className="py-1 text-right w-20">Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {laborTotal > 0 && (
                                            <tr className="border-b border-slate-100 text-[11px]">
                                                <td className="py-1 text-slate-700">Service Labor</td>
                                                <td className="py-1 text-right font-semibold text-slate-800">{formatLKR(laborTotal)}</td>
                                            </tr>
                                        )}
                                        {template.showTaxiCost && taxiCost > 0 && (
                                            <tr className="border-b border-slate-100 text-[11px]">
                                                <td className="py-1 text-slate-700">Taxi / Transport</td>
                                                <td className="py-1 text-right font-semibold text-slate-800">{formatLKR(taxiCost)}</td>
                                            </tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        )}

                        {/* Totals */}
                        <div className="flex justify-end pt-3 border-t-2" style={{ borderColor: template.accentColor }}>
                            <div className="w-48 space-y-0.5">
                                {template.showSubtotal && (
                                    <>
                                        <div className="flex justify-between text-[11px] text-slate-500">
                                            <span>Parts</span>
                                            <span>{formatLKR(partsTotal)}</span>
                                        </div>
                                        {(laborTotal > 0 || taxiCost > 0) && (
                                            <div className="flex justify-between text-[11px] text-slate-500">
                                                <span>Labor & Other</span>
                                                <span>{formatLKR(laborTotal + (template.showTaxiCost ? taxiCost : 0))}</span>
                                            </div>
                                        )}
                                        <div className="flex justify-between text-[11px] text-slate-600 font-medium pt-1 border-t border-slate-100">
                                            <span>Subtotal</span>
                                            <span>{formatLKR(subtotal)}</span>
                                        </div>
                                    </>
                                )}
                                {template.showVat && (
                                    <div className="flex justify-between text-[11px] text-slate-500">
                                        <span>VAT ({vatRate}%)</span>
                                        <span>{formatLKR(vatAmount)}</span>
                                    </div>
                                )}
                                <div className="flex justify-between text-base font-bold pt-1.5 border-t border-slate-200" style={{ color: template.accentColor }}>
                                    <span>Total Due</span>
                                    <span>{formatLKR(grandTotal)}</span>
                                </div>
                            </div>
                        </div>

                        {/* Bank Details / Payment Info */}
                        {template.bankDetails && (
                            <div className="mt-4 p-3 bg-slate-50 rounded">
                                <h4 className="text-[9px] font-bold text-slate-400 uppercase tracking-wide mb-1">Payment Information</h4>
                                <p className="text-[10px] text-slate-600 whitespace-pre-line leading-snug">{template.bankDetails}</p>
                            </div>
                        )}

                        {/* Payment Terms */}
                        {template.paymentTerms && (
                            <div className="mt-3">
                                <p className="text-[9px] text-slate-400">{template.paymentTerms}</p>
                            </div>
                        )}

                        {/* Footer */}
                        <div className="mt-6 text-center border-t border-slate-100 pt-3">
                            {template.footerTagline && <p className="text-slate-400 text-[9px] font-semibold tracking-widest uppercase mb-0.5">{template.footerTagline}</p>}
                            {template.footerMessage && <p className="text-[9px] text-slate-400">{template.footerMessage}</p>}
                        </div>
                    </div>
                </div>
            );
        };

        // INVENTORY - Parts Management
        const Inventory = ({ onError, showToast }) => {
            const [items, setItems] = useState([]);
            const [showAdd, setShowAdd] = useState(false);
            const [search, setSearch] = useState("");
            const [partPhotoPath, setPartPhotoPath] = useState(null);
            const [partCondition, setPartCondition] = useState('new');
            const [viewingPart, setViewingPart] = useState(null);
            const [editingPart, setEditingPart] = useState(null);
            const [editPartPhotoPath, setEditPartPhotoPath] = useState(null);
            const [viewFilter, setViewFilter] = useState('all'); // 'all' or 'lowStock'
            const [showLowStockExport, setShowLowStockExport] = useState(false);
            
            // Autocomplete states
            const [partNameInput, setPartNameInput] = useState('');
            const [showPartNameDropdown, setShowPartNameDropdown] = useState(false);
            const [categoryInput, setCategoryInput] = useState('');
            const [showCategoryDropdown, setShowCategoryDropdown] = useState(false);
            const partNameRef = useRef();
            const categoryRef = useRef();

            // Load smart lists from localStorage or use defaults
            const getSmartList = (listName, defaultList) => {
                try {
                    const saved = localStorage.getItem('workshopSmartLists');
                    if (saved) {
                        const lists = JSON.parse(saved);
                        if (lists[listName]) return lists[listName];
                    }
                } catch (e) {}
                return defaultList;
            };

            // Default parts and categories lists - load from localStorage
            const defaultPartsList = getSmartList('partNames', [
                'Spark Plugs', 'Engine Oil', 'Oil Filter', 'Air Filter', 'Cabin Air Filter',
                'Transmission Fluid', 'Coolant', 'Brake Fluid', 'Power Steering Fluid',
                'Battery', 'Alternator', 'Starter Motor', 'Water Pump', 'Thermostat',
                'Brake Pads', 'Brake Rotors', 'Brake Shoes', 'Brake Calipers', 'Brake Master Cylinder',
                'Clutch Plate', 'Clutch Kit', 'Flywheel', 'Pressure Plate',
                'CV Axle', 'CV Joint', 'Drive Shaft', 'Wheel Bearing',
                'Shock Absorber', 'Strut', 'Coil Spring', 'Ball Joint', 'Control Arm',
                'Tie Rod End', 'Steering Rack', 'Power Steering Pump',
                'Serpentine Belt', 'Timing Belt', 'Timing Chain', 'Tensioner',
                'Radiator', 'Radiator Hose', 'Heater Core', 'Fan Motor',
                'Turbocharger', 'Intercooler', 'Intake Manifold', 'Exhaust Manifold',
                'Catalytic Converter', 'Muffler', 'Exhaust Pipe', 'Oxygen Sensor',
                'Mass Air Flow Sensor', 'Throttle Body', 'Fuel Pump', 'Fuel Filter', 'Fuel Injector',
                'Ignition Coil', 'Distributor', 'Spark Plug Wires',
                'Headlight', 'Tail Light', 'Fog Light', 'Turn Signal', 'Bulbs',
                'Windshield Wiper Blade', 'Wiper Motor', 'Washer Pump',
                'Door Handle', 'Window Regulator', 'Door Lock Actuator', 'Mirror',
                'AC Compressor', 'Condenser', 'Evaporator', 'Refrigerant',
                'ECU', 'TCM', 'ABS Module', 'Relay', 'Fuse'
            ]);

            const defaultCategories = getSmartList('categories', [
                'Engine', 'Transmission', 'Brakes', 'Suspension', 'Steering',
                'Electrical', 'Cooling System', 'Fuel System', 'Exhaust',
                'Body Parts', 'Interior', 'Lighting', 'AC/HVAC', 'Filters', 'Fluids', 'General'
            ]);

            const load = async () => {
                const res = await callDB('db-query', { sql: "SELECT * FROM inventory ORDER BY part_name" });
                if (res.success) setItems(res.data);
            };

            useEffect(() => { load(); }, []);

            // Click outside to close dropdowns
            useEffect(() => {
                const handleClickOutside = (e) => {
                    if (partNameRef.current && !partNameRef.current.contains(e.target)) setShowPartNameDropdown(false);
                    if (categoryRef.current && !categoryRef.current.contains(e.target)) setShowCategoryDropdown(false);
                };
                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, []);

            // Merge existing parts with defaults for suggestions
            const partNameSuggestions = useMemo(() => {
                const existing = items.map(i => i.part_name);
                const merged = [...new Set([...defaultPartsList, ...existing])].sort();
                if (!partNameInput) return merged.slice(0, 10);
                return merged.filter(p => p.toLowerCase().includes(partNameInput.toLowerCase())).slice(0, 10);
            }, [items, partNameInput]);

            // Merge existing categories with defaults
            const categorySuggestions = useMemo(() => {
                const existing = items.map(i => i.category).filter(Boolean);
                const merged = [...new Set([...defaultCategories, ...existing])].sort();
                if (!categoryInput) return merged;
                return merged.filter(c => c.toLowerCase().includes(categoryInput.toLowerCase()));
            }, [items, categoryInput]);

            const lowStockItems = useMemo(() => {
                return items.filter(i => i.total_quantity <= (i.min_threshold || 5));
            }, [items]);

            const filteredItems = useMemo(() => {
                let filtered = viewFilter === 'lowStock' 
                    ? lowStockItems 
                    : items;
                return filtered.filter(i => 
                    i.part_name.toLowerCase().includes(search.toLowerCase()) || 
                    i.part_number.toLowerCase().includes(search.toLowerCase())
                );
            }, [items, lowStockItems, search, viewFilter]);

            const exportLowStockCSV = () => {
                const headers = ['Part Name', 'Part Number', 'Category', 'Condition', 'Current Qty', 'Min Threshold', 'Price (LKR)'];
                const rows = lowStockItems.map(item => [
                    item.part_name,
                    item.part_number,
                    item.category || 'Uncategorized',
                    item.condition || 'new',
                    item.total_quantity,
                    item.min_threshold || 5,
                    item.retail_price
                ]);
                const csvContent = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `low_stock_report_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
                setShowLowStockExport(false);
            };

            const exportLowStockPDF = () => {
                const printContent = `
                    <html>
                    <head>
                        <title>Low Stock Report</title>
                        <style>
                            body { font-family: Arial, sans-serif; padding: 20px; }
                            h1 { color: #333; border-bottom: 2px solid #dc2626; padding-bottom: 10px; }
                            .date { color: #666; margin-bottom: 20px; }
                            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                            th { background: #dc2626; color: white; padding: 12px; text-align: left; }
                            td { padding: 10px; border-bottom: 1px solid #ddd; }
                            tr:nth-child(even) { background: #f9f9f9; }
                            .low { color: #dc2626; font-weight: bold; }
                            .summary { margin-top: 20px; padding: 15px; background: #fef2f2; border-radius: 8px; }
                        </style>
                    </head>
                    <body>
                        <h1>‚ö†Ô∏è Low Stock Report</h1>
                        <p class="date">Generated: ${new Date().toLocaleString()}</p>
                        <div class="summary">
                            <strong>Total Items Below Threshold:</strong> ${lowStockItems.length} items require restocking
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Part Name</th>
                                    <th>Part Number</th>
                                    <th>Category</th>
                                    <th>Current Qty</th>
                                    <th>Min Threshold</th>
                                    <th>Shortage</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${lowStockItems.map(item => `
                                    <tr>
                                        <td>${item.part_name}</td>
                                        <td>${item.part_number}</td>
                                        <td>${item.category || 'Uncategorized'}</td>
                                        <td class="low">${item.total_quantity}</td>
                                        <td>${item.min_threshold || 5}</td>
                                        <td class="low">-${(item.min_threshold || 5) - item.total_quantity}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </body>
                    </html>
                `;
                const printWindow = window.open('', '_blank');
                printWindow.document.write(printContent);
                printWindow.document.close();
                printWindow.print();
                setShowLowStockExport(false);
            };

            const handlePartPhoto = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (ev) => setPartPhotoPath(ev.target.result);
                    reader.readAsDataURL(file);
                }
            };

            const resetForm = () => {
                setShowAdd(false);
                setPartPhotoPath(null);
                setPartCondition('new');
                setPartNameInput('');
                setCategoryInput('');
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const d = Object.fromEntries(formData.entries());

                // Use state values for autocomplete fields
                d.name = partNameInput;
                d.cat = categoryInput;

                if (!d.name || !d.name.trim()) return alert("Part name is required");
                if (!d.number || !d.number.trim()) return alert("Part number is required");
                if (parseFloat(d.price) < 0) return alert("Price cannot be negative");

                // Upload photo if provided
                let uploadedPhotoPath = null;
                if (partPhotoPath && partPhotoPath.startsWith('data:image')) {
                    const photoRes = await callDB('upload-photo', { base64Data: partPhotoPath });
                    if (photoRes.success) uploadedPhotoPath = photoRes.filePath;
                }

                const existing = items.find(x => x.part_number === d.number);

                if (existing) {
                    // Update existing part - add to quantity
                    await callDB('db-run', {
                        sql: "UPDATE inventory SET total_quantity = total_quantity + ?, retail_price = ?, part_name = ?, category = ?, condition = ?, photo_path = COALESCE(?, photo_path) WHERE part_id = ?",
                        params: [parseInt(d.qty), parseFloat(d.price), d.name, d.cat, partCondition, uploadedPhotoPath, existing.part_id]
                    });
                    resetForm();
                    load();
                } else {
                    const res = await callDB('db-run', {
                        sql: "INSERT INTO inventory (part_name, part_number, total_quantity, avg_cost, retail_price, category, condition, photo_path) VALUES (?, ?, ?, ?, ?, ?, ?, ?)",
                        params: [d.name, d.number, parseInt(d.qty), parseFloat(d.price), parseFloat(d.price), d.cat, partCondition, uploadedPhotoPath]
                    });
                    if (res.success) { 
                        resetForm();
                        load(); 
                    }
                }
            };

            const conditionBadge = (cond) => {
                if (cond === 'reconditioned') {
                    return <span className="bg-yellow-600/20 text-yellow-400 px-2 py-0.5 rounded text-xs font-semibold">Reconditioned</span>;
                }
                return <span className="bg-emerald-600/20 text-emerald-400 px-2 py-0.5 rounded text-xs font-semibold">Brand New</span>;
            };

            return (
                <div className="animate-in fade-in duration-500 space-y-6">
                    <div className="flex justify-between items-start">
                        <div>
                            <h1 className="text-3xl font-bold text-white">Master Inventory</h1>
                            <p className="text-slate-400 text-sm mt-1">Stock & cost management</p>
                        </div>
                        <div className="flex items-center gap-3">
                            {lowStockItems.length > 0 && (
                                <button 
                                    onClick={() => setShowLowStockExport(true)}
                                    className="bg-red-600/20 hover:bg-red-600/30 text-red-400 px-4 py-3 rounded-lg font-semibold text-sm border border-red-500/30 flex items-center gap-2"
                                >
                                    <span>üì•</span> Export Low Stock
                                </button>
                            )}
                            <button onClick={() => setShowAdd(true)} className="bg-slate-900 hover:bg-black text-white px-6 py-3 rounded-lg font-semibold text-sm shadow-lg shadow-slate-500/10">Receive Stock</button>
                        </div>
                    </div>

                    {/* View Filter Tabs */}
                    <div className="flex items-center gap-4">
                        <div className="flex bg-slate-900/50 rounded-lg p-1 border border-slate-700/50">
                            <button 
                                onClick={() => setViewFilter('all')}
                                className={`px-4 py-2 rounded-md text-sm font-semibold transition-all ${viewFilter === 'all' ? 'bg-indigo-600 text-white' : 'text-slate-400 hover:text-white'}`}
                            >
                                All Parts ({items.length})
                            </button>
                            <button 
                                onClick={() => setViewFilter('lowStock')}
                                className={`px-4 py-2 rounded-md text-sm font-semibold transition-all flex items-center gap-2 ${viewFilter === 'lowStock' ? 'bg-red-600 text-white' : 'text-slate-400 hover:text-white'}`}
                            >
                                <span>‚ö†Ô∏è</span> Low Stock ({lowStockItems.length})
                            </button>
                        </div>
                        {viewFilter === 'lowStock' && lowStockItems.length > 0 && (
                            <span className="text-red-400 text-sm">Showing items below minimum threshold</span>
                        )}
                    </div>

                    <div className="relative">
                        <input 
                            placeholder={viewFilter === 'lowStock' ? 'Search low stock parts...' : 'Search parts...'} 
                            className="w-full p-4 bg-slate-900/50 border border-slate-700/50 rounded-lg outline-none focus:border-indigo-500 text-slate-200 placeholder-slate-500"
                            value={search}
                            onChange={e => setSearch(e.target.value)}
                        />
                    </div>

                    <div className="glass-dark rounded-xl border border-slate-700/50 overflow-hidden">
                        <table className="w-full text-left">
                            <thead className="border-b border-slate-700/50 bg-slate-900/30">
                                <tr className="text-xs font-semibold text-slate-400 uppercase">
                                    <th className="p-4">Photo</th>
                                    <th>Description</th>
                                    <th>Condition</th>
                                    <th>Category</th>
                                    <th>Qty</th>
                                    <th>Price</th>
                                    <th className="text-right pr-4">Status</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-700/30">
                                {filteredItems.map(item => (
                                    <tr 
                                        key={item.part_id} 
                                        onClick={() => setViewingPart(item)}
                                        className="hover:bg-slate-800/20 transition-colors cursor-pointer"
                                    >
                                        <td className="p-4">
                                            {item.photo_path ? (
                                                <img 
                                                    src={item.photo_path.startsWith('data:') ? item.photo_path : `file://${item.photo_path.replace(/\\/g, '/')}`} 
                                                    alt={item.part_name}
                                                    className="w-12 h-12 object-cover rounded-lg border border-slate-700/50 hover:border-indigo-500 transition-colors"
                                                    onError={(e) => { e.target.style.display = 'none'; e.target.nextSibling.style.display = 'flex'; }}
                                                />
                                            ) : null}
                                            <div className={`w-12 h-12 bg-slate-800/50 rounded-lg border border-slate-700/50 items-center justify-center text-slate-500 text-xs ${item.photo_path ? 'hidden' : 'flex'}`}>
                                                üì¶
                                            </div>
                                        </td>
                                        <td className="p-4">
                                            <div className="font-semibold text-slate-200">{item.part_name}</div>
                                            <div className="text-xs text-slate-500">{item.part_number}</div>
                                        </td>
                                        <td>{conditionBadge(item.condition)}</td>
                                        <td className="text-xs font-semibold text-slate-400">{item.category || 'Uncategorized'}</td>
                                        <td className="font-bold text-slate-200">{item.total_quantity}</td>
                                        <td className="font-bold text-indigo-400">{formatLKR(item.retail_price)}</td>
                                        <td className="text-right pr-4">
                                            {item.total_quantity <= item.min_threshold ? 
                                                <span className="bg-red-600/20 text-red-400 px-3 py-1 rounded-full text-xs font-semibold">Low Stock</span> :
                                                <span className="bg-emerald-600/20 text-emerald-400 px-3 py-1 rounded-full text-xs font-semibold">Available</span>
                                            }
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>

                    {/* Part Details Modal */}
                    {viewingPart && (
                        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50" onClick={() => setViewingPart(null)}>
                            <div className="max-w-2xl w-full glass-dark rounded-2xl border border-slate-700/50 overflow-hidden" onClick={e => e.stopPropagation()}>
                                {/* Photo Section */}
                                {viewingPart.photo_path && (
                                    <div className="relative">
                                        <img 
                                            src={viewingPart.photo_path.startsWith('data:') ? viewingPart.photo_path : `file://${viewingPart.photo_path.replace(/\\/g, '/')}`} 
                                            alt={viewingPart.part_name}
                                            className="w-full h-64 object-cover"
                                            onError={(e) => { e.target.parentElement.style.display = 'none'; }}
                                        />
                                        <div className="absolute inset-0 bg-gradient-to-t from-slate-900 to-transparent"></div>
                                    </div>
                                )}
                                
                                <div className="p-6 space-y-4">
                                    <div className="flex justify-between items-start">
                                        <div>
                                            <h3 className="text-2xl font-bold text-white">{viewingPart.part_name}</h3>
                                            <p className="text-slate-400 font-mono">{viewingPart.part_number}</p>
                                        </div>
                                        <button onClick={() => setViewingPart(null)} className="text-slate-400 hover:text-white text-2xl">√ó</button>
                                    </div>
                                    
                                    <div className="flex gap-2">
                                        {conditionBadge(viewingPart.condition)}
                                        <span className="bg-slate-700/50 text-slate-300 px-2 py-0.5 rounded text-xs font-semibold">
                                            {viewingPart.category || 'Uncategorized'}
                                        </span>
                                    </div>
                                    
                                    <div className="grid grid-cols-3 gap-4 pt-4 border-t border-slate-700/50">
                                        <div className="text-center p-4 bg-slate-800/30 rounded-lg">
                                            <p className="text-xs text-slate-500 uppercase mb-1">In Stock</p>
                                            <p className="text-2xl font-bold text-white">{viewingPart.total_quantity}</p>
                                        </div>
                                        <div className="text-center p-4 bg-slate-800/30 rounded-lg">
                                            <p className="text-xs text-slate-500 uppercase mb-1">Price</p>
                                            <p className="text-2xl font-bold text-indigo-400">{formatLKR(viewingPart.retail_price)}</p>
                                        </div>
                                        <div className="text-center p-4 bg-slate-800/30 rounded-lg">
                                            <p className="text-xs text-slate-500 uppercase mb-1">Min Stock</p>
                                            <p className="text-2xl font-bold text-slate-300">{viewingPart.min_threshold || 5}</p>
                                        </div>
                                    </div>
                                    
                                    <div className="flex gap-3 pt-4">
                                        <button 
                                            onClick={() => { setEditingPart(viewingPart); setEditPartPhotoPath(viewingPart.photo_path || null); setViewingPart(null); }}
                                            className="flex-1 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-semibold text-sm"
                                        >
                                            ‚úèÔ∏è Edit Part
                                        </button>
                                        <button 
                                            onClick={() => setViewingPart(null)}
                                            className="flex-1 py-3 bg-slate-700/50 hover:bg-slate-600/50 text-slate-300 rounded-lg font-semibold text-sm"
                                        >
                                            Close
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Edit Part Modal */}
                    {editingPart && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-md flex items-center justify-center p-4 z-50">
                            <div className="glass-dark p-6 rounded-2xl w-full max-w-md border border-slate-700/50 max-h-[90vh] overflow-y-auto">
                                <h2 className="text-xl font-bold mb-6 text-white">Edit Part</h2>
                                <div className="space-y-4">
                                    {/* Photo Upload */}
                                    <div>
                                        <label className="block text-xs font-semibold text-slate-400 uppercase mb-2">Part Photo</label>
                                        <div className="flex items-center gap-4">
                                            {editPartPhotoPath ? (
                                                <div className="flex items-center gap-3">
                                                    <div className="relative">
                                                        <img src={editPartPhotoPath.startsWith('data:') ? editPartPhotoPath : `http://localhost:3000${editPartPhotoPath}`} alt="Part preview" className="w-24 h-24 object-cover rounded-lg border border-slate-700/50" />
                                                    </div>
                                                    <div className="flex flex-col gap-2">
                                                        <label className="px-3 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-xs font-semibold cursor-pointer transition-colors flex items-center gap-1">
                                                            <span>üì∑</span> Change
                                                            <input type="file" accept="image/*" onChange={(e) => {
                                                                const file = e.target.files[0];
                                                                if (file) {
                                                                    const reader = new FileReader();
                                                                    reader.onload = (ev) => setEditPartPhotoPath(ev.target.result);
                                                                    reader.readAsDataURL(file);
                                                                }
                                                            }} className="hidden" />
                                                        </label>
                                                        <button 
                                                            type="button"
                                                            onClick={() => setEditPartPhotoPath(null)}
                                                            className="px-3 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg text-xs font-semibold transition-colors flex items-center gap-1"
                                                        ><span>üóëÔ∏è</span> Remove</button>
                                                    </div>
                                                </div>
                                            ) : (
                                                <label className="w-24 h-24 border-2 border-dashed border-slate-600 rounded-lg flex flex-col items-center justify-center cursor-pointer hover:border-indigo-500 transition-colors">
                                                    <span className="text-2xl">üì∑</span>
                                                    <span className="text-xs text-slate-500 mt-1">Upload</span>
                                                    <input type="file" accept="image/*" onChange={(e) => {
                                                        const file = e.target.files[0];
                                                        if (file) {
                                                            const reader = new FileReader();
                                                            reader.onload = (ev) => setEditPartPhotoPath(ev.target.result);
                                                            reader.readAsDataURL(file);
                                                        }
                                                    }} className="hidden" />
                                                </label>
                                            )}
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-semibold text-slate-400 uppercase mb-2">Part Name</label>
                                        <input 
                                            type="text" 
                                            value={editingPart.part_name}
                                            onChange={(e) => setEditingPart({...editingPart, part_name: e.target.value})}
                                            className="w-full px-4 py-3 bg-slate-900/50 border border-slate-700/50 rounded-lg text-white outline-none focus:border-indigo-500"
                                        />
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-xs font-semibold text-slate-400 uppercase mb-2">Price (LKR)</label>
                                            <input 
                                                type="number" 
                                                step="0.01"
                                                value={editingPart.retail_price}
                                                onChange={(e) => setEditingPart({...editingPart, retail_price: parseFloat(e.target.value)})}
                                                className="w-full px-4 py-3 bg-slate-900/50 border border-slate-700/50 rounded-lg text-white outline-none focus:border-indigo-500"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-semibold text-slate-400 uppercase mb-2">Min Stock Alert</label>
                                            <input 
                                                type="number"
                                                value={editingPart.min_threshold || 5}
                                                onChange={(e) => setEditingPart({...editingPart, min_threshold: parseInt(e.target.value)})}
                                                className="w-full px-4 py-3 bg-slate-900/50 border border-slate-700/50 rounded-lg text-white outline-none focus:border-indigo-500"
                                            />
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-semibold text-slate-400 uppercase mb-2">Category</label>
                                        <input 
                                            type="text"
                                            value={editingPart.category || ''}
                                            onChange={(e) => setEditingPart({...editingPart, category: e.target.value})}
                                            className="w-full px-4 py-3 bg-slate-900/50 border border-slate-700/50 rounded-lg text-white outline-none focus:border-indigo-500"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-semibold text-slate-400 uppercase mb-2">Condition</label>
                                        <select 
                                            value={editingPart.condition || 'new'}
                                            onChange={(e) => setEditingPart({...editingPart, condition: e.target.value})}
                                            className="w-full px-4 py-3 bg-slate-900/50 border border-slate-700/50 rounded-lg text-white outline-none focus:border-indigo-500"
                                        >
                                            <option value="new">üÜï Brand New</option>
                                            <option value="reconditioned">üîß Reconditioned</option>
                                        </select>
                                    </div>
                                </div>
                                <div className="flex gap-3 mt-6">
                                    <button 
                                        onClick={() => { setEditingPart(null); setEditPartPhotoPath(null); }}
                                        className="flex-1 py-3 text-slate-400 font-semibold"
                                    >
                                        Cancel
                                    </button>
                                    <button 
                                        onClick={async () => {
                                            // Handle photo upload if new photo was selected
                                            let photoPath = editPartPhotoPath;
                                            if (editPartPhotoPath && editPartPhotoPath.startsWith('data:image')) {
                                                const photoRes = await callDB('upload-photo', { base64Data: editPartPhotoPath });
                                                if (photoRes.success) {
                                                    photoPath = photoRes.path;
                                                }
                                            }
                                            
                                            await callDB('db-run', {
                                                sql: "UPDATE inventory SET part_name = ?, retail_price = ?, min_threshold = ?, category = ?, condition = ?, photo_path = ? WHERE part_id = ?",
                                                params: [editingPart.part_name, editingPart.retail_price, editingPart.min_threshold || 5, editingPart.category, editingPart.condition, photoPath, editingPart.part_id]
                                            });
                                            setEditingPart(null);
                                            setEditPartPhotoPath(null);
                                            load();
                                        }}
                                        className="flex-1 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-semibold"
                                    >
                                        Save Changes
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showAdd && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-md flex items-center justify-center p-4 z-50">
                            <form onSubmit={handleSubmit} className="glass-dark p-8 rounded-2xl w-full max-w-xl border border-slate-700/50 max-h-[90vh] overflow-y-auto">
                                <h2 className="text-2xl font-bold mb-6 text-white">Add Stock</h2>
                                
                                {/* Photo Upload */}
                                <div className="mb-6">
                                    <label className="block text-xs font-semibold text-slate-400 uppercase tracking-wide mb-2">Part Photo (Optional)</label>
                                    <div className="flex items-center gap-4">
                                        {partPhotoPath ? (
                                            <div className="relative">
                                                <img src={partPhotoPath} alt="Part preview" className="w-24 h-24 object-cover rounded-lg border border-slate-700/50" />
                                                <button 
                                                    type="button"
                                                    onClick={() => setPartPhotoPath(null)}
                                                    className="absolute -top-2 -right-2 bg-red-600 text-white rounded-full w-6 h-6 text-xs font-bold"
                                                >√ó</button>
                                            </div>
                                        ) : (
                                            <label className="w-24 h-24 border-2 border-dashed border-slate-600 rounded-lg flex flex-col items-center justify-center cursor-pointer hover:border-indigo-500 transition-colors">
                                                <span className="text-2xl">üì∑</span>
                                                <span className="text-xs text-slate-500 mt-1">Upload</span>
                                                <input type="file" accept="image/*" onChange={handlePartPhoto} className="hidden" />
                                            </label>
                                        )}
                                    </div>
                                </div>

                                <div className="grid grid-cols-2 gap-4">
                                    {/* Part Name with Autocomplete */}
                                    <div className="flex flex-col relative" ref={partNameRef}>
                                        <label className="text-xs font-semibold text-slate-400 uppercase tracking-wide mb-2">Part Name</label>
                                        <input 
                                            type="text"
                                            value={partNameInput}
                                            onChange={(e) => { setPartNameInput(e.target.value); setShowPartNameDropdown(true); }}
                                            onFocus={() => setShowPartNameDropdown(true)}
                                            placeholder="e.g., Oil Filter"
                                            className="px-4 py-3 bg-slate-900/50 border border-slate-700/50 rounded-lg text-slate-200 outline-none focus:border-indigo-500"
                                            required
                                        />
                                        {showPartNameDropdown && partNameSuggestions.length > 0 && (
                                            <div className="absolute top-full left-0 right-0 bg-slate-800 border border-slate-700 rounded-lg mt-1 z-20 max-h-48 overflow-y-auto shadow-lg">
                                                {partNameSuggestions.map(part => (
                                                    <button 
                                                        key={part} 
                                                        type="button" 
                                                        onClick={() => { setPartNameInput(part); setShowPartNameDropdown(false); }}
                                                        className="w-full text-left px-4 py-2 text-slate-200 hover:bg-indigo-600/30 transition-colors text-sm border-b border-slate-700/30 last:border-b-0"
                                                    >
                                                        {part}
                                                    </button>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                    <Input label="Part Number" name="number" required />
                                </div>
                                
                                <div className="grid grid-cols-2 gap-4 mt-4">
                                    <div className="flex flex-col">
                                        <label className="text-xs font-semibold text-slate-400 uppercase tracking-wide mb-2">Condition</label>
                                        <select 
                                            value={partCondition}
                                            onChange={(e) => setPartCondition(e.target.value)}
                                            className="px-4 py-3 bg-slate-900/50 border border-slate-700/50 rounded-lg text-slate-200 outline-none focus:border-indigo-500"
                                        >
                                            <option value="new">üÜï Brand New</option>
                                            <option value="reconditioned">üîß Reconditioned</option>
                                        </select>
                                    </div>
                                    {/* Category with Autocomplete */}
                                    <div className="flex flex-col relative" ref={categoryRef}>
                                        <label className="text-xs font-semibold text-slate-400 uppercase tracking-wide mb-2">Category</label>
                                        <input 
                                            type="text"
                                            value={categoryInput}
                                            onChange={(e) => { setCategoryInput(e.target.value); setShowCategoryDropdown(true); }}
                                            onFocus={() => setShowCategoryDropdown(true)}
                                            placeholder="e.g., Filters"
                                            className="px-4 py-3 bg-slate-900/50 border border-slate-700/50 rounded-lg text-slate-200 outline-none focus:border-indigo-500"
                                        />
                                        {showCategoryDropdown && categorySuggestions.length > 0 && (
                                            <div className="absolute top-full left-0 right-0 bg-slate-800 border border-slate-700 rounded-lg mt-1 z-20 max-h-48 overflow-y-auto shadow-lg">
                                                {categorySuggestions.map(cat => (
                                                    <button 
                                                        key={cat} 
                                                        type="button" 
                                                        onClick={() => { setCategoryInput(cat); setShowCategoryDropdown(false); }}
                                                        className="w-full text-left px-4 py-2 text-slate-200 hover:bg-indigo-600/30 transition-colors text-sm border-b border-slate-700/30 last:border-b-0"
                                                    >
                                                        {cat}
                                                    </button>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                </div>
                                
                                <div className="grid grid-cols-2 gap-4 mt-4">
                                    <Input label="Quantity" name="qty" type="number" required defaultValue="1" />
                                    <Input label="Price (LKR)" name="price" type="number" step="0.01" required />
                                </div>
                                <p className="text-xs text-slate-500 mt-2">üí° Price can be adjusted when adding parts to a job</p>
                                
                                <div className="flex gap-3 mt-8">
                                    <button type="button" onClick={resetForm} className="flex-1 py-3 font-semibold text-slate-400">Cancel</button>
                                    <button type="submit" className="flex-1 py-3 bg-slate-900 text-white rounded-lg font-semibold">Save</button>
                                </div>
                            </form>
                        </div>
                    )}

                    {/* Low Stock Export Modal */}
                    {showLowStockExport && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-md flex items-center justify-center p-4 z-50">
                            <div className="glass-dark p-6 rounded-2xl w-full max-w-md border border-slate-700/50">
                                <div className="flex items-center gap-3 mb-6">
                                    <span className="text-3xl">‚ö†Ô∏è</span>
                                    <div>
                                        <h2 className="text-xl font-bold text-white">Export Low Stock Report</h2>
                                        <p className="text-slate-400 text-sm">{lowStockItems.length} items below threshold</p>
                                    </div>
                                </div>
                                
                                <div className="space-y-3 mb-6">
                                    <div className="p-4 bg-slate-900/50 rounded-xl border border-slate-700/50">
                                        <div className="flex items-center justify-between mb-2">
                                            <span className="font-semibold text-white">üìÑ CSV Spreadsheet</span>
                                        </div>
                                        <p className="text-xs text-slate-400 mb-3">Export to Excel/Google Sheets for procurement tracking</p>
                                        <button 
                                            onClick={exportLowStockCSV}
                                            className="w-full py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg font-semibold text-sm transition-colors"
                                        >
                                            Download CSV
                                        </button>
                                    </div>
                                    
                                    <div className="p-4 bg-slate-900/50 rounded-xl border border-slate-700/50">
                                        <div className="flex items-center justify-between mb-2">
                                            <span className="font-semibold text-white">üñ®Ô∏è Print / PDF</span>
                                        </div>
                                        <p className="text-xs text-slate-400 mb-3">Generate printable report for suppliers</p>
                                        <button 
                                            onClick={exportLowStockPDF}
                                            className="w-full py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-semibold text-sm transition-colors"
                                        >
                                            Print Report
                                        </button>
                                    </div>
                                </div>

                                {/* Preview of low stock items */}
                                <div className="max-h-48 overflow-y-auto mb-4">
                                    <p className="text-xs font-semibold text-slate-400 uppercase mb-2">Items in Report:</p>
                                    <div className="space-y-1">
                                        {lowStockItems.slice(0, 10).map((item, i) => (
                                            <div key={i} className="flex justify-between items-center text-sm py-1 border-b border-slate-700/30">
                                                <span className="text-slate-300 truncate">{item.part_name}</span>
                                                <span className="text-red-400 font-mono ml-2">{item.total_quantity}/{item.min_threshold || 5}</span>
                                            </div>
                                        ))}
                                        {lowStockItems.length > 10 && (
                                            <p className="text-xs text-slate-500 pt-1">...and {lowStockItems.length - 10} more items</p>
                                        )}
                                    </div>
                                </div>
                                
                                <button 
                                    onClick={() => setShowLowStockExport(false)}
                                    className="w-full py-3 text-slate-400 font-semibold hover:text-white transition-colors"
                                >
                                    Close
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // COMPLETED JOBS - View all finished jobs
        const CompletedJobs = ({ onOpenJob }) => {
            const [jobs, setJobs] = useState([]);
            const [searchTerm, setSearchTerm] = useState('');

            const load = async () => {
                const res = await callDB('db-query', { 
                    sql: `SELECT j.*, v.license_plate, v.make_model, 
                          COALESCE(j.owner_name, 
                            (SELECT oh.old_owner FROM ownership_history oh 
                             WHERE oh.vehicle_id = j.vehicle_id AND oh.transfer_date > j.created_at 
                             ORDER BY oh.transfer_date ASC LIMIT 1),
                            v.current_owner) as current_owner, 
                          u.full_name as tech_name
                          FROM jobs j 
                          JOIN vehicles v ON j.vehicle_id = v.vehicle_id 
                          LEFT JOIN users u ON j.technician_id = u.user_id
                          WHERE j.status = 'completed' 
                          ORDER BY j.completion_date DESC` 
                });
                if (res.success) setJobs(res.data);
            };

            useEffect(() => { load(); }, []);

            const filteredJobs = searchTerm 
                ? jobs.filter(j => 
                    j.license_plate?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    j.make_model?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    j.current_owner?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    String(j.job_id).includes(searchTerm)
                  )
                : jobs;

            return (
                <div className="animate-in fade-in duration-500 space-y-6">
                    <div className="flex justify-between items-start">
                        <div>
                            <h1 className="text-3xl font-bold text-white">Completed Jobs</h1>
                            <p className="text-slate-400 text-sm mt-1">{jobs.length} jobs completed</p>
                        </div>
                        <div className="relative">
                            <input 
                                type="text" 
                                placeholder="Search jobs..." 
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                                className="pl-10 pr-4 py-3 bg-slate-800/50 border border-slate-700/50 rounded-lg text-white text-sm w-64 focus:outline-none focus:border-indigo-500"
                            />
                            <span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">üîç</span>
                        </div>
                    </div>

                    <div className="glass-dark rounded-xl border border-slate-700/50 overflow-hidden">
                        <table className="w-full text-left">
                            <thead className="border-b border-slate-700/50 bg-slate-900/30">
                                <tr className="text-xs font-semibold text-slate-400 uppercase">
                                    <th className="p-4">Job #</th>
                                    <th>Vehicle</th>
                                    <th>Owner</th>
                                    <th>Technician</th>
                                    <th>Completed</th>
                                    <th className="text-right">Total</th>
                                    <th className="text-right pr-4">Action</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-700/30">
                                {filteredJobs.map(j => (
                                    <tr 
                                        key={j.job_id} 
                                        onClick={() => onOpenJob(j.job_id)}
                                        className="hover:bg-slate-800/30 transition-colors cursor-pointer"
                                    >
                                        <td className="p-4">
                                            <span className="font-mono text-indigo-400">#{j.job_id}</span>
                                        </td>
                                        <td>
                                            <div className="font-semibold text-white">{j.license_plate}</div>
                                            <div className="text-xs text-slate-500">{j.make_model}</div>
                                        </td>
                                        <td className="text-slate-300">{j.current_owner || '-'}</td>
                                        <td className="text-slate-300">{j.tech_name || '-'}</td>
                                        <td className="text-slate-400 text-sm">{formatDateSL(j.completion_date)}</td>
                                        <td className="text-right font-bold text-emerald-400">{formatLKR(j.total_price || 0)}</td>
                                        <td className="text-right pr-4">
                                            <button
                                                onClick={async (e) => {
                                                    e.stopPropagation();
                                                    if (confirm(`Reopen Job #${j.job_id}? It will be set back to "In Progress" status.`)) {
                                                        const res = await callDB('db-run', {
                                                            sql: "UPDATE jobs SET status = 'in-progress', completion_date = NULL WHERE job_id = ?",
                                                            params: [j.job_id]
                                                        });
                                                        if (res.success) load();
                                                        else alert('Failed to reopen job: ' + res.error);
                                                    }
                                                }}
                                                className="bg-amber-600/20 hover:bg-amber-600/40 text-amber-400 hover:text-amber-300 px-3 py-1 rounded font-semibold text-xs transition-colors"
                                            >
                                                üîÑ Reopen
                                            </button>
                                        </td>
                                    </tr>
                                ))}
                                {filteredJobs.length === 0 && (
                                    <tr><td colSpan="7" className="p-8 text-center text-slate-400">
                                        {searchTerm ? 'No jobs match your search.' : 'No completed jobs yet.'}
                                    </td></tr>
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // VEHICLE SEARCH - Search vehicles by license plate and view history
        const VehicleSearch = ({ onOpenJob }) => {
            const [searchTerm, setSearchTerm] = useState('');
            const [filterMake, setFilterMake] = useState('');
            const [filterYear, setFilterYear] = useState('');
            const [filterOwner, setFilterOwner] = useState('');
            const [filterStatus, setFilterStatus] = useState('');
            const [vehicles, setVehicles] = useState([]);
            const [allVehicles, setAllVehicles] = useState([]);
            const [selectedVehicle, setSelectedVehicle] = useState(null);
            const [vehicleJobs, setVehicleJobs] = useState([]);
            const [ownerHistory, setOwnerHistory] = useState([]);
            const [uniqueMakes, setUniqueMakes] = useState([]);
            const [uniqueYears, setUniqueYears] = useState([]);

            // Load all vehicles on mount
            useEffect(() => {
                const loadAllVehicles = async () => {
                    const res = await callDB('db-query', {
                        sql: `SELECT v.*, 
                              (SELECT COUNT(*) FROM jobs j WHERE j.vehicle_id = v.vehicle_id) as job_count,
                              (SELECT j.status FROM jobs j WHERE j.vehicle_id = v.vehicle_id ORDER BY j.created_at DESC LIMIT 1) as last_job_status
                              FROM vehicles v ORDER BY v.license_plate`
                    });
                    if (res.success) {
                        setAllVehicles(res.data);
                        setVehicles(res.data);
                        
                        // Extract unique makes
                        const makes = [...new Set(res.data.map(v => {
                            const parts = v.make_model?.split(' ') || [];
                            return parts[0] || '';
                        }).filter(m => m))].sort();
                        setUniqueMakes(makes);
                        
                        // Extract unique years (from make_model if present, e.g., "Peugeot 308 2019")
                        const years = [...new Set(res.data.map(v => {
                            const match = v.make_model?.match(/\b(19|20)\d{2}\b/);
                            return match ? match[0] : '';
                        }).filter(y => y))].sort().reverse();
                        setUniqueYears(years);
                    }
                };
                loadAllVehicles();
            }, []);

            // Filter vehicles based on search term and filters
            useEffect(() => {
                let filtered = allVehicles;
                
                // Filter by license plate search
                if (searchTerm.length >= 1) {
                    filtered = filtered.filter(v => 
                        v.license_plate?.toUpperCase().includes(searchTerm.toUpperCase())
                    );
                }
                
                // Filter by make
                if (filterMake) {
                    filtered = filtered.filter(v => 
                        v.make_model?.toLowerCase().startsWith(filterMake.toLowerCase())
                    );
                }
                
                // Filter by year
                if (filterYear) {
                    filtered = filtered.filter(v => 
                        v.make_model?.includes(filterYear)
                    );
                }
                
                // Filter by owner name
                if (filterOwner.length >= 2) {
                    filtered = filtered.filter(v => 
                        v.current_owner?.toLowerCase().includes(filterOwner.toLowerCase())
                    );
                }
                
                // Filter by last job status
                if (filterStatus) {
                    filtered = filtered.filter(v => v.last_job_status === filterStatus);
                }
                
                setVehicles(filtered);
            }, [searchTerm, filterMake, filterYear, filterOwner, filterStatus, allVehicles]);

            const clearFilters = () => {
                setSearchTerm('');
                setFilterMake('');
                setFilterYear('');
                setFilterOwner('');
                setFilterStatus('');
            };

            const loadVehicleHistory = async (vehicle) => {
                setSelectedVehicle(vehicle);
                
                // Load all jobs for this vehicle
                const jobsRes = await callDB('db-query', {
                    sql: `SELECT j.*, u.full_name as tech_name 
                          FROM jobs j 
                          LEFT JOIN users u ON j.technician_id = u.user_id
                          WHERE j.vehicle_id = ? 
                          ORDER BY j.created_at DESC`,
                    params: [vehicle.vehicle_id]
                });
                if (jobsRes.success) setVehicleJobs(jobsRes.data);

                // Load ownership history
                const ownerRes = await callDB('db-query', {
                    sql: `SELECT * FROM ownership_history WHERE vehicle_id = ? ORDER BY transfer_date DESC`,
                    params: [vehicle.vehicle_id]
                });
                if (ownerRes.success) setOwnerHistory(ownerRes.data);
            };

            const statuses = {
                'pending': { label: 'Pending', color: 'bg-yellow-500/20 text-yellow-300' },
                'in-progress': { label: 'In Progress', color: 'bg-blue-500/20 text-blue-300' },
                'completed': { label: 'Completed', color: 'bg-emerald-500/20 text-emerald-300' }
            };

            return (
                <div className="animate-in fade-in duration-500 space-y-6">
                    <div>
                        <h1 className="text-3xl font-bold text-white">Vehicle Search</h1>
                        <p className="text-slate-400 text-sm mt-1">Browse all vehicles or use filters to narrow down results</p>
                    </div>

                    {/* Search & Filter Controls */}
                    <div className="glass-dark rounded-xl p-4 border border-slate-700/50 space-y-4">
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                            {/* License Plate Search */}
                            <div className="lg:col-span-2">
                                <label className="block text-xs font-semibold text-slate-400 uppercase mb-1">License Plate</label>
                                <div className="relative">
                                    <input 
                                        type="text" 
                                        placeholder="Search plate..." 
                                        value={searchTerm}
                                        onChange={(e) => { setSearchTerm(e.target.value.toUpperCase()); setSelectedVehicle(null); }}
                                        className="w-full pl-10 pr-4 py-2.5 bg-slate-800/50 border border-slate-700/50 rounded-lg text-white font-mono focus:outline-none focus:border-indigo-500"
                                    />
                                    <span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500">üîç</span>
                                </div>
                            </div>
                            
                            {/* Make Filter */}
                            <div>
                                <label className="block text-xs font-semibold text-slate-400 uppercase mb-1">Make</label>
                                <select 
                                    value={filterMake}
                                    onChange={(e) => setFilterMake(e.target.value)}
                                    className="w-full py-2.5 px-3 bg-slate-800/50 border border-slate-700/50 rounded-lg text-white focus:outline-none focus:border-indigo-500"
                                >
                                    <option value="">All Makes</option>
                                    {uniqueMakes.map(m => (
                                        <option key={m} value={m}>{m}</option>
                                    ))}
                                </select>
                            </div>
                            
                            {/* Year Filter */}
                            <div>
                                <label className="block text-xs font-semibold text-slate-400 uppercase mb-1">Year</label>
                                <select 
                                    value={filterYear}
                                    onChange={(e) => setFilterYear(e.target.value)}
                                    className="w-full py-2.5 px-3 bg-slate-800/50 border border-slate-700/50 rounded-lg text-white focus:outline-none focus:border-indigo-500"
                                >
                                    <option value="">All Years</option>
                                    {uniqueYears.map(y => (
                                        <option key={y} value={y}>{y}</option>
                                    ))}
                                </select>
                            </div>
                            
                            {/* Status Filter */}
                            <div>
                                <label className="block text-xs font-semibold text-slate-400 uppercase mb-1">Last Job Status</label>
                                <select 
                                    value={filterStatus}
                                    onChange={(e) => setFilterStatus(e.target.value)}
                                    className="w-full py-2.5 px-3 bg-slate-800/50 border border-slate-700/50 rounded-lg text-white focus:outline-none focus:border-indigo-500"
                                >
                                    <option value="">All Statuses</option>
                                    <option value="pending">Pending</option>
                                    <option value="in-progress">In Progress</option>
                                    <option value="completed">Completed</option>
                                </select>
                            </div>
                        </div>
                        
                        {/* Owner Search & Clear */}
                        <div className="flex gap-4 items-end">
                            <div className="flex-1 max-w-xs">
                                <label className="block text-xs font-semibold text-slate-400 uppercase mb-1">Owner Name</label>
                                <input 
                                    type="text" 
                                    placeholder="Search by owner..." 
                                    value={filterOwner}
                                    onChange={(e) => setFilterOwner(e.target.value)}
                                    className="w-full py-2.5 px-3 bg-slate-800/50 border border-slate-700/50 rounded-lg text-white focus:outline-none focus:border-indigo-500"
                                />
                            </div>
                            <button 
                                onClick={clearFilters}
                                className="px-4 py-2.5 text-slate-400 hover:text-white hover:bg-slate-700/50 rounded-lg transition-colors text-sm font-semibold"
                            >
                                ‚úï Clear Filters
                            </button>
                            <div className="text-sm text-slate-400">
                                Showing <span className="text-white font-semibold">{vehicles.length}</span> of <span className="text-white">{allVehicles.length}</span> vehicles
                            </div>
                        </div>
                    </div>

                    {/* Vehicle List */}
                    {!selectedVehicle && vehicles.length > 0 && (
                        <div className="glass-dark rounded-xl border border-slate-700/50 overflow-hidden">
                            <table className="w-full text-left">
                                <thead className="border-b border-slate-700/50 bg-slate-900/30">
                                    <tr className="text-xs font-semibold text-slate-400 uppercase">
                                        <th className="p-4">License Plate</th>
                                        <th>Make / Model</th>
                                        <th>Owner</th>
                                        <th>Contact</th>
                                        <th className="text-center">Jobs</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-700/30">
                                    {vehicles.map(v => (
                                        <tr 
                                            key={v.vehicle_id}
                                            onClick={() => loadVehicleHistory(v)}
                                            className="hover:bg-indigo-600/10 transition-colors cursor-pointer"
                                        >
                                            <td className="p-4">
                                                <span className="text-lg font-bold text-white font-mono">{v.license_plate}</span>
                                            </td>
                                            <td className="text-slate-300">{v.make_model || '-'}</td>
                                            <td className="text-slate-300">{v.current_owner || '-'}</td>
                                            <td className="text-slate-400 text-sm">{v.contact_number || '-'}</td>
                                            <td className="text-center">
                                                <span className="text-indigo-400 font-semibold">{v.job_count || 0}</span>
                                            </td>
                                            <td>
                                                {v.last_job_status ? (
                                                    <span className={`text-xs font-semibold px-2 py-1 rounded ${statuses[v.last_job_status]?.color || 'bg-slate-700/30 text-slate-300'}`}>
                                                        {statuses[v.last_job_status]?.label || v.last_job_status}
                                                    </span>
                                                ) : (
                                                    <span className="text-slate-500 text-xs">No jobs</span>
                                                )}
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}

                    {!selectedVehicle && vehicles.length === 0 && allVehicles.length > 0 && (
                        <div className="glass-dark rounded-xl p-8 text-center border border-slate-700/50">
                            <p className="text-slate-400">No vehicles match your filters</p>
                            <button onClick={clearFilters} className="mt-2 text-indigo-400 hover:text-indigo-300 font-semibold text-sm">Clear all filters</button>
                        </div>
                    )}
                    
                    {!selectedVehicle && allVehicles.length === 0 && (
                        <div className="glass-dark rounded-xl p-8 text-center border border-slate-700/50">
                            <p className="text-slate-400">No vehicles in the system yet</p>
                        </div>
                    )}

                    {/* Vehicle Details & History */}
                    {selectedVehicle && (
                        <div className="space-y-6">
                            <button 
                                onClick={() => setSelectedVehicle(null)} 
                                className="text-indigo-400 hover:text-indigo-300 font-semibold text-sm"
                            >
                                ‚Üê Back to search results
                            </button>

                            {/* Vehicle Info Card */}
                            <div className="glass-dark rounded-xl p-6 border border-slate-700/50">
                                <div className="flex items-start gap-6">
                                    {selectedVehicle.photo_path && (
                                        <img 
                                            src={`file://${selectedVehicle.photo_path}`} 
                                            alt="Vehicle" 
                                            className="w-32 h-32 object-cover rounded-lg border border-slate-700/50"
                                        />
                                    )}
                                    <div className="flex-1">
                                        <h2 className="text-3xl font-bold text-white font-mono">{selectedVehicle.license_plate}</h2>
                                        <p className="text-xl text-slate-400 mt-1">{selectedVehicle.make_model}</p>
                                        <div className="grid grid-cols-2 gap-4 mt-4 text-sm">
                                            <div>
                                                <span className="text-slate-500">Owner:</span>
                                                <span className="text-white ml-2">{selectedVehicle.current_owner || '-'}</span>
                                            </div>
                                            <div>
                                                <span className="text-slate-500">Contact:</span>
                                                <span className="text-white ml-2">{selectedVehicle.contact_number || '-'}</span>
                                            </div>
                                            <div>
                                                <span className="text-slate-500">VIN:</span>
                                                <span className="text-white ml-2 font-mono">{selectedVehicle.vin || '-'}</span>
                                            </div>
                                            <div>
                                                <span className="text-slate-500">Total Jobs:</span>
                                                <span className="text-white ml-2">{vehicleJobs.length}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* Service History */}
                            <div className="glass-dark rounded-xl border border-slate-700/50 overflow-hidden">
                                <div className="p-4 border-b border-slate-700/50 bg-slate-900/30">
                                    <h3 className="text-lg font-bold text-white">Service History</h3>
                                </div>
                                <table className="w-full text-left">
                                    <thead className="border-b border-slate-700/50 bg-slate-900/20">
                                        <tr className="text-xs font-semibold text-slate-400 uppercase">
                                            <th className="p-4">Job #</th>
                                            <th>Date</th>
                                            <th>Status</th>
                                            <th>Mileage</th>
                                            <th>Technician</th>
                                            <th className="text-right pr-4">Total</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-700/30">
                                        {vehicleJobs.map(j => (
                                            <tr 
                                                key={j.job_id} 
                                                onClick={() => onOpenJob(j.job_id)}
                                                className="hover:bg-slate-800/30 transition-colors cursor-pointer"
                                            >
                                                <td className="p-4 font-mono text-indigo-400">#{j.job_id}</td>
                                                <td className="text-slate-300">{formatDateSL(j.created_at)}</td>
                                                <td>
                                                    <span className={`text-xs font-semibold px-2 py-1 rounded ${statuses[j.status]?.color || 'bg-slate-700/30 text-slate-300'}`}>
                                                        {statuses[j.status]?.label || j.status}
                                                    </span>
                                                </td>
                                                <td className="text-slate-300">{j.mileage_in?.toLocaleString() || '-'} km</td>
                                                <td className="text-slate-300">{j.tech_name || '-'}</td>
                                                <td className="text-right pr-4 font-bold text-emerald-400">{formatLKR(j.total_price || 0)}</td>
                                            </tr>
                                        ))}
                                        {vehicleJobs.length === 0 && (
                                            <tr><td colSpan="6" className="p-8 text-center text-slate-400">No service history found.</td></tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>

                            {/* Ownership History */}
                            {ownerHistory.length > 0 && (
                                <div className="glass-dark rounded-xl border border-slate-700/50 overflow-hidden">
                                    <div className="p-4 border-b border-slate-700/50 bg-slate-900/30">
                                        <h3 className="text-lg font-bold text-white">Ownership History</h3>
                                    </div>
                                    <div className="p-4 space-y-3">
                                        {ownerHistory.map((h, i) => (
                                            <div key={h.history_id} className="flex items-center gap-4 text-sm">
                                                <span className="text-slate-500">{formatDateSL(h.transfer_date)}</span>
                                                <span className="text-slate-400">{h.old_owner || 'N/A'}</span>
                                                <span className="text-indigo-400">‚Üí</span>
                                                <span className="text-white font-semibold">{h.new_owner}</span>
                                                {h.mileage_at_transfer && (
                                                    <span className="text-slate-500 text-xs ml-auto">@ {h.mileage_at_transfer?.toLocaleString()} km</span>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        // REPORTS - Financial Reporting
        const Reports = ({ onError }) => {
            const [data, setData] = useState([]);
            
            const load = async () => {
                const res = await callDB('db-query', { sql: "SELECT j.*, v.make_model, v.license_plate FROM jobs j JOIN vehicles v ON j.vehicle_id = v.vehicle_id WHERE j.status = 'completed' ORDER BY j.created_at DESC" });
                if (res.success) setData(res.data);
            };

            useEffect(() => { load(); }, []);

            const exportCSV = () => {
                const header = ["Date", "Job", "Vehicle", "Plate", "Revenue"];
                const rows = data.map(j => [new Date(j.created_at).toLocaleDateString(), j.job_id, j.make_model, j.license_plate, j.total_price || 0]);
                const csvContent = "data:text/csv;charset=utf-8," + [header, ...rows].map(e => e.join(",")).join("\n");
                const link = document.createElement("a");
                link.setAttribute("href", encodeURI(csvContent));
                link.setAttribute("download", `workshop_report_${new Date().toISOString().split('T')[0]}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const totalRev = data.reduce((a,b) => a + (b.total_price || 0), 0);

            return (
                <div className="animate-in fade-in duration-500 space-y-6">
                    <div className="flex justify-between items-start">
                        <div>
                            <h1 className="text-3xl font-bold text-white">Business Reports</h1>
                            <p className="text-slate-400 text-sm mt-1">Financial performance</p>
                        </div>
                        <button onClick={exportCSV} className="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-3 rounded-lg font-semibold text-sm shadow-lg shadow-emerald-500/20">Export CSV</button>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div className="glass-dark p-6 rounded-xl border-t-2 border-indigo-500">
                            <p className="text-xs font-semibold text-slate-400 uppercase mb-2">Total Revenue</p>
                            <p className="text-3xl font-bold text-white">{formatLKR(totalRev)}</p>
                        </div>
                        <div className="glass-dark p-6 rounded-xl border-t-2 border-emerald-500">
                            <p className="text-xs font-semibold text-slate-400 uppercase mb-2">Jobs Completed</p>
                            <p className="text-3xl font-bold text-white">{data.length}</p>
                        </div>
                        <div className="glass-dark p-6 rounded-xl border-t-2 border-yellow-500">
                            <p className="text-xs font-semibold text-slate-400 uppercase mb-2">Avg Ticket Value</p>
                            <p className="text-3xl font-bold text-white">{formatLKR(data.length ? (totalRev/data.length) : 0)}</p>
                        </div>
                    </div>

                    <div className="glass-dark rounded-xl border border-slate-700/50 overflow-hidden">
                        <table className="w-full text-left">
                            <thead className="border-b border-slate-700/50 bg-slate-900/30">
                                <tr className="text-xs font-semibold text-slate-400 uppercase">
                                    <th className="p-4">Date</th>
                                    <th>Vehicle & Job</th>
                                    <th className="text-right pr-4">Revenue</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-700/30">
                                {data.map(j => (
                                    <tr key={j.job_id} className="hover:bg-slate-800/20 transition-colors">
                                        <td className="p-4 font-semibold text-slate-400">{new Date(j.created_at).toLocaleDateString()}</td>
                                        <td>
                                            <div className="font-semibold text-slate-200">{j.make_model}</div>
                                            <div className="text-xs text-slate-500">{j.license_plate} ‚Ä¢ Job #{j.job_id}</div>
                                        </td>
                                        <td className="text-right pr-4 font-bold text-emerald-400">{formatLKR(j.total_price || 0)}</td>
                                    </tr>
                                ))}
                                {data.length === 0 && <tr><td colSpan="3" className="p-8 text-center text-slate-400">No completed jobs yet.</td></tr>}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // SETTINGS PAGE - Manage all app settings
        const Settings = ({ showToast }) => {
            const [activeTab, setActiveTab] = useState('technicians');
            const [technicians, setTechnicians] = useState([]);
            const [editingTech, setEditingTech] = useState(null);
            const [showTechModal, setShowTechModal] = useState(false);
            const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
            const [deletingTechId, setDeletingTechId] = useState(null);
            
            // Business settings
            const [businessSettings, setBusinessSettings] = useState({
                shopName: 'Workshop Pro',
                overdueThresholdDays: 3,
                defaultLaborRate: 1500,
                defaultMinStock: 5,
                vatRate: 8
            });

            // Smart Lists state
            const [selectedList, setSelectedList] = useState('peugeotModels');
            const [listSearch, setListSearch] = useState('');
            const [editingItem, setEditingItem] = useState(null);
            const [editingItemValue, setEditingItemValue] = useState('');
            const [newItemValue, setNewItemValue] = useState('');
            const csvInputRef = useRef(null);
            
            // Default lists
            const defaultSmartLists = {
                peugeotModels: [
                    '106', '107', '108', '206', '207', '208', '306', '307', '308',
                    '405', '406', '407', '505', '508', '605', '607', '806', '807',
                    '2008', '3008', '4008', '5008', 'RCZ', 'Traveller'
                ],
                partNames: [
                    'Spark Plugs', 'Engine Oil', 'Oil Filter', 'Air Filter', 'Cabin Air Filter',
                    'Transmission Fluid', 'Coolant', 'Brake Fluid', 'Power Steering Fluid',
                    'Battery', 'Alternator', 'Starter Motor', 'Water Pump', 'Thermostat',
                    'Brake Pads', 'Brake Rotors', 'Brake Shoes', 'Brake Calipers', 'Brake Master Cylinder',
                    'Clutch Plate', 'Clutch Kit', 'Flywheel', 'Pressure Plate',
                    'CV Axle', 'CV Joint', 'Drive Shaft', 'Wheel Bearing',
                    'Shock Absorber', 'Strut', 'Coil Spring', 'Ball Joint', 'Control Arm',
                    'Tie Rod End', 'Steering Rack', 'Power Steering Pump',
                    'Serpentine Belt', 'Timing Belt', 'Timing Chain', 'Tensioner',
                    'Radiator', 'Radiator Hose', 'Heater Core', 'Fan Motor',
                    'Turbocharger', 'Intercooler', 'Intake Manifold', 'Exhaust Manifold',
                    'Catalytic Converter', 'Muffler', 'Exhaust Pipe', 'Oxygen Sensor',
                    'Mass Air Flow Sensor', 'Throttle Body', 'Fuel Pump', 'Fuel Filter', 'Fuel Injector',
                    'Ignition Coil', 'Distributor', 'Spark Plug Wires',
                    'Headlight', 'Tail Light', 'Fog Light', 'Turn Signal', 'Bulbs',
                    'Windshield Wiper Blade', 'Wiper Motor', 'Washer Pump',
                    'Door Handle', 'Window Regulator', 'Door Lock Actuator', 'Mirror',
                    'AC Compressor', 'Condenser', 'Evaporator', 'Refrigerant',
                    'ECU', 'TCM', 'ABS Module', 'Relay', 'Fuse'
                ],
                categories: [
                    'Engine', 'Transmission', 'Brakes', 'Suspension', 'Steering',
                    'Electrical', 'Cooling System', 'Fuel System', 'Exhaust',
                    'Body Parts', 'Interior', 'Lighting', 'AC/HVAC', 'Filters', 'Fluids', 'General'
                ],
                serviceChecklist: [
                    'Change Engine Oil', 'Replace Oil Filter', 'Replace Air Filter', 'Replace Cabin Filter',
                    'Check/Top Up Coolant', 'Check/Top Up Brake Fluid', 'Check/Top Up Power Steering Fluid',
                    'Check/Top Up Transmission Fluid', 'Check/Top Up Windshield Washer Fluid',
                    'Inspect Brake Pads', 'Inspect Brake Rotors', 'Inspect Brake Lines',
                    'Inspect Tyre Condition', 'Check Tyre Pressure', 'Rotate Tyres', 'Wheel Alignment Check',
                    'Inspect Suspension Components', 'Inspect Steering Components', 'Inspect CV Boots',
                    'Inspect Drive Belts', 'Inspect Timing Belt', 'Inspect Hoses',
                    'Check Battery Condition', 'Clean Battery Terminals', 'Test Charging System',
                    'Inspect Spark Plugs', 'Replace Spark Plugs', 'Inspect Ignition System',
                    'Inspect Exhaust System', 'Check for Leaks', 'Inspect Undercarriage',
                    'Check All Lights', 'Replace Wiper Blades', 'Top Up Refrigerant',
                    'AC System Check', 'Heater System Check', 'Diagnostic Scan',
                    'Road Test', 'Wash & Clean Vehicle', 'Reset Service Light'
                ]
            };

            const [smartLists, setSmartLists] = useState(defaultSmartLists);

            // List labels for display
            const listLabels = {
                peugeotModels: 'Peugeot Models',
                partNames: 'Part Names',
                categories: 'Part Categories',
                serviceChecklist: 'Service Checklist'
            };

            // Invoice Template state
            const defaultInvoiceTemplate = {
                // Header
                businessName: 'WORKSHOP PRO',
                businessTagline: 'Service Center',
                businessAddress: '',
                businessPhone: '',
                businessEmail: '',
                logoUrl: '',
                // Sections visibility
                showWorkDone: true,
                showPartsTable: true,
                showLaborCharges: true,
                showTaxiCost: true,
                showMileage: true,
                showSubtotal: true,
                showVat: true,
                // Footer
                footerTagline: 'Quality Guaranteed',
                footerMessage: 'Thank you for trusting us with your vehicle.',
                paymentTerms: '',
                bankDetails: '',
                // Styling
                accentColor: '#1e293b',
                showBorderTop: true
            };

            const [invoiceTemplate, setInvoiceTemplate] = useState(defaultInvoiceTemplate);
            const logoInputRef = useRef(null);

            // Load settings from localStorage
            useEffect(() => {
                const saved = localStorage.getItem('workshopSettings');
                if (saved) {
                    setBusinessSettings(prev => ({ ...prev, ...JSON.parse(saved) }));
                }
                // Load smart lists
                const savedLists = localStorage.getItem('workshopSmartLists');
                if (savedLists) {
                    setSmartLists(prev => ({ ...prev, ...JSON.parse(savedLists) }));
                }
                // Load invoice template
                const savedTemplate = localStorage.getItem('workshopInvoiceTemplate');
                if (savedTemplate) {
                    setInvoiceTemplate(prev => ({ ...prev, ...JSON.parse(savedTemplate) }));
                }
            }, []);

            // Save invoice template to localStorage
            const saveInvoiceTemplate = () => {
                localStorage.setItem('workshopInvoiceTemplate', JSON.stringify(invoiceTemplate));
                showToast('Invoice template saved!', 'success');
            };

            // Handle logo upload
            const handleLogoUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        setInvoiceTemplate(prev => ({ ...prev, logoUrl: ev.target.result }));
                    };
                    reader.readAsDataURL(file);
                }
            };

            // Save smart lists to localStorage
            const saveSmartLists = (lists) => {
                localStorage.setItem('workshopSmartLists', JSON.stringify(lists));
                setSmartLists(lists);
                showToast('List updated successfully!', 'success');
            };

            // Add item to list
            const addItemToList = () => {
                if (!newItemValue.trim()) return;
                const currentList = smartLists[selectedList] || [];
                if (currentList.includes(newItemValue.trim())) {
                    showToast('Item already exists in list', 'error');
                    return;
                }
                const updated = { ...smartLists, [selectedList]: [...currentList, newItemValue.trim()].sort() };
                saveSmartLists(updated);
                setNewItemValue('');
            };

            // Update item in list
            const updateItemInList = (oldValue) => {
                if (!editingItemValue.trim()) return;
                const currentList = smartLists[selectedList] || [];
                const updated = {
                    ...smartLists,
                    [selectedList]: currentList.map(item => item === oldValue ? editingItemValue.trim() : item).sort()
                };
                saveSmartLists(updated);
                setEditingItem(null);
                setEditingItemValue('');
            };

            // Delete item from list
            const deleteItemFromList = (value) => {
                const currentList = smartLists[selectedList] || [];
                const updated = { ...smartLists, [selectedList]: currentList.filter(item => item !== value) };
                saveSmartLists(updated);
            };

            // Import CSV
            const handleCsvImport = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const text = ev.target.result;
                    // Parse CSV - handle both comma-separated and newline-separated
                    const items = text.split(/[\n,]/)
                        .map(item => item.trim().replace(/^["']|["']$/g, ''))
                        .filter(item => item.length > 0);
                    
                    if (items.length === 0) {
                        showToast('No valid items found in CSV', 'error');
                        return;
                    }

                    const currentList = smartLists[selectedList] || [];
                    const merged = [...new Set([...currentList, ...items])].sort();
                    const updated = { ...smartLists, [selectedList]: merged };
                    saveSmartLists(updated);
                    showToast(`Imported ${items.length} items (${merged.length - currentList.length} new)`, 'success');
                };
                reader.readAsText(file);
                e.target.value = ''; // Reset file input
            };

            // Reset list to defaults
            const resetListToDefaults = () => {
                if (confirm(`Are you sure you want to reset "${listLabels[selectedList]}" to default values? This cannot be undone.`)) {
                    const updated = { ...smartLists, [selectedList]: defaultSmartLists[selectedList] };
                    saveSmartLists(updated);
                    showToast('List reset to defaults', 'success');
                }
            };

            // Filter current list items
            const filteredListItems = useMemo(() => {
                const items = smartLists[selectedList] || [];
                if (!listSearch) return items;
                return items.filter(item => item.toLowerCase().includes(listSearch.toLowerCase()));
            }, [smartLists, selectedList, listSearch]);

            // Load technicians
            const loadTechnicians = async () => {
                const res = await callDB('db-query', { 
                    sql: "SELECT user_id, full_name, pin, hourly_rate, role FROM users WHERE role = 'technician' ORDER BY full_name" 
                });
                if (res.success) setTechnicians(res.data);
            };

            useEffect(() => { loadTechnicians(); }, []);

            // Save business settings
            const saveBusinessSettings = () => {
                localStorage.setItem('workshopSettings', JSON.stringify(businessSettings));
                showToast('Settings saved successfully!', 'success');
            };

            // Technician CRUD
            const saveTechnician = async () => {
                if (!editingTech.full_name || !editingTech.pin) {
                    showToast('Name and PIN are required', 'error');
                    return;
                }
                if (editingTech.pin.length !== 4 || !/^\d{4}$/.test(editingTech.pin)) {
                    showToast('PIN must be exactly 4 digits', 'error');
                    return;
                }

                if (editingTech.user_id) {
                    // Update existing
                    const res = await callDB('db-run', {
                        sql: "UPDATE users SET full_name = ?, pin = ?, hourly_rate = ? WHERE user_id = ?",
                        params: [editingTech.full_name, editingTech.pin, editingTech.hourly_rate || 0, editingTech.user_id]
                    });
                    if (res.success) {
                        showToast('Technician updated!', 'success');
                    } else {
                        showToast('Error: ' + res.error, 'error');
                        return;
                    }
                } else {
                    // Create new
                    const res = await callDB('db-run', {
                        sql: "INSERT INTO users (full_name, role, pin, hourly_rate) VALUES (?, 'technician', ?, ?)",
                        params: [editingTech.full_name, editingTech.pin, editingTech.hourly_rate || 0]
                    });
                    if (res.success) {
                        showToast('Technician added!', 'success');
                    } else {
                        showToast('Error: ' + (res.error.includes('UNIQUE') ? 'PIN already in use' : res.error), 'error');
                        return;
                    }
                }
                setShowTechModal(false);
                setEditingTech(null);
                loadTechnicians();
            };

            const deleteTechnician = async () => {
                const res = await callDB('db-run', {
                    sql: "DELETE FROM users WHERE user_id = ?",
                    params: [deletingTechId]
                });
                if (res.success) {
                    showToast('Technician deleted', 'success');
                } else {
                    showToast('Error: ' + res.error, 'error');
                }
                setShowDeleteConfirm(false);
                setDeletingTechId(null);
                loadTechnicians();
            };

            const TabButton = ({ id, label, icon }) => (
                <button
                    onClick={() => setActiveTab(id)}
                    className={`px-6 py-3 font-semibold text-sm rounded-lg transition-all ${
                        activeTab === id 
                            ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-500/20' 
                            : 'text-slate-400 hover:text-white hover:bg-slate-800/50'
                    }`}
                >
                    {icon} {label}
                </button>
            );

            return (
                <div className="animate-in fade-in duration-500 space-y-6">
                    <div>
                        <h1 className="text-3xl font-bold text-white">Settings</h1>
                        <p className="text-slate-400 text-sm mt-1">Manage your workshop configuration</p>
                    </div>

                    {/* Tabs */}
                    <div className="flex gap-2 border-b border-slate-700/50 pb-4 flex-wrap">
                        <TabButton id="technicians" label="Technicians" icon="üë∑" />
                        <TabButton id="business" label="Business" icon="üè¢" />
                        <TabButton id="inventory" label="Inventory" icon="üì¶" />
                        <TabButton id="smartlists" label="Smart Lists" icon="üìù" />
                        <TabButton id="invoice" label="Invoice Template" icon="üßæ" />
                        <TabButton id="backup" label="Backup & Restore" icon="üíæ" />
                    </div>

                    {/* Technicians Tab */}
                    {activeTab === 'technicians' && (
                        <div className="space-y-4">
                            <div className="flex justify-between items-center">
                                <p className="text-slate-400 text-sm">Manage technician accounts and access PINs</p>
                                <button 
                                    onClick={() => { setEditingTech({ full_name: '', pin: '', hourly_rate: businessSettings.defaultLaborRate }); setShowTechModal(true); }}
                                    className="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-semibold text-sm shadow-lg shadow-indigo-500/20"
                                >
                                    + Add Technician
                                </button>
                            </div>

                            <div className="glass-dark rounded-xl border border-slate-700/50 overflow-hidden">
                                <table className="w-full text-left">
                                    <thead className="border-b border-slate-700/50 bg-slate-900/30">
                                        <tr className="text-xs font-semibold text-slate-400 uppercase">
                                            <th className="p-4">Name</th>
                                            <th>PIN Code</th>
                                            <th>Hourly Rate</th>
                                            <th className="text-right pr-4">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-700/30">
                                        {technicians.map(tech => (
                                            <tr key={tech.user_id} className="hover:bg-slate-800/20 transition-colors">
                                                <td className="p-4">
                                                    <span className="font-semibold text-white">{tech.full_name}</span>
                                                </td>
                                                <td>
                                                    <code className="bg-slate-800 px-3 py-1 rounded font-mono text-indigo-400">{tech.pin}</code>
                                                </td>
                                                <td className="text-slate-300">{formatLKR(tech.hourly_rate || 0)}/hr</td>
                                                <td className="text-right pr-4">
                                                    <button 
                                                        onClick={() => { setEditingTech(tech); setShowTechModal(true); }}
                                                        className="text-indigo-400 hover:text-indigo-300 font-semibold text-sm mr-3"
                                                    >
                                                        Edit
                                                    </button>
                                                    <button 
                                                        onClick={() => { setDeletingTechId(tech.user_id); setShowDeleteConfirm(true); }}
                                                        className="text-red-400 hover:text-red-300 font-semibold text-sm"
                                                    >
                                                        Delete
                                                    </button>
                                                </td>
                                            </tr>
                                        ))}
                                        {technicians.length === 0 && (
                                            <tr><td colSpan="4" className="p-8 text-center text-slate-400">No technicians added yet.</td></tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}

                    {/* Business Tab */}
                    {activeTab === 'business' && (
                        <div className="space-y-6 max-w-2xl">
                            <div className="glass-dark rounded-xl p-6 border border-slate-700/50 space-y-6">
                                <h3 className="text-lg font-bold text-white border-b border-slate-700/50 pb-3">General Settings</h3>
                                
                                <div>
                                    <label className="block text-xs font-semibold text-slate-400 uppercase mb-2">Shop Name</label>
                                    <input
                                        type="text"
                                        value={businessSettings.shopName}
                                        onChange={(e) => setBusinessSettings(prev => ({ ...prev, shopName: e.target.value }))}
                                        className="w-full bg-slate-800/50 border border-slate-700/50 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-indigo-500"
                                    />
                                </div>

                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-xs font-semibold text-slate-400 uppercase mb-2">Overdue Alert (Days)</label>
                                        <input
                                            type="number"
                                            min="1"
                                            value={businessSettings.overdueThresholdDays}
                                            onChange={(e) => setBusinessSettings(prev => ({ ...prev, overdueThresholdDays: parseInt(e.target.value) || 3 }))}
                                            className="w-full bg-slate-800/50 border border-slate-700/50 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-indigo-500"
                                        />
                                        <p className="text-xs text-slate-500 mt-1">Jobs pending longer than this will show alerts</p>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-semibold text-slate-400 uppercase mb-2">VAT Rate (%)</label>
                                        <input
                                            type="number"
                                            min="0"
                                            max="100"
                                            value={businessSettings.vatRate}
                                            onChange={(e) => setBusinessSettings(prev => ({ ...prev, vatRate: parseFloat(e.target.value) || 0 }))}
                                            className="w-full bg-slate-800/50 border border-slate-700/50 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-indigo-500"
                                        />
                                    </div>
                                </div>
                            </div>

                            <div className="glass-dark rounded-xl p-6 border border-slate-700/50 space-y-6">
                                <h3 className="text-lg font-bold text-white border-b border-slate-700/50 pb-3">Labor Settings</h3>
                                
                                <div>
                                    <label className="block text-xs font-semibold text-slate-400 uppercase mb-2">Default Hourly Rate (LKR)</label>
                                    <input
                                        type="number"
                                        min="0"
                                        value={businessSettings.defaultLaborRate}
                                        onChange={(e) => setBusinessSettings(prev => ({ ...prev, defaultLaborRate: parseFloat(e.target.value) || 0 }))}
                                        className="w-full bg-slate-800/50 border border-slate-700/50 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-indigo-500"
                                    />
                                    <p className="text-xs text-slate-500 mt-1">Used as default when adding new technicians</p>
                                </div>
                            </div>

                            <button 
                                onClick={saveBusinessSettings}
                                className="bg-emerald-600 hover:bg-emerald-700 text-white px-8 py-3 rounded-lg font-semibold shadow-lg shadow-emerald-500/20"
                            >
                                üíæ Save Settings
                            </button>
                        </div>
                    )}

                    {/* Inventory Tab */}
                    {activeTab === 'inventory' && (
                        <div className="space-y-6 max-w-2xl">
                            <div className="glass-dark rounded-xl p-6 border border-slate-700/50 space-y-6">
                                <h3 className="text-lg font-bold text-white border-b border-slate-700/50 pb-3">Stock Alerts</h3>
                                
                                <div>
                                    <label className="block text-xs font-semibold text-slate-400 uppercase mb-2">Default Low Stock Threshold</label>
                                    <input
                                        type="number"
                                        min="1"
                                        value={businessSettings.defaultMinStock}
                                        onChange={(e) => setBusinessSettings(prev => ({ ...prev, defaultMinStock: parseInt(e.target.value) || 5 }))}
                                        className="w-full bg-slate-800/50 border border-slate-700/50 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-indigo-500"
                                    />
                                    <p className="text-xs text-slate-500 mt-1">Default minimum quantity before low stock alerts appear</p>
                                </div>
                            </div>

                            <button 
                                onClick={saveBusinessSettings}
                                className="bg-emerald-600 hover:bg-emerald-700 text-white px-8 py-3 rounded-lg font-semibold shadow-lg shadow-emerald-500/20"
                            >
                                üíæ Save Settings
                            </button>
                        </div>
                    )}

                    {/* Smart Lists Tab */}
                    {activeTab === 'smartlists' && (
                        <div className="space-y-6">
                            <div className="flex flex-wrap gap-4 items-center justify-between">
                                <div className="flex gap-3 items-center">
                                    <label className="text-sm text-slate-400">Select List:</label>
                                    <select
                                        value={selectedList}
                                        onChange={(e) => { setSelectedList(e.target.value); setListSearch(''); setEditingItem(null); }}
                                        className="bg-slate-800/50 border border-slate-700/50 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-indigo-500"
                                    >
                                        <option value="peugeotModels">Peugeot Models</option>
                                        <option value="partNames">Part Names</option>
                                        <option value="categories">Part Categories</option>
                                        <option value="serviceChecklist">Service Checklist</option>
                                    </select>
                                </div>
                                <div className="flex gap-2">
                                    <input
                                        type="file"
                                        accept=".csv,.txt"
                                        ref={csvInputRef}
                                        onChange={handleCsvImport}
                                        className="hidden"
                                    />
                                    <button
                                        onClick={() => csvInputRef.current?.click()}
                                        className="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-semibold text-sm shadow-lg shadow-indigo-500/20"
                                    >
                                        üì• Import CSV
                                    </button>
                                    <button
                                        onClick={resetListToDefaults}
                                        className="bg-slate-700/50 hover:bg-slate-600/50 text-slate-300 px-4 py-2 rounded-lg font-semibold text-sm"
                                    >
                                        üîÑ Reset to Defaults
                                    </button>
                                </div>
                            </div>

                            <div className="glass-dark rounded-xl border border-slate-700/50 overflow-hidden">
                                {/* Add new item */}
                                <div className="p-4 border-b border-slate-700/50 bg-slate-900/30">
                                    <div className="flex gap-3">
                                        <input
                                            type="text"
                                            placeholder={`Add new ${selectedList === 'peugeotModels' ? 'model' : selectedList === 'categories' ? 'category' : 'part name'}...`}
                                            value={newItemValue}
                                            onChange={(e) => setNewItemValue(e.target.value)}
                                            onKeyDown={(e) => e.key === 'Enter' && addItemToList()}
                                            className="flex-1 bg-slate-800/50 border border-slate-700/50 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-indigo-500 text-sm"
                                        />
                                        <button
                                            onClick={addItemToList}
                                            disabled={!newItemValue.trim()}
                                            className="bg-emerald-600 hover:bg-emerald-700 disabled:bg-slate-700 disabled:text-slate-500 text-white px-6 py-2 rounded-lg font-semibold text-sm"
                                        >
                                            + Add
                                        </button>
                                    </div>
                                </div>

                                {/* Search filter */}
                                <div className="p-4 border-b border-slate-700/50">
                                    <div className="relative">
                                        <span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500">üîç</span>
                                        <input
                                            type="text"
                                            placeholder="Filter items..."
                                            value={listSearch}
                                            onChange={(e) => setListSearch(e.target.value)}
                                            className="w-full bg-slate-800/30 border border-slate-700/30 rounded-lg pl-10 pr-4 py-2 text-white text-sm focus:outline-none focus:border-indigo-500"
                                        />
                                    </div>
                                    <p className="text-xs text-slate-500 mt-2">
                                        Showing {filteredListItems.length} of {(smartLists[selectedList] || []).length} items
                                    </p>
                                </div>

                                {/* List items */}
                                <div className="max-h-96 overflow-y-auto divide-y divide-slate-700/30">
                                    {filteredListItems.map((item, idx) => (
                                        <div key={idx} className="p-3 px-4 flex items-center justify-between hover:bg-slate-800/20 group">
                                            {editingItem === item ? (
                                                <div className="flex-1 flex gap-2">
                                                    <input
                                                        type="text"
                                                        value={editingItemValue}
                                                        onChange={(e) => setEditingItemValue(e.target.value)}
                                                        onKeyDown={(e) => {
                                                            if (e.key === 'Enter') updateItemInList(item);
                                                            if (e.key === 'Escape') { setEditingItem(null); setEditingItemValue(''); }
                                                        }}
                                                        autoFocus
                                                        className="flex-1 bg-slate-800/50 border border-indigo-500 rounded px-3 py-1 text-white text-sm focus:outline-none"
                                                    />
                                                    <button
                                                        onClick={() => updateItemInList(item)}
                                                        className="text-emerald-400 hover:text-emerald-300 font-semibold text-sm px-2"
                                                    >
                                                        Save
                                                    </button>
                                                    <button
                                                        onClick={() => { setEditingItem(null); setEditingItemValue(''); }}
                                                        className="text-slate-400 hover:text-slate-300 font-semibold text-sm px-2"
                                                    >
                                                        Cancel
                                                    </button>
                                                </div>
                                            ) : (
                                                <>
                                                    <span className="text-white text-sm">{item}</span>
                                                    <div className="opacity-0 group-hover:opacity-100 transition-opacity flex gap-2">
                                                        <button
                                                            onClick={() => { setEditingItem(item); setEditingItemValue(item); }}
                                                            className="text-indigo-400 hover:text-indigo-300 font-semibold text-xs"
                                                        >
                                                            Edit
                                                        </button>
                                                        <button
                                                            onClick={() => deleteItemFromList(item)}
                                                            className="text-red-400 hover:text-red-300 font-semibold text-xs"
                                                        >
                                                            Delete
                                                        </button>
                                                    </div>
                                                </>
                                            )}
                                        </div>
                                    ))}
                                    {filteredListItems.length === 0 && (
                                        <div className="p-8 text-center text-slate-400">
                                            {listSearch ? 'No matching items found.' : 'No items in this list.'}
                                        </div>
                                    )}
                                </div>
                            </div>

                            <div className="glass-dark rounded-xl p-4 border border-slate-700/50">
                                <h4 className="text-sm font-semibold text-white mb-2">üí° CSV Import Tips</h4>
                                <ul className="text-xs text-slate-400 space-y-1">
                                    <li>‚Ä¢ Upload a .csv or .txt file with items separated by commas or new lines</li>
                                    <li>‚Ä¢ Duplicate items will be automatically skipped</li>
                                    <li>‚Ä¢ Example: <code className="bg-slate-800 px-1 rounded">Spark Plugs, Oil Filter, Air Filter</code></li>
                                    <li>‚Ä¢ Or one item per line in the file</li>
                                </ul>
                            </div>
                        </div>
                    )}

                    {/* Invoice Template Tab */}
                    {activeTab === 'invoice' && (
                        <div className="space-y-6 max-w-4xl">
                            {/* Header Settings */}
                            <div className="glass-dark rounded-xl p-6 border border-slate-700/50 space-y-6">
                                <h3 className="text-lg font-bold text-white border-b border-slate-700/50 pb-3">üìÑ Invoice Header</h3>
                                
                                <div className="grid grid-cols-2 gap-6">
                                    <div className="col-span-2 md:col-span-1">
                                        <label className="block text-xs font-semibold text-slate-400 uppercase mb-2">Business Name</label>
                                        <input
                                            type="text"
                                            value={invoiceTemplate.businessName}
                                            onChange={(e) => setInvoiceTemplate(prev => ({ ...prev, businessName: e.target.value }))}
                                            className="w-full bg-slate-800/50 border border-slate-700/50 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-indigo-500"
                                            placeholder="Your Workshop Name"
                                        />
                                    </div>
                                    <div className="col-span-2 md:col-span-1">
                                        <label className="block text-xs font-semibold text-slate-400 uppercase mb-2">Tagline / Subtitle</label>
                                        <input
                                            type="text"
                                            value={invoiceTemplate.businessTagline}
                                            onChange={(e) => setInvoiceTemplate(prev => ({ ...prev, businessTagline: e.target.value }))}
                                            className="w-full bg-slate-800/50 border border-slate-700/50 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-indigo-500"
                                            placeholder="Service Center"
                                        />
                                    </div>
                                    <div className="col-span-2">
                                        <label className="block text-xs font-semibold text-slate-400 uppercase mb-2">Business Address</label>
                                        <textarea
                                            value={invoiceTemplate.businessAddress}
                                            onChange={(e) => setInvoiceTemplate(prev => ({ ...prev, businessAddress: e.target.value }))}
                                            rows="2"
                                            className="w-full bg-slate-800/50 border border-slate-700/50 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-indigo-500 resize-none"
                                            placeholder="123 Main Street, Colombo 01"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-semibold text-slate-400 uppercase mb-2">Phone Number</label>
                                        <input
                                            type="text"
                                            value={invoiceTemplate.businessPhone}
                                            onChange={(e) => setInvoiceTemplate(prev => ({ ...prev, businessPhone: e.target.value }))}
                                            className="w-full bg-slate-800/50 border border-slate-700/50 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-indigo-500"
                                            placeholder="+94 11 123 4567"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-semibold text-slate-400 uppercase mb-2">Email Address</label>
                                        <input
                                            type="email"
                                            value={invoiceTemplate.businessEmail}
                                            onChange={(e) => setInvoiceTemplate(prev => ({ ...prev, businessEmail: e.target.value }))}
                                            className="w-full bg-slate-800/50 border border-slate-700/50 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-indigo-500"
                                            placeholder="info@workshop.com"
                                        />
                                    </div>
                                    <div className="col-span-2">
                                        <label className="block text-xs font-semibold text-slate-400 uppercase mb-2">Business Logo</label>
                                        <div className="flex items-center gap-4">
                                            {invoiceTemplate.logoUrl ? (
                                                <div className="relative">
                                                    <img src={invoiceTemplate.logoUrl} alt="Logo" className="w-20 h-20 object-contain bg-white rounded-lg border border-slate-700/50" />
                                                    <button 
                                                        onClick={() => setInvoiceTemplate(prev => ({ ...prev, logoUrl: '' }))}
                                                        className="absolute -top-2 -right-2 bg-red-600 text-white rounded-full w-6 h-6 text-xs font-bold"
                                                    >√ó</button>
                                                </div>
                                            ) : (
                                                <div className="w-20 h-20 bg-slate-800/50 rounded-lg border border-dashed border-slate-600 flex items-center justify-center text-slate-500 text-xs">
                                                    No Logo
                                                </div>
                                            )}
                                            <input type="file" accept="image/*" ref={logoInputRef} onChange={handleLogoUpload} className="hidden" />
                                            <button 
                                                onClick={() => logoInputRef.current?.click()}
                                                className="bg-slate-700/50 hover:bg-slate-600/50 text-slate-300 px-4 py-2 rounded-lg font-semibold text-sm"
                                            >
                                                üì∑ Upload Logo
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* Invoice Sections */}
                            <div className="glass-dark rounded-xl p-6 border border-slate-700/50 space-y-6">
                                <h3 className="text-lg font-bold text-white border-b border-slate-700/50 pb-3">üìã Invoice Sections</h3>
                                <p className="text-sm text-slate-400">Choose which sections to display on invoices</p>
                                
                                <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                                    <label className="flex items-center gap-3 p-3 bg-slate-800/30 rounded-lg cursor-pointer hover:bg-slate-800/50 transition-colors">
                                        <input
                                            type="checkbox"
                                            checked={invoiceTemplate.showWorkDone}
                                            onChange={(e) => setInvoiceTemplate(prev => ({ ...prev, showWorkDone: e.target.checked }))}
                                            className="w-5 h-5 rounded border-slate-600 text-indigo-600 focus:ring-indigo-500 bg-slate-700"
                                        />
                                        <span className="text-sm text-white">Work Done / Tasks</span>
                                    </label>
                                    <label className="flex items-center gap-3 p-3 bg-slate-800/30 rounded-lg cursor-pointer hover:bg-slate-800/50 transition-colors">
                                        <input
                                            type="checkbox"
                                            checked={invoiceTemplate.showPartsTable}
                                            onChange={(e) => setInvoiceTemplate(prev => ({ ...prev, showPartsTable: e.target.checked }))}
                                            className="w-5 h-5 rounded border-slate-600 text-indigo-600 focus:ring-indigo-500 bg-slate-700"
                                        />
                                        <span className="text-sm text-white">Parts Used</span>
                                    </label>
                                    <label className="flex items-center gap-3 p-3 bg-slate-800/30 rounded-lg cursor-pointer hover:bg-slate-800/50 transition-colors">
                                        <input
                                            type="checkbox"
                                            checked={invoiceTemplate.showLaborCharges}
                                            onChange={(e) => setInvoiceTemplate(prev => ({ ...prev, showLaborCharges: e.target.checked }))}
                                            className="w-5 h-5 rounded border-slate-600 text-indigo-600 focus:ring-indigo-500 bg-slate-700"
                                        />
                                        <span className="text-sm text-white">Labor Charges</span>
                                    </label>
                                    <label className="flex items-center gap-3 p-3 bg-slate-800/30 rounded-lg cursor-pointer hover:bg-slate-800/50 transition-colors">
                                        <input
                                            type="checkbox"
                                            checked={invoiceTemplate.showTaxiCost}
                                            onChange={(e) => setInvoiceTemplate(prev => ({ ...prev, showTaxiCost: e.target.checked }))}
                                            className="w-5 h-5 rounded border-slate-600 text-indigo-600 focus:ring-indigo-500 bg-slate-700"
                                        />
                                        <span className="text-sm text-white">Taxi Cost</span>
                                    </label>
                                    <label className="flex items-center gap-3 p-3 bg-slate-800/30 rounded-lg cursor-pointer hover:bg-slate-800/50 transition-colors">
                                        <input
                                            type="checkbox"
                                            checked={invoiceTemplate.showMileage}
                                            onChange={(e) => setInvoiceTemplate(prev => ({ ...prev, showMileage: e.target.checked }))}
                                            className="w-5 h-5 rounded border-slate-600 text-indigo-600 focus:ring-indigo-500 bg-slate-700"
                                        />
                                        <span className="text-sm text-white">Mileage (KM In/Out)</span>
                                    </label>
                                    <label className="flex items-center gap-3 p-3 bg-slate-800/30 rounded-lg cursor-pointer hover:bg-slate-800/50 transition-colors">
                                        <input
                                            type="checkbox"
                                            checked={invoiceTemplate.showSubtotal}
                                            onChange={(e) => setInvoiceTemplate(prev => ({ ...prev, showSubtotal: e.target.checked }))}
                                            className="w-5 h-5 rounded border-slate-600 text-indigo-600 focus:ring-indigo-500 bg-slate-700"
                                        />
                                        <span className="text-sm text-white">Subtotal</span>
                                    </label>
                                    <label className="flex items-center gap-3 p-3 bg-slate-800/30 rounded-lg cursor-pointer hover:bg-slate-800/50 transition-colors">
                                        <input
                                            type="checkbox"
                                            checked={invoiceTemplate.showVat}
                                            onChange={(e) => setInvoiceTemplate(prev => ({ ...prev, showVat: e.target.checked }))}
                                            className="w-5 h-5 rounded border-slate-600 text-indigo-600 focus:ring-indigo-500 bg-slate-700"
                                        />
                                        <span className="text-sm text-white">VAT / Tax</span>
                                    </label>
                                    <label className="flex items-center gap-3 p-3 bg-slate-800/30 rounded-lg cursor-pointer hover:bg-slate-800/50 transition-colors">
                                        <input
                                            type="checkbox"
                                            checked={invoiceTemplate.showBorderTop}
                                            onChange={(e) => setInvoiceTemplate(prev => ({ ...prev, showBorderTop: e.target.checked }))}
                                            className="w-5 h-5 rounded border-slate-600 text-indigo-600 focus:ring-indigo-500 bg-slate-700"
                                        />
                                        <span className="text-sm text-white">Top Border Accent</span>
                                    </label>
                                </div>
                            </div>

                            {/* Footer Settings */}
                            <div className="glass-dark rounded-xl p-6 border border-slate-700/50 space-y-6">
                                <h3 className="text-lg font-bold text-white border-b border-slate-700/50 pb-3">üìù Invoice Footer</h3>
                                
                                <div className="grid grid-cols-2 gap-6">
                                    <div>
                                        <label className="block text-xs font-semibold text-slate-400 uppercase mb-2">Footer Tagline</label>
                                        <input
                                            type="text"
                                            value={invoiceTemplate.footerTagline}
                                            onChange={(e) => setInvoiceTemplate(prev => ({ ...prev, footerTagline: e.target.value }))}
                                            className="w-full bg-slate-800/50 border border-slate-700/50 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-indigo-500"
                                            placeholder="Quality Guaranteed"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-semibold text-slate-400 uppercase mb-2">Thank You Message</label>
                                        <input
                                            type="text"
                                            value={invoiceTemplate.footerMessage}
                                            onChange={(e) => setInvoiceTemplate(prev => ({ ...prev, footerMessage: e.target.value }))}
                                            className="w-full bg-slate-800/50 border border-slate-700/50 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-indigo-500"
                                            placeholder="Thank you for your business!"
                                        />
                                    </div>
                                    <div className="col-span-2">
                                        <label className="block text-xs font-semibold text-slate-400 uppercase mb-2">Payment Terms</label>
                                        <textarea
                                            value={invoiceTemplate.paymentTerms}
                                            onChange={(e) => setInvoiceTemplate(prev => ({ ...prev, paymentTerms: e.target.value }))}
                                            rows="2"
                                            className="w-full bg-slate-800/50 border border-slate-700/50 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-indigo-500 resize-none"
                                            placeholder="Payment due within 7 days. Late fees may apply."
                                        />
                                    </div>
                                    <div className="col-span-2">
                                        <label className="block text-xs font-semibold text-slate-400 uppercase mb-2">Bank Details / Payment Info</label>
                                        <textarea
                                            value={invoiceTemplate.bankDetails}
                                            onChange={(e) => setInvoiceTemplate(prev => ({ ...prev, bankDetails: e.target.value }))}
                                            rows="3"
                                            className="w-full bg-slate-800/50 border border-slate-700/50 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-indigo-500 resize-none"
                                            placeholder="Bank: Commercial Bank&#10;Account: 1234567890&#10;Branch: Colombo"
                                        />
                                    </div>
                                </div>
                            </div>

                            {/* Styling */}
                            <div className="glass-dark rounded-xl p-6 border border-slate-700/50 space-y-6">
                                <h3 className="text-lg font-bold text-white border-b border-slate-700/50 pb-3">üé® Accent Color</h3>
                                
                                <div className="flex items-center gap-4">
                                    <input
                                        type="color"
                                        value={invoiceTemplate.accentColor}
                                        onChange={(e) => setInvoiceTemplate(prev => ({ ...prev, accentColor: e.target.value }))}
                                        className="w-12 h-12 rounded-lg border border-slate-700/50 cursor-pointer"
                                    />
                                    <div>
                                        <p className="text-white font-semibold">Top Border & Heading Color</p>
                                        <p className="text-xs text-slate-400">Used for accent elements on the invoice</p>
                                    </div>
                                </div>
                            </div>

                            {/* Actions */}
                            <div className="flex gap-4">
                                <button 
                                    onClick={saveInvoiceTemplate}
                                    className="bg-emerald-600 hover:bg-emerald-700 text-white px-8 py-3 rounded-lg font-semibold shadow-lg shadow-emerald-500/20"
                                >
                                    üíæ Save Template
                                </button>
                                <button 
                                    onClick={() => { 
                                        if (confirm('Reset to default template? This cannot be undone.')) {
                                            setInvoiceTemplate(defaultInvoiceTemplate);
                                            localStorage.removeItem('workshopInvoiceTemplate');
                                            showToast('Template reset to defaults', 'success');
                                        }
                                    }}
                                    className="bg-slate-700/50 hover:bg-slate-600/50 text-slate-300 px-6 py-3 rounded-lg font-semibold"
                                >
                                    üîÑ Reset to Default
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Backup & Restore Tab */}
                    {activeTab === 'backup' && (
                        <div className="space-y-6 max-w-2xl">
                            <div className="glass-dark rounded-xl p-6 border border-slate-700/50 space-y-6">
                                <h3 className="text-lg font-bold text-white border-b border-slate-700/50 pb-3">üì§ Create Backup</h3>
                                <p className="text-slate-400 text-sm">Create backups of your database and uploaded files. Store these in a safe location.</p>
                                
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div className="bg-slate-800/30 p-4 rounded-lg border border-slate-700/30">
                                        <h4 className="font-semibold text-white mb-2">üóÑÔ∏è Database Backup</h4>
                                        <p className="text-xs text-slate-400 mb-4">All jobs, vehicles, parts, technicians, and settings data.</p>
                                        <button 
                                            onClick={async () => {
                                                const res = await window.require('electron').ipcRenderer.invoke('backup-database');
                                                if (res.success) {
                                                    showToast('Database backed up successfully!', 'success');
                                                } else if (res.error !== 'Cancelled') {
                                                    showToast('Backup failed: ' + res.error, 'error');
                                                }
                                            }}
                                            className="w-full bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-3 rounded-lg font-semibold text-sm shadow-lg shadow-indigo-500/20"
                                        >
                                            üíæ Backup Database
                                        </button>
                                    </div>
                                    
                                    <div className="bg-slate-800/30 p-4 rounded-lg border border-slate-700/30">
                                        <h4 className="font-semibold text-white mb-2">üìÅ Uploads Backup</h4>
                                        <p className="text-xs text-slate-400 mb-4">All vehicle photos and uploaded images (as ZIP).</p>
                                        <button 
                                            onClick={async () => {
                                                const res = await window.require('electron').ipcRenderer.invoke('backup-uploads');
                                                if (res.success) {
                                                    const sizeMB = (res.size / (1024 * 1024)).toFixed(2);
                                                    showToast(`Uploads backed up (${sizeMB} MB)`, 'success');
                                                } else if (res.error !== 'Cancelled') {
                                                    showToast('Backup failed: ' + res.error, 'error');
                                                }
                                            }}
                                            className="w-full bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-3 rounded-lg font-semibold text-sm shadow-lg shadow-indigo-500/20"
                                        >
                                            üì¶ Backup Uploads (ZIP)
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div className="glass-dark rounded-xl p-6 border border-red-500/30 space-y-6">
                                <h3 className="text-lg font-bold text-red-400 border-b border-slate-700/50 pb-3">üì• Restore from Backup</h3>
                                <p className="text-slate-400 text-sm">Restore your data from a previous backup. <strong className="text-red-400">Warning:</strong> This will replace your current data.</p>
                                
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div className="bg-slate-800/30 p-4 rounded-lg border border-red-500/20">
                                        <h4 className="font-semibold text-white mb-2">üóÑÔ∏è Restore Database</h4>
                                        <p className="text-xs text-slate-400 mb-4">Select a .db file to restore. App will restart after restore.</p>
                                        <button 
                                            onClick={async () => {
                                                if (!confirm('‚ö†Ô∏è This will replace ALL current data with the backup.\n\nA backup of your current database will be saved before restore.\n\nThe app will restart after restore.\n\nContinue?')) return;
                                                
                                                const res = await window.require('electron').ipcRenderer.invoke('restore-database');
                                                if (res.success) {
                                                    showToast('Database restored! Restarting...', 'success');
                                                    setTimeout(async () => {
                                                        await window.require('electron').ipcRenderer.invoke('restart-app');
                                                    }, 1500);
                                                } else if (res.error !== 'Cancelled') {
                                                    showToast('Restore failed: ' + res.error, 'error');
                                                }
                                            }}
                                            className="w-full bg-red-600 hover:bg-red-700 text-white px-4 py-3 rounded-lg font-semibold text-sm shadow-lg shadow-red-500/20"
                                        >
                                            üîÑ Restore Database
                                        </button>
                                    </div>
                                    
                                    <div className="bg-slate-800/30 p-4 rounded-lg border border-red-500/20">
                                        <h4 className="font-semibold text-white mb-2">üìÅ Restore Uploads</h4>
                                        <p className="text-xs text-slate-400 mb-4">Select a uploads backup ZIP file to restore.</p>
                                        <button 
                                            onClick={async () => {
                                                if (!confirm('‚ö†Ô∏è This will replace ALL uploaded files with the backup.\n\nA backup of your current uploads folder will be saved before restore.\n\nContinue?')) return;
                                                
                                                const res = await window.require('electron').ipcRenderer.invoke('restore-uploads');
                                                if (res.success) {
                                                    showToast('Uploads restored successfully!', 'success');
                                                } else if (res.error !== 'Cancelled') {
                                                    showToast('Restore failed: ' + res.error, 'error');
                                                }
                                            }}
                                            className="w-full bg-red-600 hover:bg-red-700 text-white px-4 py-3 rounded-lg font-semibold text-sm shadow-lg shadow-red-500/20"
                                        >
                                            üîÑ Restore Uploads
                                        </button>
                                    </div>
                                </div>
                                
                                <div className="mt-4 p-4 bg-amber-500/10 border border-amber-500/30 rounded-lg">
                                    <p className="text-amber-400 text-sm">
                                        <strong>üí° Tip:</strong> Before restoring, the system automatically creates a backup of your current data. 
                                        If something goes wrong, look for files named <code className="bg-slate-800 px-1 rounded">workshop.db.pre_restore_backup</code> and <code className="bg-slate-800 px-1 rounded">uploads_pre_restore_backup</code> in your app folder.
                                    </p>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Add/Edit Technician Modal */}
                    {showTechModal && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50 animate-in fade-in duration-200">
                            <div className="glass-dark rounded-2xl shadow-2xl max-w-md w-full p-6 space-y-6">
                                <h2 className="text-xl font-bold text-white">
                                    {editingTech?.user_id ? 'Edit Technician' : 'Add Technician'}
                                </h2>

                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-xs font-semibold text-slate-400 uppercase mb-2">Full Name *</label>
                                        <input
                                            type="text"
                                            value={editingTech?.full_name || ''}
                                            onChange={(e) => setEditingTech(prev => ({ ...prev, full_name: e.target.value }))}
                                            className="w-full bg-slate-800/50 border border-slate-700/50 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-indigo-500"
                                            placeholder="e.g. Arjun Perera"
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-xs font-semibold text-slate-400 uppercase mb-2">4-Digit PIN *</label>
                                        <input
                                            type="text"
                                            maxLength="4"
                                            value={editingTech?.pin || ''}
                                            onChange={(e) => setEditingTech(prev => ({ ...prev, pin: e.target.value.replace(/\D/g, '').slice(0,4) }))}
                                            className="w-full bg-slate-800/50 border border-slate-700/50 rounded-lg px-4 py-3 text-white font-mono text-xl tracking-[.5em] focus:outline-none focus:border-indigo-500"
                                            placeholder="0000"
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-xs font-semibold text-slate-400 uppercase mb-2">Hourly Rate (LKR)</label>
                                        <input
                                            type="number"
                                            min="0"
                                            value={editingTech?.hourly_rate || 0}
                                            onChange={(e) => setEditingTech(prev => ({ ...prev, hourly_rate: parseFloat(e.target.value) || 0 }))}
                                            className="w-full bg-slate-800/50 border border-slate-700/50 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-indigo-500"
                                        />
                                    </div>
                                </div>

                                <div className="flex gap-3 pt-2">
                                    <button 
                                        onClick={() => { setShowTechModal(false); setEditingTech(null); }}
                                        className="flex-1 bg-slate-700/50 hover:bg-slate-600/50 text-slate-300 px-4 py-3 rounded-lg font-semibold text-sm"
                                    >
                                        Cancel
                                    </button>
                                    <button 
                                        onClick={saveTechnician}
                                        className="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-3 rounded-lg font-semibold text-sm shadow-lg shadow-indigo-500/20"
                                    >
                                        {editingTech?.user_id ? 'Save Changes' : 'Add Technician'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Delete Confirmation */}
                    {showDeleteConfirm && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50 animate-in fade-in duration-200">
                            <div className="glass-dark rounded-2xl shadow-2xl max-w-sm w-full p-6 space-y-4">
                                <h2 className="text-xl font-bold text-white">Delete Technician?</h2>
                                <p className="text-slate-400">This will permanently remove this technician account. Jobs assigned to them will remain but won't have a technician assigned.</p>
                                <div className="flex gap-3 pt-2">
                                    <button 
                                        onClick={() => { setShowDeleteConfirm(false); setDeletingTechId(null); }}
                                        className="flex-1 bg-slate-700/50 hover:bg-slate-600/50 text-slate-300 px-4 py-3 rounded-lg font-semibold text-sm"
                                    >
                                        Cancel
                                    </button>
                                    <button 
                                        onClick={deleteTechnician}
                                        className="flex-1 bg-red-600 hover:bg-red-700 text-white px-4 py-3 rounded-lg font-semibold text-sm shadow-lg shadow-red-500/20"
                                    >
                                        Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // TECHNICIAN LOGIN - PIN Entry
        const TechLogin = ({ onLogin }) => {
            const [pin, setPin] = useState("");
            const inputRef = useRef(null);
            
            const handleNum = (n) => { if(pin.length < 4) setPin(p => p+n); };
            const check = async () => {
                const res = await callDB('db-query', { sql: "SELECT * FROM users WHERE pin = ? AND role = 'technician'", params: [pin] });
                if (res.success && res.data.length > 0) onLogin(res.data[0]);
                else { alert("Invalid PIN"); setPin(""); }
            };
            
            // Handle keyboard input
            const handleKeyDown = (e) => {
                if (e.key >= '0' && e.key <= '9' && pin.length < 4) {
                    setPin(p => p + e.key);
                } else if (e.key === 'Backspace') {
                    setPin(p => p.slice(0, -1));
                } else if (e.key === 'Enter' && pin.length === 4) {
                    check();
                } else if (e.key === 'Escape') {
                    setPin('');
                }
            };
            
            // Focus on mount and keep focus
            useEffect(() => {
                inputRef.current?.focus();
            }, []);
            
            // Auto-submit when 4 digits entered
            useEffect(() => {
                if (pin.length === 4) {
                    check();
                }
            }, [pin]);
            
            return (
                <div 
                    className="min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 flex flex-col items-center justify-center text-white p-4 sm:p-6"
                    onClick={() => inputRef.current?.focus()}
                >
                    {/* Hidden input for keyboard capture */}
                    <input 
                        ref={inputRef}
                        type="text"
                        inputMode="numeric"
                        className="opacity-0 absolute w-0 h-0"
                        onKeyDown={handleKeyDown}
                        autoFocus
                    />
                    
                    <h1 className="text-xl sm:text-3xl font-black mb-8 sm:mb-12 tracking-widest text-indigo-400 text-center">TECHNICIAN ACCESS</h1>
                    <p className="text-slate-500 text-xs sm:text-sm mb-6 text-center">Enter your 4-digit PIN</p>
                    
                    <div className="flex gap-2 sm:gap-4 mb-10 sm:mb-16">
                        {[0,1,2,3].map(i => (
                            <div key={i} className={`w-12 h-14 sm:w-16 sm:h-20 rounded-lg border-2 flex items-center justify-center text-2xl sm:text-4xl font-black transition-all ${pin[i] ? 'border-indigo-500 bg-indigo-600/20 text-indigo-400 scale-105' : 'border-slate-700 text-slate-700'}`}>
                                {pin[i] ? '‚Ä¢' : ''}
                            </div>
                        ))}
                    </div>
                    
                    <div className="grid grid-cols-3 gap-2 sm:gap-4 w-full max-w-xs sm:max-w-sm">
                        {[1,2,3,4,5,6,7,8,9].map(n => (
                            <button key={n} onClick={()=>handleNum(n)} className="w-full aspect-square bg-slate-800/50 hover:bg-slate-700/50 rounded-xl text-xl sm:text-3xl font-black border border-slate-700/50 active:scale-90 active:bg-indigo-600 transition-all">
                                {n}
                            </button>
                        ))}
                        <button onClick={()=>setPin(p => p.slice(0, -1))} className="w-full aspect-square bg-slate-800/30 hover:bg-slate-700/50 rounded-xl text-lg sm:text-xl font-bold border border-slate-700/50 active:scale-90 transition-all text-slate-400">‚å´</button>
                        <button onClick={()=>handleNum(0)} className="w-full aspect-square bg-slate-800/50 hover:bg-slate-700/50 rounded-xl text-xl sm:text-3xl font-black border border-slate-700/50 active:scale-90 transition-all">0</button>
                        <button onClick={()=>setPin("")} className="w-full aspect-square bg-red-600/20 hover:bg-red-600/30 rounded-xl text-xs sm:text-sm font-bold border border-red-500/30 active:scale-90 transition-all text-red-400">Clear</button>
                    </div>
                    
                    <p className="text-slate-600 text-xs mt-8 text-center">Tap numbers or use keyboard</p>
                </div>
            );
        };

        // TECHNICIAN DASHBOARD
        const TechDash = ({ user, onLogout }) => {
            const [jobs, setJobs] = useState([]);
            const [selected, setSelected] = useState(null);

            const load = async () => {
                const res = await callDB('get-tech-jobs', { technicianId: user.user_id });
                if (res.success) setJobs(res.data);
            };

            useEffect(() => { load(); }, []);

            if (selected) return <TechChecklist jobId={selected} onBack={() => { setSelected(null); load(); }} />;

            return (
                <div className="min-h-screen bg-gradient-to-br from-slate-950 via-slate-900/50 to-slate-950 p-4 sm:p-6 animate-in fade-in duration-500">
                    <header className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6 sm:mb-10">
                        <div>
                            <h1 className="text-xl sm:text-2xl font-bold text-white">Hello, {user.full_name.split(' ')[0]}! üëã</h1>
                            <p className="text-slate-400 text-xs uppercase tracking-wide mt-1">Your assigned jobs</p>
                        </div>
                        <button onClick={onLogout} className="bg-slate-800/50 hover:bg-slate-700/50 text-slate-300 px-4 py-2 rounded-lg font-semibold text-xs border border-slate-700/50 transition-colors">Exit</button>
                    </header>
                    <div className="space-y-3">
                        {jobs.map(j => (
                            <button key={j.job_id} onClick={() => setSelected(j.job_id)} className="w-full bg-slate-800/30 hover:bg-slate-700/30 p-4 sm:p-6 rounded-xl border border-slate-700/50 flex flex-col sm:flex-row justify-between sm:items-center gap-3 active:scale-[0.98] transition-all group text-left">
                                <div>
                                    <p className="text-lg sm:text-xl font-bold text-white group-hover:text-indigo-400 transition-colors">{j.license_plate}</p>
                                    <p className="text-slate-400 text-sm">{j.make_model}</p>
                                </div>
                                <div className="flex sm:flex-col items-center sm:items-end gap-2 sm:gap-0">
                                    <span className="bg-indigo-600/30 text-indigo-300 px-3 py-1.5 sm:px-4 sm:py-2 rounded-lg font-semibold text-xs uppercase">{j.status}</span>
                                    <p className="text-xs text-slate-500 sm:mt-2">JOB #{j.job_id}</p>
                                </div>
                            </button>
                        ))}
                        {jobs.length === 0 && (
                            <div className="text-center py-12">
                                <p className="text-slate-400 text-lg mb-2">No jobs assigned yet</p>
                                <p className="text-slate-600 text-sm">Jobs will appear here when assigned to you</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // TECHNICIAN CHECKLIST - Task Completion
        const TechChecklist = ({ jobId, onBack }) => {
            const [tasks, setTasks] = useState([]);
            const [jobInfo, setJobInfo] = useState(null);

            const load = async () => {
                const jRes = await callDB('db-query', { sql: "SELECT v.license_plate, v.make_model FROM jobs j JOIN vehicles v ON j.vehicle_id = v.vehicle_id WHERE j.job_id = ?", params: [jobId] });
                const tRes = await callDB('db-query', { sql: "SELECT * FROM job_tasks WHERE job_id = ?", params: [jobId] });
                setJobInfo(jRes.data[0]);
                setTasks(tRes.data || []);
            };

            useEffect(() => { load(); }, [jobId]);

            const toggle = async (id, current) => {
                await callDB('db-run', { sql: "UPDATE job_tasks SET is_completed = ? WHERE task_id = ?", params: [!current, id] });
                load();
            };

            const completedCount = tasks.filter(t => t.is_completed).length;
            const progress = tasks.length > 0 ? (completedCount / tasks.length) * 100 : 0;

            return (
                <div className="min-h-screen bg-gradient-to-br from-slate-950 via-slate-900/50 to-slate-950 p-4 sm:p-8 text-white animate-in slide-in-from-bottom duration-500">
                    <div className="flex flex-col sm:flex-row justify-between items-start gap-4 mb-6 sm:mb-10">
                        <button onClick={onBack} className="text-slate-400 hover:text-slate-200 font-bold text-sm uppercase transition-colors order-2 sm:order-1">‚Üê Back</button>
                        <div className="text-left sm:text-right order-1 sm:order-2">
                            <h2 className="text-2xl sm:text-3xl font-bold text-indigo-400 tracking-tight">{jobInfo?.license_plate}</h2>
                            <p className="text-slate-500 text-sm">{jobInfo?.make_model}</p>
                        </div>
                    </div>

                    {/* Progress bar */}
                    <div className="mb-6 sm:mb-8">
                        <div className="flex justify-between items-center mb-2">
                            <h3 className="text-xs font-bold text-slate-500 uppercase tracking-[.2em]">Service Checklist</h3>
                            <span className="text-xs font-semibold text-slate-400">{completedCount}/{tasks.length} completed</span>
                        </div>
                        <div className="h-2 bg-slate-800 rounded-full overflow-hidden">
                            <div className="h-full bg-gradient-to-r from-indigo-600 to-emerald-500 transition-all duration-500" style={{width: `${progress}%`}}></div>
                        </div>
                    </div>

                    <div className="space-y-2 sm:space-y-3">
                        {tasks.map(t => (
                            <div 
                                key={t.task_id} 
                                onClick={() => toggle(t.task_id, t.is_completed)} 
                                className={`p-4 sm:p-6 rounded-xl flex items-center gap-4 border-2 transition-all active:scale-[.98] cursor-pointer ${t.is_completed ? 'bg-emerald-600/10 border-emerald-500/50 shadow-lg shadow-emerald-500/5' : 'bg-slate-800/30 border-slate-700/50 hover:border-indigo-500/50'}`}
                            >
                                <div className={`w-10 h-10 sm:w-12 sm:h-12 rounded-full border-2 flex items-center justify-center flex-shrink-0 transition-all ${t.is_completed ? 'bg-emerald-600 border-emerald-500 scale-110' : 'border-slate-600'}`}>
                                    {t.is_completed && <span className="text-white text-base sm:text-lg font-black">‚úì</span>}
                                </div>
                                <span className={`font-semibold text-base sm:text-lg flex-1 ${t.is_completed ? 'text-emerald-300' : 'text-slate-200'}`}>{t.description}</span>
                                {t.is_completed && <span className="text-xs font-semibold text-emerald-400 bg-emerald-600/20 px-2 py-1 rounded hidden sm:block">Done</span>}
                            </div>
                        ))}
                        {tasks.length === 0 && (
                            <div className="text-center py-16">
                                <p className="text-slate-500 text-lg">No tasks assigned</p>
                                <p className="text-slate-600 text-sm mt-2">Tasks will appear here when added to this job</p>
                            </div>
                        )}
                    </div>

                    {tasks.length > 0 && (
                        <div className="mt-10 sm:mt-16 p-4 sm:p-6 bg-slate-800/20 rounded-xl border border-slate-700/50 text-center">
                            {progress === 100 ? (
                                <>
                                    <p className="text-emerald-400 font-bold text-lg mb-2">üéâ All tasks completed!</p>
                                    <p className="text-xs text-slate-400 font-semibold">Great job! The vehicle is ready for inspection.</p>
                                </>
                            ) : (
                                <p className="text-xs text-slate-400 font-semibold">Complete all items before requesting inspection.</p>
                            )}
                            <button onClick={onBack} className="mt-4 bg-slate-900 hover:bg-slate-800 px-6 sm:px-8 py-3 rounded-lg text-xs font-bold uppercase tracking-wide text-slate-400 hover:text-slate-300 transition-colors">Back to Jobs</button>
                        </div>
                    )}
                </div>
            );
        };

        // TECH-ONLY MODE (for web browser access)
        const TechModeApp = () => {
            const [user, setUser] = useState(null);
            
            if (!user) return <TechLogin onLogin={setUser} />;
            return <TechDash user={user} onLogout={() => setUser(null)} />;
        };

        // ROOT RENDER - Show full app in Electron, tech-only mode in browser
        const root = ReactDOM.createRoot(document.getElementById('root'));
        const isBrowser = !ipcRenderer;
        root.render(isBrowser ? <TechModeApp /> : <App />);
    </script>
</body>
</html>
